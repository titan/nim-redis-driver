#+TITLE: The Driver For Redis Written by Nim Language
#+AUTHOR: Titan
#+EMAIL: howay.tan@gmail.com
#+DATE: <2019-02-13 Wed>
#+KEYWORDS: nim redis driver
#+OPTIONS: H:4 toc:t
#+STARTUP: indent
#+SUBTITLE:
#+titlepage: true
#+titlepage-color: 06386e
#+titlepage-text-color: FFFFFF
#+titlepage-rule-color: FFFFFF
#+titlepage-rule-height: 1

* 基本框架
#+begin_src nim :tangle ${BUILDDIR}/redis.nim
  import asyncdispatch, asyncnet, deques, net, options, sequtils, strutils
  import redis/lexer
  import redis/syntax

  <<type>>

  <<utilities>>

  <<lexer-action>>

  <<syntax-action>>

  <<interface>>
#+end_src
* 类型定义
#+begin_src nim :noweb-ref type
  type
    <<interface-type>>

    <<data-type>>

    <<lexer-context>>

    <<syntax-context>>
#+end_src
** 接口类型
#+begin_src nim :noweb-ref interface-type
  RedisBase[TSocket] = ref object of RootObj
    socket: TSocket
    connected: bool
    timeout*: int

  Redis* = ref object of RedisBase[net.Socket]
    pipeline*: seq[RedisValue]

  AsyncRedis* = ref object of RedisBase[asyncnet.AsyncSocket]
    pipeline*: seq[RedisValue]
#+end_src
** 数据类型
#+begin_src nim :noweb-ref data-type
  RedisKind* = enum
    rkString, rkError, rkInteger, rkBulkString, rkArray

  RedisValue* = ref object
    case kind*: RedisKind
    of rkString: str*: string
    of rkError: err*: string
    of rkInteger: val*: int
    of rkBulkString: bulkstr*: Option[string]
    of rkArray: array*: Option[seq[RedisValue]]
#+end_src

* 协议解析
** BNF 定义
#+begin_src text
  RedisValue = RedisString
             | RedisError
             | RedisInt
             | RedisBulkString
             | RedisEmptyBulkString
             | RedisNullBulkString
             | RedisArray
             | RedisNullArray

  RedisString = '+' string '\r\n'

  RedisError = '-' string '\r\n'

  RedisInt = ':' number '\r\n'

  RedisBulkString = '$' number '\r\n' string '\r\n'

  RedisEmptyBulkString = '$' '0' '\r\n' '\r\n'

  RedisNullBulkString = '$' '-1' '\r\n'

  RedisArray = '*' number '\r\n' RedisArrayItems
             | '*' ' 0' '\r\n'

  RedisNullArray = '*' '-1' '\r\n'

  RedisArrayItems = RedisArrayItems RedisString
                  | RedisArrayItems RedisError
                  | RedisArrayItems RedisInt
                  | RedisArrayItems RedisBulkString
                  | RedisArrayItems RedisEmptyBulkString
                  | RedisArrayItems RedisNullBulkString
                  | RedisArrayItems RedisArray
                  | RedisArrayItems RedisNullArray
                  | RedisString
                  | RedisError
                  | RedisInt
                  | RedisBulkString
                  | RedisEmptyBulkString
                  | RedisNullBulkString
                  | RedisArray
                  | RedisNullArray
#+end_src
** 词法解析状态机
*** 定义
#+begin_src text :tangle ${BUILDDIR}/lexer.txt
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-------------------+-----------------------+--------------------+----------------------------+---------------+
  | state\event           | +                     | -                     | :                     | $                     | *                     | number              | other                 | cr                | cr and strlen = len   | lf                 | lf and strlen = negative 1 | eof           |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-------------------+-----------------------+--------------------+----------------------------+---------------+
  |                       | output plus           |                       | output colon          | output dollar         | output asterisk       | add to number       | add to string         |                   |                       |                    |                            |               |
  |                       | ----                  | ----                  | ----                  | ----                  | ----                  | ----                | ----                  |                   |                       |                    |                            |               |
  | INIT                  | +                     | -                     |                       | $                     |                       | NUMBER              | STRING                |                   |                       |                    |                            |               |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-------------------+-----------------------+--------------------+----------------------------+---------------+
  |                       | output minus          |                       | output minus          | output minus          | output minus          | add minus to number |                       |                   |                       |                    |                            |               |
  |                       | output plus           | output minus          | output colon          | output dollar         | output asterisk       | add to number       | add to string         | output minus      | output minus          |                    |                            |               |
  |                       | ----                  | ----                  | ----                  | ----                  | ----                  | ----                | ----                  | ----              | ----                  |                    |                            |               |
  | -                     | INIT                  |                       | INIT                  | INIT                  | INIT                  | NUMBER              | - STRING              | CR                | CR                    |                    |                            |               |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-------------------+-----------------------+--------------------+----------------------------+---------------+
  |                       | move number to string | move number to string | move number to string | move number to string | move number to string |                     | move number to string |                   |                       |                    |                            |               |
  |                       | add to string         | add to string         | add to string         | add to string         | add to string         | add to number       | add to string         | output number     | output number         |                    |                            | output number |
  |                       | ----                  | ----                  | ----                  | ----                  | ----                  | ----                | ----                  | ----              | ----                  |                    |                            | ----          |
  | NUMBER                | STRING                | STRING                | STRING                | STRING                | STRING                |                     | STRING                | CR                | CR                    |                    |                            | INIT          |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-------------------+-----------------------+--------------------+----------------------------+---------------+
  |                       | add to string         | add to string         | add to string         | add to string         | add to string         | add to string       | add to string         | output string     | output string         |                    |                            | output string |
  |                       | ----                  | ----                  | ----                  | ----                  | ----                  | ----                | ----                  | ----              | ----                  |                    |                            | ----          |
  | STRING                |                       |                       |                       |                       |                       |                     |                       | CR                | CR                    |                    |                            | INIT          |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-------------------+-----------------------+--------------------+----------------------------+---------------+
  |                       |                       |                       |                       |                       |                       |                     |                       |                   |                       | output crlf        | output crlf                | output crlf   |
  |                       |                       |                       |                       |                       |                       |                     |                       |                   |                       | ----               | ----                       | ----          |
  | CR                    |                       |                       |                       |                       |                       |                     |                       |                   |                       | INIT               | INIT                       | INIT          |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-------------------+-----------------------+--------------------+----------------------------+---------------+
  |                       |                       |                       |                       |                       |                       | add to string       | add to string         |                   |                       |                    |                            |               |
  |                       |                       |                       |                       |                       |                       | ----                | ----                  |                   |                       |                    |                            |               |
  | +                     |                       |                       |                       |                       |                       | + STRING            | + STRING              |                   |                       |                    |                            |               |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-------------------+-----------------------+--------------------+----------------------------+---------------+
  |                       | add to string         | add to string         | add to string         | add to string         | add to string         | add to string       | add to string         | output string     | output string         |                    |                            |               |
  |                       | ----                  | ----                  | ----                  | ----                  | ----                  | ----                | ----                  | ----              | ----                  |                    |                            |               |
  | + STRING              |                       |                       |                       |                       |                       |                     |                       | + STRING CR       | + STRING CR           |                    |                            |               |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-------------------+-----------------------+--------------------+----------------------------+---------------+
  |                       |                       |                       |                       |                       |                       |                     |                       |                   |                       | output crlf        | output crlf                | output crlf   |
  |                       |                       |                       |                       |                       |                       |                     |                       |                   |                       | ----               | ----                       | ----          |
  | + STRING CR           |                       |                       |                       |                       |                       |                     |                       |                   |                       | INIT               | INIT                       | INIT          |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-------------------+-----------------------+--------------------+----------------------------+---------------+
  |                       | add to string         | add to string         | add to string         | add to string         | add to string         | add to string       | add to string         | output string     | output string         |                    |                            |               |
  |                       | ----                  | ----                  | ----                  | ----                  | ----                  | ----                | ----                  | ----              | ----                  |                    |                            |               |
  | - STRING              |                       |                       |                       |                       |                       |                     |                       | - STRING CR       | - STRING CR           |                    |                            |               |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-------------------+-----------------------+--------------------+----------------------------+---------------+
  |                       |                       |                       |                       |                       |                       |                     |                       |                   |                       | output crlf        | output crlf                | output crlf   |
  |                       |                       |                       |                       |                       |                       |                     |                       |                   |                       | ----               | ----                       | ----          |
  | - STRING CR           |                       |                       |                       |                       |                       |                     |                       |                   |                       | INIT               | INIT                       | INIT          |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-------------------+-----------------------+--------------------+----------------------------+---------------+
  |                       |                       | add to number         |                       |                       |                       | add to number       |                       |                   |                       |                    |                            |               |
  |                       |                       | ----                  |                       |                       |                       | ----                |                       |                   |                       |                    |                            |               |
  | $                     |                       | $ NUMBER              |                       |                       |                       | $ NUMBER            |                       |                   |                       |                    |                            |               |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-------------------+-----------------------+--------------------+----------------------------+---------------+
  |                       |                       |                       |                       |                       |                       |                     |                       | set string length | set string length     |                    |                            |               |
  |                       |                       |                       |                       |                       |                       | add to number       |                       | output number     | output number         |                    |                            |               |
  |                       |                       |                       |                       |                       |                       | ----                |                       | ----              | ----                  |                    |                            |               |
  | $ NUMBER              |                       |                       |                       |                       |                       |                     |                       | $ NUMBER CR       | $ NUMBER CR           |                    |                            |               |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-------------------+-----------------------+--------------------+----------------------------+---------------+
  |                       |                       |                       |                       |                       |                       |                     |                       |                   |                       | output crlf        | output crlf                | output crlf   |
  |                       |                       |                       |                       |                       |                       |                     |                       |                   |                       | ----               | ----                       | ----          |
  | $ NUMBER CR           |                       |                       |                       |                       |                       |                     |                       |                   |                       | $ NUMBER CR STRING | INIT                       | INIT          |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-------------------+-----------------------+--------------------+----------------------------+---------------+
  |                       |                       |                       |                       |                       |                       |                     |                       |                   | output string         |                    |                            |               |
  |                       | add to string         | add to string         | add to string         | add to string         | add to string         | add to string       | add to string         | add to string     | clear string length   | add to string      |                            |               |
  |                       | ----                  | ----                  | ----                  | ----                  | ----                  | ----                | ----                  | ----              | ----                  | ----               |                            |               |
  | $ NUMBER CR STRING    |                       |                       |                       |                       |                       |                     |                       |                   | $ NUMBER CR STRING CR |                    |                            |               |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-------------------+-----------------------+--------------------+----------------------------+---------------+
  |                       |                       |                       |                       |                       |                       |                     |                       |                   |                       | output crlf        | output crlf                | output crlf   |
  |                       |                       |                       |                       |                       |                       |                     |                       |                   |                       | ----               | ----                       | ----          |
  | $ NUMBER CR STRING CR |                       |                       |                       |                       |                       |                     |                       |                   |                       | INIT               | INIT                       | INIT          |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-------------------+-----------------------+--------------------+----------------------------+---------------+
#+end_src
*** 数据定义
#+begin_src nim :noweb-ref lexer-context
  LexerContext = ref object
    input: char
    num: string
    str: string
    strlen: int
    sfsm: SyntaxStateMachine[SyntaxContext]
    sctx: SyntaxContext
#+end_src
*** 执行动作
#+begin_src nim :noweb-ref lexer-action
  proc feed_event[T](ctx: var T, sttype: SyntaxTerminalType, val: SyntaxValue) =
    ctx.sctx.input = val
    ctx.sctx.input_type = sttype
    case sttype:
      of stRedisValue: (ctx.sfsm, ctx.sctx) = redisvalue(ctx.sfsm, ctx.sctx)
      of stRedisString: (ctx.sfsm, ctx.sctx) = redisstring(ctx.sfsm, ctx.sctx)
      of stRedisError: (ctx.sfsm, ctx.sctx) = rediserror(ctx.sfsm, ctx.sctx)
      of stRedisInt: (ctx.sfsm, ctx.sctx) = redisint(ctx.sfsm, ctx.sctx)
      of stRedisNullBulkString: (ctx.sfsm, ctx.sctx) = redisnullbulkstring(ctx.sfsm, ctx.sctx)
      of stRedisEmptyBulkString: (ctx.sfsm, ctx.sctx) = redisemptybulkstring(ctx.sfsm, ctx.sctx)
      of stRedisBulkString: (ctx.sfsm, ctx.sctx) = redisbulkstring(ctx.sfsm, ctx.sctx)
      of stRedisNullArray: (ctx.sfsm, ctx.sctx) = redisnullarray(ctx.sfsm, ctx.sctx)
      of stRedisArray: (ctx.sfsm, ctx.sctx) = redisarray(ctx.sfsm, ctx.sctx)
      of stPlus: (ctx.sfsm, ctx.sctx) = plus(ctx.sfsm, ctx.sctx)
      of stString: (ctx.sfsm, ctx.sctx) = my_string(ctx.sfsm, ctx.sctx)
      of stCrLf: (ctx.sfsm, ctx.sctx) = backslash_r_backslash_n(ctx.sfsm, ctx.sctx)
      of stMinus: (ctx.sfsm, ctx.sctx) = minus(ctx.sfsm, ctx.sctx)
      of stColon: (ctx.sfsm, ctx.sctx) = colon(ctx.sfsm, ctx.sctx)
      of stNumber: (ctx.sfsm, ctx.sctx) = number(ctx.sfsm, ctx.sctx)
      of stDollar: (ctx.sfsm, ctx.sctx) = dollar(ctx.sfsm, ctx.sctx)
      of stZero: (ctx.sfsm, ctx.sctx) = number_0(ctx.sfsm, ctx.sctx)
      of stNegative1: (ctx.sfsm, ctx.sctx) = minus1(ctx.sfsm, ctx.sctx)
      of stAsterisk: (ctx.sfsm, ctx.sctx) = asterisk(ctx.sfsm, ctx.sctx)
      of stRedisArrayItems:
        if len(ctx.sctx.arrlen) > 0:
          if len(val.items) == ctx.sctx.arrlen[len(ctx.sctx.arrlen) - 1]:
            (ctx.sfsm, ctx.sctx) = redisarrayitems_where_len_equals_number(ctx.sfsm, ctx.sctx)
          else:
            (ctx.sfsm, ctx.sctx) = redisarrayitems_but_len_less_than_number(ctx.sfsm, ctx.sctx)
    ctx.sctx.fsm = ctx.sfsm

  proc consume_queue[T](ctx: var T) =
    while len(ctx.sctx.queue) > 0:
      var (sttype, item) = ctx.sctx.queue.popFirst()
      feed_event(ctx, sttype, item)

  proc output_plus[T](ctx: T): T =
    var ctx0 = ctx
    consume_queue(ctx0)
    ctx0.sctx.input_type = stPlus
    ctx0.sctx.input = SyntaxValue(kind: skString, str: "+")
    (ctx0.sfsm, ctx0.sctx) = plus(ctx0.sfsm, ctx0.sctx)
    ctx0.sctx.fsm = ctx0.sfsm
    consume_queue(ctx0)
    result = ctx0

  proc output_colon[T](ctx: T): T =
    var ctx0 = ctx
    consume_queue(ctx0)
    ctx0.sctx.input_type = stColon
    ctx0.sctx.input = SyntaxValue(kind: skString, str: ":")
    (ctx0.sfsm, ctx0.sctx) = colon(ctx0.sfsm, ctx0.sctx)
    ctx0.sctx.fsm = ctx0.sfsm
    consume_queue(ctx0)
    result = ctx0

  proc output_dollar[T](ctx: T): T =
    var ctx0 = ctx
    consume_queue(ctx0)
    ctx0.sctx.input_type = stDollar
    ctx0.sctx.input = SyntaxValue(kind: skString, str: "$")
    (ctx0.sfsm, ctx0.sctx) = dollar(ctx0.sfsm, ctx0.sctx)
    ctx0.sctx.fsm = ctx0.sfsm
    consume_queue(ctx0)
    result = ctx0

  proc output_asterisk[T](ctx: T): T =
    var ctx0 = ctx
    consume_queue(ctx0)
    ctx0.sctx.input_type = stAsterisk
    ctx0.sctx.input = SyntaxValue(kind: skString, str: "*")
    (ctx0.sfsm, ctx0.sctx) = asterisk(ctx0.sfsm, ctx0.sctx)
    ctx0.sctx.fsm = ctx0.sfsm
    consume_queue(ctx0)
    result = ctx0

  proc add_to_number[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.num.add(ctx.input)
    result = ctx0

  proc add_to_string[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.str.add(ctx.input)
    result = ctx0

  proc output_minus[T](ctx: T): T =
    var ctx0 = ctx
    consume_queue(ctx0)
    ctx0.sctx.input_type = stMinus
    ctx0.sctx.input = SyntaxValue(kind: skString, str: "-")
    (ctx0.sfsm, ctx0.sctx) = minus(ctx0.sfsm, ctx0.sctx)
    ctx0.sctx.fsm = ctx0.sfsm
    consume_queue(ctx0)
    result = ctx0

  proc add_minus_to_number[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.num.add('-')
    result = ctx0

  proc move_number_to_string[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.str = ctx0.num
    ctx0.num = ""
    result = ctx0

  proc output_number[T](ctx: T): T =
    let num = parseInt($ctx.num)
    var ctx0 = ctx
    if num == 0:
      consume_queue(ctx0)
      ctx0.sctx.input_type = stZero
      ctx0.sctx.input = SyntaxValue(kind: skNumber, num: num)
      (ctx0.sfsm, ctx0.sctx) = number_0(ctx0.sfsm, ctx0.sctx)
      ctx0.sctx.fsm = ctx0.sfsm
      ctx0.num = ""
      consume_queue(ctx0)
      result = ctx0
    elif num == -1:
      consume_queue(ctx0)
      ctx0.sctx.input_type = stNegative1
      ctx0.sctx.input = SyntaxValue(kind: skNumber, num: num)
      (ctx0.sfsm, ctx0.sctx) = minus1(ctx0.sfsm, ctx0.sctx)
      ctx0.sctx.fsm = ctx0.sfsm
      ctx0.num = ""
      consume_queue(ctx0)
      result = ctx0
    else:
      consume_queue(ctx0)
      ctx0.sctx.input_type = stNumber
      ctx0.sctx.input = SyntaxValue(kind: skNumber, num: num)
      (ctx0.sfsm, ctx0.sctx) = number(ctx0.sfsm, ctx0.sctx)
      ctx0.sctx.fsm = ctx0.sfsm
      ctx0.num = ""
      consume_queue(ctx0)
      result = ctx0

  proc output_string[T](ctx: T): T =
    var ctx0 = ctx
    consume_queue(ctx0)
    ctx0.sctx.input_type = stString
    ctx0.sctx.input = SyntaxValue(kind: skString, str: $ctx.str)
    (ctx0.sfsm, ctx0.sctx) = my_string(ctx0.sfsm, ctx0.sctx)
    ctx0.sctx.fsm = ctx0.sfsm
    ctx0.str = ""
    consume_queue(ctx0)
    result = ctx0

  proc output_crlf[T](ctx: T): T =
    var ctx0 = ctx
    consume_queue(ctx0)
    ctx0.sctx.input_type = stCrLf
    ctx0.sctx.input = SyntaxValue(kind: skString, str: "\r\n")
    (ctx0.sfsm, ctx0.sctx) = backslash_r_backslash_n(ctx0.sfsm, ctx0.sctx)
    ctx0.sctx.fsm = ctx0.sfsm
    consume_queue(ctx0)
    result = ctx0

  proc set_string_length[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.strlen = parseInt(ctx0.num)
    result = ctx0

  proc clear_string_length[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.strlen = 0
    result = ctx0
#+end_src
** 语法解析状态机
*** 定义
#+begin_src text :tangle ${BUILDDIR}/syntax.txt
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------+--------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+--------------------------------------------------+----------------------------------------------------------+-----------------------------------+
  | state\event                                              | RedisValue         | RedisString                 | RedisError                  | RedisInt                    | RedisBulkString             | RedisEmptyBulkString        | RedisNullBulkString         | RedisArray                  | RedisNullArray              | "+"                               | string                                              | "\r\n"                                                   | "-"                              | ":"                            | number                                              | "$"                                                 | "0"                                                 | "-1"                                                | "*"                                              | RedisArrayItems but len < number                         | RedisArrayItemswhere len = number |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------+--------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+--------------------------------------------------+----------------------------------------------------------+-----------------------------------+
  | target = · RedisValue                                    |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisValue = · RedisString                               |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisString = · "+" string "\r\n"                        |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisValue = · RedisError                                |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisError = · "-" string "\r\n"                         |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisValue = · RedisInt                                  |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisInt = · ":" number "\r\n"                           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisValue = · RedisBulkString                           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisBulkString = · "$" number "\r\n" string "\r\n"      |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisValue = · RedisEmptyBulkString                      |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisEmptyBulkString = · "$" "0" "\r\n" "\r\n"           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisValue = · RedisNullBulkString                       |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisNullBulkString = · "$" "-1" "\r\n"                  |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     | clear done                                          |                                                     |                                                     | clear done                                       |                                                          |                                   |
  | RedisValue = · RedisArray                                | shift              |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     | shift                                               |                                                     |                                                     | shift                                            |                                                          |                                   |
  | RedisArray = · "*" number "\r\n" RedisArrayItems         | reduce 1 to target | shift                       | shift                       | shift                       | shift                       | shift                       | shift                       | shift                       | shift                       | clear done                        |                                                     |                                                          | clear done                       | clear done                     |                                                     | ----                                                |                                                     |                                                     | ----                                             |                                                          |                                   |
  | RedisArray = · "*" "0" "\r\n"                            | set done           | reduce 1 to RedisValue      | reduce 1 to RedisValue      | reduce 1 to RedisValue      | reduce 1 to RedisValue      | reduce 1 to RedisValue      | reduce 1 to RedisValue      | reduce 1 to RedisValue      | reduce 1 to RedisValue      | shift                             | syntax error                                        | syntax error                                             | shift                            | shift                          | syntax error                                        | RedisBulkString = "$" · number "\r\n" string "\r\n" | syntax error                                        | syntax error                                        | RedisArray = "*" · number "\r\n" RedisArrayItems | syntax error                                             | syntax error                      |
  | RedisValue = · RedisNullArray                            | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                              | ----                                                | ----                                                     | ----                             | ----                           | ----                                                | RedisEmptyBulkString = "$" · "0" "\r\n" "\r\n"      | ----                                                | ----                                                | RedisArray = "*" · "0" "\r\n"                    | ----                                                     | ----                              |
  | RedisNullArray = · "*" "-1" "\r\n"                       |                    |                             |                             |                             |                             |                             |                             |                             |                             | RedisString = "+" · string "\r\n" |                                                     |                                                          | RedisError = "-" · string "\r\n" | RedisInt = ":" · number "\r\n" |                                                     | RedisNullBulkString = "$" · "-1" "\r\n"             |                                                     |                                                     | RedisNullArray = "*" · "-1" "\r\n"               |                                                          |                                   |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------+--------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+--------------------------------------------------+----------------------------------------------------------+-----------------------------------+
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                | convert to string                                   |                                                     | convert to string                                   | convert to string                                   |                                                  |                                                          |                                   |
  |                                                          | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                      | shift                                               | syntax error                                             | syntax error                     | syntax error                   | shift                                               | syntax error                                        | shift                                               | shift                                               | syntax error                                     | syntax error                                             | syntax error                      |
  |                                                          | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                              | ----                                                | ----                                                     | ----                             | ----                           | ----                                                | ----                                                | ----                                                | ----                                                | ----                                             | ----                                                     | ----                              |
  | RedisString = "+" · string "\r\n"                        |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   | RedisString = "+" string · "\r\n"                   |                                                          |                                  |                                | RedisString = "+" string · "\r\n"                   |                                                     | RedisString = "+" string · "\r\n"                   | RedisString = "+" string · "\r\n"                   |                                                  |                                                          |                                   |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------+--------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+--------------------------------------------------+----------------------------------------------------------+-----------------------------------+
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | shift                                                    |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                      | syntax error                                        | reduce 3 to RedisString                                  | syntax error                     | syntax error                   | syntax error                                        | syntax error                                        | syntax error                                        | syntax error                                        | syntax error                                     | syntax error                                             | syntax error                      |
  |                                                          | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                              | ----                                                | ----                                                     | ----                             | ----                           | ----                                                | ----                                                | ----                                                | ----                                                | ----                                             | ----                                                     | ----                              |
  | RedisString = "+" string · "\r\n"                        |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------+--------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+--------------------------------------------------+----------------------------------------------------------+-----------------------------------+
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                | convert to string                                   |                                                     | convert to string                                   | convert to string                                   |                                                  |                                                          |                                   |
  |                                                          | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                      | shift                                               | syntax error                                             | syntax error                     | syntax error                   | shift                                               | syntax error                                        | shift                                               | shift                                               | syntax error                                     | syntax error                                             | syntax error                      |
  |                                                          | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                              | ----                                                | ----                                                     | ----                             | ----                           | ----                                                | ----                                                | ----                                                | ----                                                | ----                                             | ----                                                     | ----                              |
  | RedisError = "-" · string "\r\n"                         |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   | RedisError = "-" string · "\r\n"                    |                                                          |                                  |                                | RedisError = "-" string · "\r\n"                    |                                                     | RedisError = "-" string · "\r\n"                    | RedisError = "-" string · "\r\n"                    |                                                  |                                                          |                                   |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------+--------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+--------------------------------------------------+----------------------------------------------------------+-----------------------------------+
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | shift                                                    |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                      | syntax error                                        | reduce 3 to RedisError                                   | syntax error                     | syntax error                   | syntax error                                        | syntax error                                        | syntax error                                        | syntax error                                        | syntax error                                     | syntax error                                             | syntax error                      |
  |                                                          | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                              | ----                                                | ----                                                     | ----                             | ----                           | ----                                                | ----                                                | ----                                                | ----                                                | ----                                             | ----                                                     | ----                              |
  | RedisError = "-" string · "\r\n"                         |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------+--------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+--------------------------------------------------+----------------------------------------------------------+-----------------------------------+
  |                                                          | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                      | syntax error                                        | syntax error                                             | syntax error                     | syntax error                   | shift                                               | syntax error                                        | syntax error                                        | syntax error                                        | syntax error                                     | syntax error                                             | syntax error                      |
  |                                                          | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                              | ----                                                | ----                                                     | ----                             | ----                           | ----                                                | ----                                                | ----                                                | ----                                                | ----                                             | ----                                                     | ----                              |
  | RedisInt = ":" · number "\r\n"                           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                | RedisInt = ":" number · "\r\n"                      |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------+--------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+--------------------------------------------------+----------------------------------------------------------+-----------------------------------+
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | shift                                                    |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                      | syntax error                                        | reduce 3 to RedisInt                                     | syntax error                     | syntax error                   | syntax error                                        | syntax error                                        | syntax error                                        | syntax error                                        | syntax error                                     | syntax error                                             | syntax error                      |
  |                                                          | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                              | ----                                                | ----                                                     | ----                             | ----                           | ----                                                | ----                                                | ----                                                | ----                                                | ----                                             | ----                                                     | ----                              |
  | RedisInt = ":" number · "\r\n"                           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------+--------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+--------------------------------------------------+----------------------------------------------------------+-----------------------------------+
  | RedisBulkString = "$" · number "\r\n" string "\r\n"      | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                      | syntax error                                        | syntax error                                             | syntax error                     | syntax error                   | shift                                               | syntax error                                        | shift                                               | shift                                               | syntax error                                     | syntax error                                             | syntax error                      |
  | RedisEmptyBulkString = "$" · "0" "\r\n" "\r\n"           | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                              | ----                                                | ----                                                     | ----                             | ----                           | ----                                                | ----                                                | ----                                                | ----                                                | ----                                             | ----                                                     | ----                              |
  | RedisNullBulkString = "$" · "-1" "\r\n"                  |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                | RedisBulkString = "$" number · "\r\n" string "\r\n" |                                                     | RedisEmptyBulkString = "$" "0" · "\r\n" "\r\n"      | RedisNullBulkString = "$" "-1" · "\r\n"             |                                                  |                                                          |                                   |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------+--------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+--------------------------------------------------+----------------------------------------------------------+-----------------------------------+
  |                                                          | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                      | syntax error                                        | shift                                                    | syntax error                     | syntax error                   | syntax error                                        | syntax error                                        | syntax error                                        | syntax error                                        | syntax error                                     | syntax error                                             | syntax error                      |
  |                                                          | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                              | ----                                                | ----                                                     | ----                             | ----                           | ----                                                | ----                                                | ----                                                | ----                                                | ----                                             | ----                                                     | ----                              |
  | RedisBulkString = "$" number · "\r\n" string "\r\n"      |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | RedisBulkString = "$" number "\r\n" · string "\r\n"      |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------+--------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+--------------------------------------------------+----------------------------------------------------------+-----------------------------------+
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                | convert to string                                   |                                                     | convert to string                                   | convert to string                                   |                                                  |                                                          |                                   |
  |                                                          | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                      | shift                                               | syntax error                                             | syntax error                     | syntax error                   | shift                                               | syntax error                                        | shift                                               | shift                                               | syntax error                                     | syntax error                                             | syntax error                      |
  |                                                          | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                              | ----                                                | ----                                                     | ----                             | ----                           | ----                                                | ----                                                | ----                                                | ----                                                | ----                                             | ----                                                     | ----                              |
  | RedisBulkString = "$" number "\r\n" · string "\r\n"      |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   | RedisBulkString = "$" number "\r\n" string · "\r\n" |                                                          |                                  |                                | RedisBulkString = "$" number "\r\n" string · "\r\n" |                                                     | RedisBulkString = "$" number "\r\n" string · "\r\n" | RedisBulkString = "$" number "\r\n" string · "\r\n" |                                                  |                                                          |                                   |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------+--------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+--------------------------------------------------+----------------------------------------------------------+-----------------------------------+
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | shift                                                    |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                      | syntax error                                        | reduce 5 to RedisBulkString                              | syntax error                     | syntax error                   | syntax error                                        | syntax error                                        | syntax error                                        | syntax error                                        | syntax error                                     | syntax error                                             | syntax error                      |
  |                                                          | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                              | ----                                                | ----                                                     | ----                             | ----                           | ----                                                | ----                                                | ----                                                | ----                                                | ----                                             | ----                                                     | ----                              |
  | RedisBulkString = "$" number "\r\n" string · "\r\n"      |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------+--------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+--------------------------------------------------+----------------------------------------------------------+-----------------------------------+
  |                                                          | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                      | syntax error                                        | shift                                                    | syntax error                     | syntax error                   | syntax error                                        | syntax error                                        | syntax error                                        | syntax error                                        | syntax error                                     | syntax error                                             | syntax error                      |
  |                                                          | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                              | ----                                                | ----                                                     | ----                             | ----                           | ----                                                | ----                                                | ----                                                | ----                                                | ----                                             | ----                                                     | ----                              |
  | RedisEmptyBulkString = "$" "0" · "\r\n" "\r\n"           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | RedisEmptyBulkString = "$" "0" "\r\n" · "\r\n"           |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------+--------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+--------------------------------------------------+----------------------------------------------------------+-----------------------------------+
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | shift                                                    |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                      | syntax error                                        | reduce 4 to RedisEmptyBulkString                         | syntax error                     | syntax error                   | syntax error                                        | syntax error                                        | syntax error                                        | syntax error                                        | syntax error                                     | syntax error                                             | syntax error                      |
  |                                                          | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                              | ----                                                | ----                                                     | ----                             | ----                           | ----                                                | ----                                                | ----                                                | ----                                                | ----                                             | ----                                                     | ----                              |
  | RedisEmptyBulkString = "$" "0" "\r\n" · "\r\n"           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------+--------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+--------------------------------------------------+----------------------------------------------------------+-----------------------------------+
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | shift                                                    |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                      | syntax error                                        | reduce 3 to RedisNullBulkString                          | syntax error                     | syntax error                   | syntax error                                        | syntax error                                        | syntax error                                        | syntax error                                        | syntax error                                     | syntax error                                             | syntax error                      |
  |                                                          | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                              | ----                                                | ----                                                     | ----                             | ----                           | ----                                                | ----                                                | ----                                                | ----                                                | ----                                             | ----                                                     | ----                              |
  | RedisNullBulkString = "$" "-1" · "\r\n"                  |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------+--------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+--------------------------------------------------+----------------------------------------------------------+-----------------------------------+
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                | shift                                               |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisArray = "*" · number "\r\n" RedisArrayItems         | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                      | syntax error                                        | syntax error                                             | syntax error                     | syntax error                   | push array length                                   | syntax error                                        | shift                                               | shift                                               | syntax error                                     | syntax error                                             | syntax error                      |
  | RedisArray = "*" · "0" "\r\n"                            | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                              | ----                                                | ----                                                     | ----                             | ----                           | ----                                                | ----                                                | ----                                                | ----                                                | ----                                             | ----                                                     | ----                              |
  | RedisNullArray = "*" · "-1" "\r\n"                       |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                | RedisArray = "*" number · "\r\n" RedisArrayItems    |                                                     | RedisArray = "*" "0" · "\r\n"                       | RedisNullArray = "*" "-1" · "\r\n"                  |                                                  |                                                          |                                   |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------+--------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+--------------------------------------------------+----------------------------------------------------------+-----------------------------------+
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | shift                                                    |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | ----                                                     |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | RedisArray = "*" number "\r\n" · RedisArrayItems         |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | RedisArrayItems = · RedisArrayItems RedisString          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | RedisArrayItems = · RedisArrayItems RedisError           |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | RedisArrayItems = · RedisArrayItems RedisInt             |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | RedisArrayItems = · RedisArrayItems RedisBulkString      |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | RedisArrayItems = · RedisArrayItems RedisEmptyBulkString |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | RedisArrayItems = · RedisArrayItems RedisNullBulkString  |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | RedisArrayItems = · RedisArrayItems RedisArray           |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | RedisArrayItems = · RedisArrayItems RedisNullArray       |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | RedisArrayItems = · RedisString                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | RedisString = · "+" string "\r\n"                        |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | RedisArrayItems = · RedisError                           |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | RedisError = · "-" string "\r\n"                         |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | RedisArrayItems = · RedisInt                             |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | RedisInt = · ":" number "\r\n"                           |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | RedisArrayItems = · RedisBulkString                      |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | RedisBulkString = · "$" number "\r\n" string "\r\n"      |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | RedisArrayItems = · RedisEmptyBulkString                 |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | RedisEmptyBulkString = · "$" "0" "\r\n" "\r\n"           |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | RedisArrayItems = · RedisNullBulkString                  |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | RedisNullBulkString = · "$" "-1" "\r\n"                  |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | RedisArrayItems = · RedisArray                           |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | RedisArray = · "*" number "\r\n" RedisArrayItems         |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                      | syntax error                                        | RedisArray = · "*" "0" "\r\n"                            | syntax error                     | syntax error                   | syntax error                                        | syntax error                                        | syntax error                                        | syntax error                                        | syntax error                                     | syntax error                                             | syntax error                      |
  |                                                          | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                              | ----                                                | RedisArrayItems = · RedisNullArray                       | ----                             | ----                           | ----                                                | ----                                                | ----                                                | ----                                                | ----                                             | ----                                                     | ----                              |
  | RedisArray = "*" number · "\r\n" RedisArrayItems         |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | RedisNullArray = · "*" "-1" "\r\n"                       |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------+--------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+--------------------------------------------------+----------------------------------------------------------+-----------------------------------+
  | RedisArray = "*" number "\r\n" · RedisArrayItems         |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisArrayItems = · RedisArrayItems RedisString          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisArrayItems = · RedisArrayItems RedisError           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisArrayItems = · RedisArrayItems RedisInt             |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisArrayItems = · RedisArrayItems RedisBulkString      |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisArrayItems = · RedisArrayItems RedisEmptyBulkString |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisArrayItems = · RedisArrayItems RedisNullBulkString  |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  | shift                                                    |                                   |
  | RedisArrayItems = · RedisArrayItems RedisArray           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  | ----                                                     |                                   |
  | RedisArrayItems = · RedisArrayItems RedisNullArray       |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  | RedisArray = "*" number "\r\n" RedisArrayItems ·         |                                   |
  | RedisArrayItems = · RedisString                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  | RedisArrayItems = RedisArrayItems · RedisString          |                                   |
  | RedisString = · "+" string "\r\n"                        |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  | RedisArrayItems = RedisArrayItems · RedisError           |                                   |
  | RedisArrayItems = · RedisError                           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  | RedisArrayItems = RedisArrayItems · RedisInt             |                                   |
  | RedisError = · "-" string "\r\n"                         |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  | RedisArrayItems = RedisArrayItems · RedisBulkString      |                                   |
  | RedisArrayItems = · RedisInt                             |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  | RedisArrayItems = RedisArrayItems · RedisEmptyBulkString |                                   |
  | RedisInt = · ":" number "\r\n"                           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  | RedisArrayItems = RedisArrayItems · RedisNullBulkString  |                                   |
  | RedisArrayItems = · RedisBulkString                      |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  | RedisArrayItems = RedisArrayItems · RedisArray           |                                   |
  | RedisBulkString = · "$" number "\r\n" string "\r\n"      |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  | RedisArrayItems = RedisArrayItems · RedisNullArray       |                                   |
  | RedisArrayItems = · RedisEmptyBulkString                 |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  | RedisString = · "+" string "\r\n"                        |                                   |
  | RedisEmptyBulkString = · "$" "0" "\r\n" "\r\n"           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  | RedisError = · "-" string "\r\n"                         |                                   |
  | RedisArrayItems = · RedisNullBulkString                  |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  | RedisInt = · ":" number "\r\n"                           |                                   |
  | RedisNullBulkString = · "$" "-1" "\r\n"                  |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  | RedisBulkString = · "$" number "\r\n" string "\r\n"      |                                   |
  | RedisArrayItems = · RedisArray                           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     | shift                                               |                                                     |                                                     | shift                                            | RedisEmptyBulkString = · "$" "0" "\r\n" "\r\n"           | shift                             |
  | RedisArray = · "*" number "\r\n" RedisArrayItems         |                    | shift                       | shift                       | shift                       | shift                       | shift                       | shift                       | shift                       | shift                       |                                   |                                                     |                                                          |                                  |                                |                                                     | ----                                                |                                                     |                                                     | ----                                             | RedisNullBulkString = · "$" "-1" "\r\n"                  | reduce 4 to RedisArray            |
  | RedisArray = · "*" "0" "\r\n"                            | syntax error       | reduce 1 to RedisArrayItems | reduce 1 to RedisArrayItems | reduce 1 to RedisArrayItems | reduce 1 to RedisArrayItems | reduce 1 to RedisArrayItems | reduce 1 to RedisArrayItems | reduce 1 to RedisArrayItems | reduce 1 to RedisArrayItems | shift                             | syntax error                                        | syntax error                                             | shift                            | shift                          | syntax error                                        | RedisBulkString = "$" · number "\r\n" string "\r\n" | syntax error                                        | syntax error                                        | RedisArray = "*" · number "\r\n" RedisArrayItems | RedisArray = · "*" number "\r\n" RedisArrayItems         | pop array length                  |
  | RedisArrayItems = · RedisNullArray                       | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                              | ----                                                | ----                                                     | ----                             | ----                           | ----                                                | RedisEmptyBulkString = "$" · "0" "\r\n" "\r\n"      | ----                                                | ----                                                | RedisArray = "*" · "0" "\r\n"                    | RedisArray = · "*" "0" "\r\n"                            | ----                              |
  | RedisNullArray = · "*" "-1" "\r\n"                       |                    |                             |                             |                             |                             |                             |                             |                             |                             | RedisString = "+" · string "\r\n" |                                                     |                                                          | RedisError = "-" · string "\r\n" | RedisInt = ":" · number "\r\n" |                                                     | RedisNullBulkString = "$" · "-1" "\r\n"             |                                                     |                                                     | RedisNullArray = "*" · "-1" "\r\n"               | RedisNullArray = · "*" "-1" "\r\n"                       |                                   |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------+--------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+--------------------------------------------------+----------------------------------------------------------+-----------------------------------+
  | RedisArray = "*" number "\r\n" RedisArrayItems ·         |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisArrayItems = RedisArrayItems · RedisString          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisArrayItems = RedisArrayItems · RedisError           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisArrayItems = RedisArrayItems · RedisInt             |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisArrayItems = RedisArrayItems · RedisBulkString      |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisArrayItems = RedisArrayItems · RedisEmptyBulkString |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisArrayItems = RedisArrayItems · RedisNullBulkString  |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisArrayItems = RedisArrayItems · RedisArray           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisArrayItems = RedisArrayItems · RedisNullArray       |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisString = · "+" string "\r\n"                        |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisError = · "-" string "\r\n"                         |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisInt = · ":" number "\r\n"                           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisBulkString = · "$" number "\r\n" string "\r\n"      |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  | RedisEmptyBulkString = · "$" "0" "\r\n" "\r\n"           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     | shift                                               |                                                     |                                                     | shift                                            |                                                          |                                   |
  | RedisNullBulkString = · "$" "-1" "\r\n"                  |                    | shift                       | shift                       | shift                       | shift                       | shift                       | shift                       | shift                       | shift                       |                                   |                                                     |                                                          |                                  |                                |                                                     | ----                                                |                                                     |                                                     | ----                                             |                                                          |                                   |
  | RedisArray = · "*" number "\r\n" RedisArrayItems         | syntax error       | reduce 2 to RedisArrayItems | reduce 2 to RedisArrayItems | reduce 2 to RedisArrayItems | reduce 2 to RedisArrayItems | reduce 2 to RedisArrayItems | reduce 2 to RedisArrayItems | reduce 2 to RedisArrayItems | reduce 2 to RedisArrayItems | shift                             | syntax error                                        | syntax error                                             | shift                            | shift                          | syntax error                                        | RedisBulkString = "$" · number "\r\n" string "\r\n" | syntax error                                        | syntax error                                        | RedisArray = "*" · number "\r\n" RedisArrayItems | syntax error                                             | syntax error                      |
  | RedisArray = · "*" "0" "\r\n"                            | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                              | ----                                                | ----                                                     | ----                             | ----                           | ----                                                | RedisEmptyBulkString = "$" · "0" "\r\n" "\r\n"      | ----                                                | ----                                                | RedisArray = "*" · "0" "\r\n"                    | ----                                                     | ----                              |
  | RedisNullArray = · "*" "-1" "\r\n"                       |                    |                             |                             |                             |                             |                             |                             |                             |                             | RedisString = "+" · string "\r\n" |                                                     |                                                          | RedisError = "-" · string "\r\n" | RedisInt = ":" · number "\r\n" |                                                     | RedisNullBulkString = "$" · "-1" "\r\n"             |                                                     |                                                     | RedisNullArray = "*" · "-1" "\r\n"               |                                                          |                                   |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------+--------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+--------------------------------------------------+----------------------------------------------------------+-----------------------------------+
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | shift                                                    |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                      | syntax error                                        | reduce 3 to RedisArray                                   | syntax error                     | syntax error                   | syntax error                                        | syntax error                                        | syntax error                                        | syntax error                                        | syntax error                                     | syntax error                                             | syntax error                      |
  |                                                          | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                              | ----                                                | ----                                                     | ----                             | ----                           | ----                                                | ----                                                | ----                                                | ----                                                | ----                                             | ----                                                     | ----                              |
  | RedisArray = "*" "0" · "\r\n"                            |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------+--------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+--------------------------------------------------+----------------------------------------------------------+-----------------------------------+
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     | shift                                                    |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  |                                                          | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                      | syntax error                                        | reduce 3 to RedisNullArray                               | syntax error                     | syntax error                   | syntax error                                        | syntax error                                        | syntax error                                        | syntax error                                        | syntax error                                     | syntax error                                             | syntax error                      |
  |                                                          | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                              | ----                                                | ----                                                     | ----                             | ----                           | ----                                                | ----                                                | ----                                                | ----                                                | ----                                             | ----                                                     | ----                              |
  | RedisNullArray = "*" "-1" · "\r\n"                       |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                   |                                                     |                                                          |                                  |                                |                                                     |                                                     |                                                     |                                                     |                                                  |                                                          |                                   |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------+--------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+-----------------------------------------------------+--------------------------------------------------+----------------------------------------------------------+-----------------------------------+
#+end_src
*** 数据定义
#+begin_src nim :noweb-ref syntax-context
  SyntaxTerminalType = enum
    stRedisValue, stRedisString, stRedisError, stRedisInt, stRedisNullBulkString, stRedisEmptyBulkString, stRedisBulkString, stRedisNullArray, stRedisArray, stPlus, stString, stCrLf, stMinus, stColon, stNumber, stDollar, stZero, stNegative1, stAsterisk, stRedisArrayItems

  SyntaxKind = enum
    skString, skNumber, skRedisValue, skRedisArrayItems, skEof

  SyntaxValue = ref object
    case kind: SyntaxKind
    of skString: str: string
    of skNumber: num: int
    of skRedisValue: val: RedisValue
    of skRedisArrayItems: items: seq[RedisValue]
    of skEof: eof: int

  SyntaxContext = ref object
    fsm: SyntaxStateMachine[SyntaxContext]
    target: SyntaxValue
    input: SyntaxValue
    input_type: SyntaxTerminalType
    state_stack: seq[int]
    value_stack: seq[(SyntaxTerminalType, SyntaxValue)]
    queue: Deque[(SyntaxTerminalType, SyntaxValue)]
    error: bool
    errmsg: string
    arrlen: seq[int]
    done: bool
#+end_src
*** 执行动作
#+begin_src nim :noweb-ref syntax-action
  proc shift[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.state_stack.add(ctx0.fsm.state)
    ctx0.value_stack.add((ctx0.input_type, ctx0.input))
    return ctx0

  proc reduce_1_to_target[T](ctx: T): T =
    var ctx0 = ctx
    var (_, value) = ctx0.value_stack.pop()
    ctx0.fsm.state = ctx0.state_stack.pop()
    ctx0.target = value
    return ctx0

  proc set_done[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.done = true
    return ctx0

  proc reduce_1_to_redisvalue[T](ctx: T): T =
    var ctx0 = ctx
    var (_, value) = ctx0.value_stack.pop()
    ctx0.fsm.state = ctx0.state_stack.pop()
    ctx0.queue.addLast((stRedisValue, value))
    return ctx0

  proc clear_done[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.done = false
    return ctx0

  proc syntax_error[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.error = true
    ctx0.errmsg = "Syntax Error"
    return ctx0

  proc convert_to_string[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.input = SyntaxValue(kind: skString, str: $ctx0.input.num)
    return ctx0

  proc reduce_3_to_redisstring[T](ctx: T): T =
    var ctx0 = ctx
    discard ctx0.value_stack.pop()
    var (_, sv) = ctx0.value_stack.pop()
    discard ctx0.value_stack.pop()
    discard ctx0.state_stack.pop()
    discard ctx0.state_stack.pop()
    ctx0.fsm.state = ctx0.state_stack.pop()
    ctx0.queue.addLast((stRedisString, SyntaxValue(kind: skRedisValue, val: RedisValue(kind: rkString, str: sv.str))))
    return ctx0

  proc reduce_3_to_rediserror[T](ctx: T): T =
    var ctx0 = ctx
    discard ctx0.value_stack.pop()
    var (_, sv) = ctx0.value_stack.pop()
    discard ctx0.value_stack.pop()
    discard ctx0.state_stack.pop()
    discard ctx0.state_stack.pop()
    ctx0.fsm.state = ctx0.state_stack.pop()
    ctx0.queue.addLast((stRedisError, SyntaxValue(kind: skRedisValue, val: RedisValue(kind: rkError, err: sv.str))))
    return ctx0

  proc reduce_3_to_redisint[T](ctx: T): T =
    var ctx0 = ctx
    discard ctx0.value_stack.pop()
    var (_, sv) = ctx0.value_stack.pop()
    discard ctx0.value_stack.pop()
    discard ctx0.state_stack.pop()
    discard ctx0.state_stack.pop()
    ctx0.fsm.state = ctx0.state_stack.pop()
    ctx0.queue.addLast((stRedisInt, SyntaxValue(kind: skRedisValue, val: RedisValue(kind: rkInteger, val: sv.num))))
    return ctx0

  proc reduce_5_to_redisbulkstring[T](ctx: T): T =
    var ctx0 = ctx
    discard ctx0.value_stack.pop()
    var (_, sv1) = ctx0.value_stack.pop()
    discard ctx0.value_stack.pop()
    discard ctx0.value_stack.pop()
    discard ctx0.value_stack.pop()
    discard ctx0.state_stack.pop()
    discard ctx0.state_stack.pop()
    discard ctx0.state_stack.pop()
    discard ctx0.state_stack.pop()
    ctx0.fsm.state = ctx0.state_stack.pop()
    ctx0.queue.addLast((stRedisBulkString, SyntaxValue(kind: skRedisValue, val: RedisValue(kind: rkBulkString, bulkstr: some(sv1.str)))))
    return ctx0

  proc reduce_4_to_redisemptybulkstring[T](ctx: T): T =
    var ctx0 = ctx
    discard ctx0.value_stack.pop()
    discard ctx0.value_stack.pop()
    discard ctx0.value_stack.pop()
    discard ctx0.value_stack.pop()
    discard ctx0.state_stack.pop()
    discard ctx0.state_stack.pop()
    discard ctx0.state_stack.pop()
    ctx0.fsm.state = ctx0.state_stack.pop()
    ctx0.queue.addLast((stRedisEmptyBulkString, SyntaxValue(kind: skRedisValue, val: RedisValue(kind: rkBulkString, bulkstr: some("")))))
    return ctx0

  proc reduce_3_to_redisnullbulkstring[T](ctx: T): T =
    var ctx0 = ctx
    discard ctx0.value_stack.pop()
    discard ctx0.value_stack.pop()
    discard ctx0.value_stack.pop()
    discard ctx0.state_stack.pop()
    discard ctx0.state_stack.pop()
    var n = none(system.string)
    ctx0.fsm.state = ctx0.state_stack.pop()
    ctx0.queue.addLast((stRedisNullBulkString, SyntaxValue(kind: skRedisValue, val: RedisValue(kind: rkBulkString, bulkstr: n))))
    return ctx0

  proc push_array_length[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.arrlen.add(ctx0.input.num)
    return ctx0

  proc reduce_1_to_redisarrayitems[T](ctx: T): T =
    var ctx0 = ctx
    var (_, item) = ctx0.value_stack.pop()
    ctx0.fsm.state = ctx0.state_stack.pop()
    var array = @[item.val]
    ctx0.queue.addLast((stRedisArrayItems, SyntaxValue(kind: skRedisArrayItems, items: array)))
    return ctx0

  proc reduce_4_to_redisarray[T](ctx: T): T =
    var ctx0 = ctx
    var (_, arrayitems) = ctx0.value_stack.pop()
    discard ctx0.value_stack.pop()
    discard ctx0.value_stack.pop()
    discard ctx0.value_stack.pop()
    discard ctx0.state_stack.pop()
    discard ctx0.state_stack.pop()
    discard ctx0.state_stack.pop()
    ctx0.fsm.state = ctx0.state_stack.pop()
    ctx0.queue.addLast((stRedisArray, SyntaxValue(kind: skRedisValue, val: RedisVAlue(kind: rkArray, array: some(arrayitems.items)))))
    return ctx0

  proc pop_array_length[T](ctx: T): T =
    var ctx0 = ctx
    discard ctx0.arrlen.pop()
    return ctx0

  proc reduce_2_to_redisarrayitems[T](ctx: T): T =
    var ctx0 = ctx
    var (_, item) = ctx0.value_stack.pop()
    var (sttype, array) = ctx0.value_stack.pop()
    discard ctx0.state_stack.pop()
    ctx0.fsm.state = ctx0.state_stack.pop()
    array.items.add(item.val)
    ctx0.queue.addLast((sttype, array))
    return ctx0

  proc reduce_3_to_redisarray[T](ctx: T): T =
    var ctx0 = ctx
    discard ctx0.value_stack.pop()
    discard ctx0.value_stack.pop()
    discard ctx0.value_stack.pop()
    discard ctx0.state_stack.pop()
    discard ctx0.state_stack.pop()
    ctx0.fsm.state = ctx0.state_stack.pop()
    ctx0.queue.addLast((stRedisArray, SyntaxValue(kind: skRedisValue, val: RedisVAlue(kind: rkArray, array: some[seq[RedisValue]](@[])))))
    return ctx0

  proc reduce_3_to_redisnullarray[T](ctx: T): T =
    var ctx0 = ctx
    discard ctx0.value_stack.pop()
    discard ctx0.value_stack.pop()
    discard ctx0.value_stack.pop()
    discard ctx0.state_stack.pop()
    discard ctx0.state_stack.pop()
    ctx0.fsm.state = ctx0.state_stack.pop()
    ctx0.queue.addLast((stRedisNullArray, SyntaxValue(kind: skRedisValue, val: RedisValue(kind: rkArray, array: none(seq[RedisValue])))))
    return ctx0
#+end_src
* 接口定义
** 框架
#+begin_src nim :noweb-ref interface
  <<open>>

  <<open_async>>

  <<exec>>

  <<key-value>>

  <<hash>>

  <<list>>
#+end_src
** open
#+begin_src nim :noweb-ref open
  proc open*(host = "localhost", port = 6379.Port, timeout=0): Redis =
    ## Open a connection to a redis server.
    result = Redis(socket: newSocket(buffered = false))
    result.pipeline = @[]
    result.timeout = timeout
    result.socket.connect(host, port)
    result.connected = true
#+end_src
** open_async
#+begin_src nim :noweb-ref open_async
  proc open_async*(host = "localhost", port = 6379.Port): Future[AsyncRedis] {.async.} =
    ## Open an asynchronous connection to a redis server.
    result = AsyncRedis(socket: newAsyncSocket(buffered = false))
    result.pipeline = @[]
    await result.socket.connect(host, port)
    result.connected = true
#+end_src
** exec
#+begin_src nim :noweb-ref exec
  proc exec*(this: Redis | AsyncRedis, command: string, args: seq[string]): Future[RedisValue] {.multisync.} =
    ## execute command `command` with arguments seq `args`

    <<convert-args>>

    await this.socket.send(encode(cmd))

    <<init-fsm>>

    when this is Redis:
      var timeout = -1
      if this.timeout != 0:
        timeout = this.timeout
      while lctx.sctx.done == false:
        var response = this.socket.recv(1024, timeout = timeout)
        <<execute-fsm>>
      (lfsm, lctx) = eof[LexerContext](lfsm, lctx)
      return lctx.sctx.target.val
    else:
      while lctx.sctx.done == false:
        var response = await this.socket.recv(1024)
        <<execute-fsm>>
      (lfsm, lctx) = eof[LexerContext](lfsm, lctx)
      return lctx.sctx.target.val
#+end_src
*** 转化参数为 Redis 格式
#+begin_src nim :noweb-ref convert-args
  var parameters = newSeq[RedisValue](len(args) + 1)
  parameters[0] = RedisValue(kind: rkBulkString, bulkstr: some(command))
  for idx in 1..len(args):
    parameters[idx] = RedisValue(kind: rkBulkString, bulkstr: some(args[idx - 1]))
  let cmd = RedisValue(kind: rkArray, array: some(parameters))
#+end_src
*** 初始化状态机
#+begin_src nim :noweb-ref init-fsm
  let sdgt = SyntaxActionDelegate[SyntaxContext](
    shift: shift[SyntaxContext],
    reduce_1_to_target: reduce_1_to_target[SyntaxContext],
    set_done: set_done[SyntaxContext],
    reduce_1_to_redisvalue: reduce_1_to_redisvalue[SyntaxContext],
    clear_done: clear_done[SyntaxContext],
    syntax_error: syntax_error[SyntaxContext],
    convert_to_string: convert_to_string[SyntaxContext],
    reduce_3_to_redisstring: reduce_3_to_redisstring[SyntaxContext],
    reduce_3_to_rediserror: reduce_3_to_rediserror[SyntaxContext],
    reduce_3_to_redisint: reduce_3_to_redisint[SyntaxContext],
    reduce_5_to_redisbulkstring: reduce_5_to_redisbulkstring[SyntaxContext],
    reduce_4_to_redisemptybulkstring: reduce_4_to_redisemptybulkstring[SyntaxContext],
    reduce_3_to_redisnullbulkstring: reduce_3_to_redisnullbulkstring[SyntaxContext],
    push_array_length: push_array_length[SyntaxContext],
    reduce_1_to_redisarrayitems: reduce_1_to_redisarrayitems[SyntaxContext],
    reduce_4_to_redisarray: reduce_4_to_redisarray[SyntaxContext],
    pop_array_length: pop_array_length[SyntaxContext],
    reduce_2_to_redisarrayitems: reduce_2_to_redisarrayitems[SyntaxContext],
    reduce_3_to_redisarray: reduce_3_to_redisarray[SyntaxContext],
    reduce_3_to_redisnullarray: reduce_3_to_redisnullarray[SyntaxContext],
  )
  var sfsm = newSyntaxStateMachine[SyntaxContext](sdgt)
  var sctx: SyntaxContext = new(SyntaxContext)
  sctx.fsm = sfsm
  sctx.state_stack = @[]
  sctx.value_stack = @[]
  sctx.queue = initDeque[(SyntaxTerminalType, SyntaxValue)]()
  sctx.error = false
  sctx.arrlen = @[]
  sctx.done = false

  var lctx: LexerContext = new(LexerContext)
  lctx.num = ""
  lctx.str = ""
  lctx.strlen = 0
  lctx.sfsm = sfsm
  lctx.sctx = sctx
  let ldgt = LexerActionDelegate[LexerContext](
    output_plus: output_plus[LexerContext],
    output_colon: output_colon[LexerContext],
    output_dollar: output_dollar[LexerContext],
    output_asterisk: output_asterisk[LexerContext],
    add_to_number: add_to_number[LexerContext],
    add_to_string: add_to_string[LexerContext],
    output_minus: output_minus[LexerContext],
    add_minus_to_number: add_minus_to_number[LexerContext],
    move_number_to_string: move_number_to_string[LexerContext],
    output_number: output_number[LexerContext],
    output_string: output_string[LexerContext],
    output_crlf: output_crlf[LexerContext],
    set_string_length: set_string_length[LexerContext],
    clear_string_length: clear_string_length[LexerContext],
  )
  var lfsm = newLexerStateMachine[LexerContext](ldgt)
#+end_src
*** 执行状态机
#+begin_src nim :noweb-ref execute-fsm
  for ch in response:
    lctx.input = ch
    if ch == '+':
      (lfsm, lctx) = plus[LexerContext](lfsm, lctx)
    elif ch == '-':
      (lfsm, lctx) = minus[LexerContext](lfsm, lctx)
    elif ch == ':':
      (lfsm, lctx) = colon[LexerContext](lfsm, lctx)
    elif ch == '$':
      (lfsm, lctx) = dollar[LexerContext](lfsm, lctx)
    elif ch == '*':
      (lfsm, lctx) = asterisk[LexerContext](lfsm, lctx)
    elif ch == '\r':
      if len(lctx.str) == lctx.strlen:
        (lfsm, lctx) = cr_and_strlen_equals_len[LexerContext](lfsm, lctx)
      else:
        (lfsm, lctx) = cr[LexerContext](lfsm, lctx)
    elif ch == '\n':
      if lctx.strlen == -1:
        (lfsm, lctx) = lf_and_strlen_equals_negative_1[LexerContext](lfsm, lctx)
      else:
        (lfsm, lctx) = lf[LexerContext](lfsm, lctx)
    elif ch >= '0' and ch <= '9':
      (lfsm, lctx) = number[LexerContext](lfsm, lctx)
    else:
      (lfsm, lctx) = other[LexerContext](lfsm, lctx)
#+end_src
** key/value
*** 框架
#+begin_src nim :noweb-ref key-value
  <<del>>

  <<expire>>

  <<get>>

  <<set>>

  <<setex>>
#+end_src
*** del
#+begin_src nim :noweb-ref del
  proc del*(redis: Redis | AsyncRedis, key: string): Future[int] {.multisync.} =
    ## Removes the specified keys. A key is ignored if it does not exist.
    let resp = await redis.exec("DEL", @[key])
    result = resp.toInt()
#+end_src
*** expire
#+begin_src nim :noweb-ref expire
  proc expire*(redis: Redis | AsyncRedis, key: string, timeout: uint32): Future[bool] {.multisync.} =
    ## Get the value of key
    let resp = await redis.exec("EXPIRE", @[key, $timeout])
    if resp.toInt() == 1:
      result = true
    else:
      result = false
#+end_src
*** get
#+begin_src nim :noweb-ref get
  proc get*(redis: Redis | AsyncRedis, key: string): Future[Option[string]] {.multisync.} =
    ## Get the value of key
    let resp = await redis.exec("GET", @[key])
    result = resp.toString()
#+end_src
*** set
#+begin_src nim :noweb-ref set
  proc set*(redis: Redis | AsyncRedis, key: string, value: string): Future[bool] {.multisync.} =
    ## Set key to hold the string value.
    let resp = await redis.exec("SET", @[key, value])
    let str = resp.toString()
    if str.isSome() and str.get() == "OK":
      result = true
    else:
      result = false
#+end_src
*** setex
#+begin_src nim :noweb-ref setex
  proc setex*(redis: Redis | AsyncRedis, key: string, value: string, timeout: uint32): Future[bool] {.multisync.} =
    ## Set key to hold the string value and set key to timeout after a given number of seconds.
    let resp = await redis.exec("SET", @[key, value, "EX", $timeout])
    let str = resp.toString()
    if str.isSome() and str.get() == "OK":
      result = true
    else:
      result = false
#+end_src
** hash
*** 框架
#+begin_src nim :noweb-ref hash
  <<hdel>>

  <<hget>>

  <<hkeys>>

  <<hlen>>

  <<hmget>>

  <<hmset>>

  <<hset>>
#+end_src
*** hdel
#+begin_src nim :noweb-ref hdel
  proc hdel*(redis: Redis | AsyncRedis, key: string, fields: seq[string]): Future[int] {.multisync.} =
    ## Removes the specified fields from the hash stored at key.
    let resp = await redis.exec("HDEL", concat(@[key], fields))
    result = resp.toInt()
#+end_src
*** hget
#+begin_src nim :noweb-ref hget
  proc hget*(redis: Redis | AsyncRedis, key: string, field: string): Future[Option[string]] {.multisync.} =
    ## Returns the value associated with field in the hash stored at key.
    let resp = await redis.exec("HGET", @[key, field])
    result = resp.toString()
#+end_src
*** hkeys
#+begin_src nim :noweb-ref hkeys
  proc hkeys*(redis: Redis | AsyncRedis, key: string): Future[seq[string]] {.multisync.} =
    ## Returns all field names in the hash stored at key.
    let resp = await redis.exec("HKEYS", @[key])
    result = resp.toStringArray()
#+end_src
*** hlen
#+begin_src nim :noweb-ref hlen
  proc hlen*(redis: Redis | AsyncRedis, key: string): Future[uint32] {.multisync.} =
    ## Returns the number of fields contained in the hash stored at key.
    let resp = await redis.exec("HLEN", @[key])
    result = cast[uint32](resp.toInt())
#+end_src
*** hmget
#+begin_src nim :noweb-ref hmget
  proc hmget*(redis: Redis | AsyncRedis, key: string, fields: seq[string]): Future[seq[Option[string]]] {.multisync.} =
    ## Returns the values associated with the specified fields in the hash stored at key.
    let resp = await redis.exec("HMGET", concat(@[key], fields))
    result = resp.toOptionalStringArray()
#+end_src
*** hmset
#+begin_src nim :noweb-ref hmset
  proc hmset*(redis: Redis | AsyncRedis, key: string, pairs: seq[(string, string)]): Future[bool] {.multisync.} =
    ## Sets the specified fields to their respective values in the hash stored at key.
    var params = @[key]
    for pair in pairs:
      params.add(pair[0])
      params.add(pair[1])
    let resp = await redis.exec("HMSET", params)
    let str = resp.toString()
    if str.isSome() and str.get() == "OK":
      result = true
    else:
      result = false
#+end_src
*** hset
#+begin_src nim :noweb-ref hset
  proc hset*(redis: Redis | AsyncRedis, key: string, field: string, value: string): Future[uint32] {.multisync.} =
    ## Sets field in the hash stored at key to value.
    let resp = await redis.exec("HSET", @[key, field, value])
    result = cast[uint32](resp.toInt())
#+end_src
** list
*** 框架
#+begin_src nim :noweb-ref list
  <<llen>>

  <<lpop>>

  <<lpush>>

  <<lrange>>

  <<rpop>>

  <<rpush>>
#+end_src
*** llen
#+begin_src nim :noweb-ref llen
  proc llen*(redis: Redis | AsyncRedis, key: string): Future[uint32] {.multisync.} =
    ## Returns the length of the list stored at key.
    let resp = await redis.exec("LLEN", @[key])
    result = cast[uint32](resp.toInt())
#+end_src
*** lpop
#+begin_src nim :noweb-ref lpop
  proc lpop*(redis: Redis | AsyncRedis, key: string): Future[Option[string]] {.multisync.} =
    ## Removes and returns the first element of the list stored at key.
    let resp = await redis.exec("LPOP", @[key])
    result = resp.toString()
#+end_src
*** lpush
#+begin_src nim :noweb-ref lpush
  proc lpush*(redis: Redis | AsyncRedis, key: string, fields: seq[string]): Future[uint32] {.multisync.} =
    ## Insert all the specified values at the head of the list stored at key.
    let resp = await redis.exec("LPUSH", concat(@[key], fields))
    result = cast[uint32](resp.toInt())
#+end_src
*** lrange
#+begin_src nim :noweb-ref lrange
  proc lrange*(redis: Redis | AsyncRedis, key: string, start: int, stop: int): Future[seq[string]] {.multisync.} =
    ## Returns the specified elements of the list stored at key.
    let resp = await redis.exec("LRANGE", @[key, $start, $stop])
    result = resp.toStringArray()
#+end_src
*** rpop
#+begin_src nim :noweb-ref rpop
  proc rpop*(redis: Redis | AsyncRedis, key: string): Future[Option[string]] {.multisync.} =
    ## Removes and returns the last element of the list stored at key.
    let resp = await redis.exec("RPOP", @[key])
    result = resp.toString()
#+end_src
*** rpush
#+begin_src nim :noweb-ref rpush
  proc rpush*(redis: Redis | AsyncRedis, key: string, fields: seq[string]): Future[uint32] {.multisync.} =
    ## Insert all the specified values at the tail of the list stored at key.
    let resp = await redis.exec("RPUSH", concat(@[key], fields))
    result = cast[uint32](resp.toInt())
#+end_src
* 辅助方法
** 框架
#+begin_src nim :noweb-ref utilities
  <<serializer>>

  <<repr>>

  <<to-string>>

  <<generic-constructor>>

  <<converter>>
#+end_src
** serializer
#+begin_src nim :noweb-ref serializer
  proc encode_string(str: string): string =
    return "+" & str & "\r\n"

  proc encode_error(err: string): string =
    return "-" & err & "\r\n"

  proc encode_integer(val: int): string =
    return ":" & $val & "\r\n"

  proc encode_bulk_string(str: Option[string]): string =
    if str.isSome:
      let
        val = str.get
        len = len(val)
      return "$" & $len & "\r\n" & val & "\r\n"
    else:
      return "$-1\r\n"

  proc encode*(val: RedisValue): string
  proc encode_array(arr: Option[seq[RedisValue]]): string =
    if arr.isSome:
      let
        val = arr.get
        len = len(val)
      result = "*" & $len & "\r\n"
      for e in val:
        result &= encode(e)
    else:
      return "*-1\r\n"

  proc encode*(val: RedisValue): string =
    case val.kind:
      of rkString:
        return encode_string(val.str)
      of rkError:
        return encode_error(val.err)
      of rkInteger:
        return encode_integer(val.val)
      of rkBulkString:
        return encode_bulk_string(val.bulkstr)
      of rkArray:
        return encode_array(val.array)
#+end_src
** repr
#+begin_src nim :noweb-ref repr
  proc repr*(val: RedisValue): string =
    case val.kind:
      of rkString:
        return "\"$1\"" % val.str
      of rkError:
        return "\"$1\"" % val.err
      of rkInteger:
        return $ val.val
      of rkBulkString:
        if val.bulkstr.isNone():
          return "nil"
        else:
          return "\"$1\"" % val.bulkstr.get()
      of rkArray:
        if val.array.isNone():
          return "nil"
        else:
          let
            items = val.array.get()
            strs = items.mapIt(repr(it))
          return "[$1]" % strs.join(", ")
#+end_src
** to string
#+begin_src nim :noweb-ref to-string
  proc `$`*(val: RedisValue): string =
    case val.kind:
      of rkString:
        return $ val.str
      of rkError:
        return $ val.err
      of rkInteger:
        return $ val.val
      of rkBulkString:
        if val.bulkstr.isNone():
          return "nil"
        else:
          return $val.bulkstr.get()
      of rkArray:
        if val.array.isNone():
          return "nil"
        else:
          let
            items = val.array.get()
            strs = items.mapIt($it)
          return "[$1]" % strs.join(", ")
#+end_src
** generic constructor
#+begin_src nim :noweb-ref generic-constructor
  proc `%`*(str: string): RedisValue =
    if str.find("\r\n") == -1:
      result = RedisValue(kind: rkString, str: str)
    else:
      result = RedisValue(kind: rkBulkString, bulkstr: some(str))

  proc `%`*(num: int): RedisValue =
    result = RedisValue(kind: rkInteger, val: num)

  proc `%`*(arr: seq[int]): RedisValue =
    result = RedisValue(kind: rkArray, array: some(arr.mapIt(%it)))

  proc `%`*(arr: seq[string]): RedisValue =
    result = RedisValue(kind: rkArray, array: some(arr.mapIt(%it)))
#+end_src
** converter
#+begin_src nim :noweb-ref converter
  proc toInt(v: RedisValue): int =
    if v.kind == rkInteger:
      result = v.val
    else:
      result = 0

  proc toString(v: RedisValue): Option[string] =
    if v.kind == rkString:
      result = some(v.str)
    elif v.kind == rkError:
      result = some(v.err)
    elif v.kind == rkBulkString:
      result = v.bulkstr
    else:
      result = none(string)

  proc toStringArray(v: RedisValue): seq[string] =
    if v.kind == rkArray:
      if v.array.isNone:
        return @[]
      for item in v.array.get():
        if item.kind == rkString:
          result.add(item.str)
        elif item.kind == rkError:
          result.add(item.err)
        elif item.kind == rkBulkString:
          if item.bulkstr.isSome:
            result.add(item.bulkstr.get())
          else:
            result.add("")
        elif item.kind == rkInteger:
          result.add($item.val)
    else:
      result = @[]

  proc toOptionalStringArray(v: RedisValue): seq[Option[string]] =
    if v.kind == rkArray:
      if v.array.isNone:
        return @[]
      for item in v.array.get():
        if item.kind == rkString:
          result.add(some(item.str))
        elif item.kind == rkError:
          result.add(some(item.err))
        elif item.kind == rkBulkString:
          result.add(item.bulkstr)
        elif item.kind == rkInteger:
          result.add(some($item.val))
    else:
      result = @[]
#+end_src
