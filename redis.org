#+TITLE: The Driver For Redis Written by Nim Language
#+AUTHOR: Titan
#+EMAIL: howay.tan@gmail.com
#+DATE: <2019-02-13 Wed>
#+KEYWORDS: nim redis driver
#+OPTIONS: H:4 toc:t
#+STARTUP: indent
#+SUBTITLE:
#+titlepage: true
#+titlepage-color: 06386e
#+titlepage-text-color: FFFFFF
#+titlepage-rule-color: FFFFFF
#+titlepage-rule-height: 1

* 基本框架
#+begin_src nim :tangle ${BUILDDIR}/redis.nim
  import asyncdispatch, asyncnet, deques, net, options, sequtils, strutils, tables
  import redis/lexer
  import redis/syntax

  <<type>>

  <<utilities>>

  <<lexer-guard>>

  <<lexer-action>>

  <<syntax-guard>>

  <<syntax-action>>

  <<interface>>
#+end_src
* 类型定义
#+begin_src nim :noweb-ref type
  type
    RedisError* = object of IOError ## Error in redis

    <<syntax-context>>

    <<lexer-context>>

    <<interface-type>>

    <<data-type>>
#+end_src
** 接口类型
#+begin_src nim :noweb-ref interface-type
  Pipeline = ref object
    enabled: bool
    buffer: string

  RedisBase[TSocket] = ref object of RootObj
    socket: TSocket
    connected: bool
    pipeline: Pipeline
    timeout*: int
    syntax_action_delegate: SyntaxActionDelegate[SyntaxContext]
    syntax_guard_delegate: SyntaxGuardDelegate[SyntaxContext]
    lexer_action_delegate: LexerActionDelegate[LexerContext]
    lexer_guard_delegate: LexerGuardDelegate[LexerContext]

  Redis* = ref object of RedisBase[net.Socket]

  AsyncRedis* = ref object of RedisBase[asyncnet.AsyncSocket]
    current_command: Option[string]
    send_queue: Deque[Future[void]]
#+end_src
** 数据类型
#+begin_src nim :noweb-ref data-type
  RedisKind* = enum
    rkString, rkError, rkInteger, rkBulkString, rkArray

  RedisValue* = ref object
    case kind*: RedisKind
    of rkString: str*: string
    of rkError: err*: string
    of rkInteger: val*: int
    of rkBulkString: bulkstr*: Option[string]
    of rkArray: array*: Option[seq[RedisValue]]
#+end_src

* 协议解析
** BNF 定义
#+begin_src text
  target = RedisValue

  RedisValue = RedisString
             | RedisError
             | RedisInt
             | RedisBulkString
             | RedisEmptyBulkString
             | RedisNullBulkString
             | RedisArray
             | RedisNullArray

  RedisString = '+' string '\r\n'

  RedisError = '-' string '\r\n'

  RedisInt = ':' number '\r\n'

  RedisInt = ':' '0' '\r\n'

  RedisBulkString = '$' number '\r\n' string '\r\n'

  RedisEmptyBulkString = '$' '0' '\r\n' '\r\n'

  RedisNullBulkString = '$' '-1' '\r\n'

  RedisArray = '*' number '\r\n' RedisArrayItems
             | '*' '0' '\r\n'

  RedisNullArray = '*' '-1' '\r\n'

  RedisArrayItems = RedisArrayItems RedisString
                  | RedisArrayItems RedisError
                  | RedisArrayItems RedisInt
                  | RedisArrayItems RedisBulkString
                  | RedisArrayItems RedisEmptyBulkString
                  | RedisArrayItems RedisNullBulkString
                  | RedisArrayItems RedisArray
                  | RedisArrayItems RedisNullArray
                  | RedisString
                  | RedisError
                  | RedisInt
                  | RedisBulkString
                  | RedisEmptyBulkString
                  | RedisNullBulkString
                  | RedisArray
                  | RedisNullArray
#+end_src
** 词法解析状态机
*** 定义
#+begin_src text :tangle ${BUILDDIR}/lexer.txt
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------+-----------------------------------------------+-----------------------------+--------------------------------------------------+-----------------------------+---------------+
  | state\event           | input(ch: char)[ch == '+'] | input(ch: char)[ch == '-'] | input(ch: char)[ch == ':'] | input(ch: char)[ch == '$'] | input(ch: char)[ch == '*'] | input(ch: char)[isNumber(ch)] | input(ch: char)       | input(ch: char)[cr_and_len_equals_strlen(ch)] | input(ch: char)[ch == '\r'] | input(ch: char)[lf_and_strlen_is_negative_1(ch)] | input(ch: char)[ch == '\n'] | eof           |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------+-----------------------------------------------+-----------------------------+--------------------------------------------------+-----------------------------+---------------+
  |                       | output plus                |                            | output colon               | output dollar              | output asterisk            | add to number                 | add to string         |                                               |                             |                                                  |                             |               |
  |                       | ----                       | ----                       | ----                       | ----                       | ----                       | ----                          | ----                  |                                               |                             |                                                  |                             |               |
  | INIT                  | +                          | -                          |                            | $                          |                            | NUMBER                        | STRING                |                                               |                             |                                                  |                             |               |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------+-----------------------------------------------+-----------------------------+--------------------------------------------------+-----------------------------+---------------+
  |                       | output minus               |                            | output minus               | output minus               | output minus               | add minus to number           | output minus          |                                               |                             |                                                  |                             |               |
  |                       | output plus                | output minus               | output colon               | output dollar              | output asterisk            | add to number                 | add to string         | output minus                                  | output minus                |                                                  |                             |               |
  |                       | ----                       | ----                       | ----                       | ----                       | ----                       | ----                          | ----                  | ----                                          | ----                        |                                                  |                             |               |
  | -                     | INIT                       |                            | INIT                       | INIT                       | INIT                       | NUMBER                        | - STRING              | CR                                            | CR                          |                                                  |                             |               |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------+-----------------------------------------------+-----------------------------+--------------------------------------------------+-----------------------------+---------------+
  |                       | move number to string      | move number to string      | move number to string      | move number to string      | move number to string      |                               | move number to string |                                               |                             |                                                  |                             |               |
  |                       | add to string              | add to string              | add to string              | add to string              | add to string              | add to number                 | add to string         | output number                                 | output number               |                                                  |                             | output number |
  |                       | ----                       | ----                       | ----                       | ----                       | ----                       | ----                          | ----                  | ----                                          | ----                        |                                                  |                             | ----          |
  | NUMBER                | STRING                     | STRING                     | STRING                     | STRING                     | STRING                     |                               | STRING                | CR                                            | CR                          |                                                  |                             | INIT          |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------+-----------------------------------------------+-----------------------------+--------------------------------------------------+-----------------------------+---------------+
  |                       | add to string              | add to string              | add to string              | add to string              | add to string              | add to string                 | add to string         | output string                                 | output string               |                                                  |                             | output string |
  |                       | ----                       | ----                       | ----                       | ----                       | ----                       | ----                          | ----                  | ----                                          | ----                        |                                                  |                             | ----          |
  | STRING                |                            |                            |                            |                            |                            |                               |                       | CR                                            | CR                          |                                                  |                             | INIT          |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------+-----------------------------------------------+-----------------------------+--------------------------------------------------+-----------------------------+---------------+
  |                       |                            |                            |                            |                            |                            |                               |                       |                                               |                             | output crlf                                      | output crlf                 | output crlf   |
  |                       |                            |                            |                            |                            |                            |                               |                       |                                               |                             | ----                                             | ----                        | ----          |
  | CR                    |                            |                            |                            |                            |                            |                               |                       |                                               |                             | INIT                                             | INIT                        | INIT          |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------+-----------------------------------------------+-----------------------------+--------------------------------------------------+-----------------------------+---------------+
  |                       |                            |                            |                            |                            |                            | add to string                 | add to string         |                                               |                             |                                                  |                             |               |
  |                       |                            |                            |                            |                            |                            | ----                          | ----                  |                                               |                             |                                                  |                             |               |
  | +                     |                            |                            |                            |                            |                            | + STRING                      | + STRING              |                                               |                             |                                                  |                             |               |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------+-----------------------------------------------+-----------------------------+--------------------------------------------------+-----------------------------+---------------+
  |                       | add to string              | add to string              | add to string              | add to string              | add to string              | add to string                 | add to string         | output string                                 | output string               |                                                  |                             |               |
  |                       | ----                       | ----                       | ----                       | ----                       | ----                       | ----                          | ----                  | ----                                          | ----                        |                                                  |                             |               |
  | + STRING              |                            |                            |                            |                            |                            |                               |                       | + STRING CR                                   | + STRING CR                 |                                                  |                             |               |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------+-----------------------------------------------+-----------------------------+--------------------------------------------------+-----------------------------+---------------+
  |                       |                            |                            |                            |                            |                            |                               |                       |                                               |                             | output crlf                                      | output crlf                 | output crlf   |
  |                       |                            |                            |                            |                            |                            |                               |                       |                                               |                             | ----                                             | ----                        | ----          |
  | + STRING CR           |                            |                            |                            |                            |                            |                               |                       |                                               |                             | INIT                                             | INIT                        | INIT          |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------+-----------------------------------------------+-----------------------------+--------------------------------------------------+-----------------------------+---------------+
  |                       | add to string              | add to string              | add to string              | add to string              | add to string              | add to string                 | add to string         | output string                                 | output string               |                                                  |                             |               |
  |                       | ----                       | ----                       | ----                       | ----                       | ----                       | ----                          | ----                  | ----                                          | ----                        |                                                  |                             |               |
  | - STRING              |                            |                            |                            |                            |                            |                               |                       | - STRING CR                                   | - STRING CR                 |                                                  |                             |               |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------+-----------------------------------------------+-----------------------------+--------------------------------------------------+-----------------------------+---------------+
  |                       |                            |                            |                            |                            |                            |                               |                       |                                               |                             | output crlf                                      | output crlf                 | output crlf   |
  |                       |                            |                            |                            |                            |                            |                               |                       |                                               |                             | ----                                             | ----                        | ----          |
  | - STRING CR           |                            |                            |                            |                            |                            |                               |                       |                                               |                             | INIT                                             | INIT                        | INIT          |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------+-----------------------------------------------+-----------------------------+--------------------------------------------------+-----------------------------+---------------+
  |                       |                            | add to number              |                            |                            |                            | add to number                 |                       |                                               |                             |                                                  |                             |               |
  |                       |                            | ----                       |                            |                            |                            | ----                          |                       |                                               |                             |                                                  |                             |               |
  | $                     |                            | $ NUMBER                   |                            |                            |                            | $ NUMBER                      |                       |                                               |                             |                                                  |                             |               |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------+-----------------------------------------------+-----------------------------+--------------------------------------------------+-----------------------------+---------------+
  |                       |                            |                            |                            |                            |                            |                               |                       | set string length                             | set string length           |                                                  |                             |               |
  |                       |                            |                            |                            |                            |                            | add to number                 |                       | output number                                 | output number               |                                                  |                             |               |
  |                       |                            |                            |                            |                            |                            | ----                          |                       | ----                                          | ----                        |                                                  |                             |               |
  | $ NUMBER              |                            |                            |                            |                            |                            |                               |                       | $ NUMBER CR                                   | $ NUMBER CR                 |                                                  |                             |               |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------+-----------------------------------------------+-----------------------------+--------------------------------------------------+-----------------------------+---------------+
  |                       |                            |                            |                            |                            |                            |                               |                       |                                               |                             | output crlf                                      | output crlf                 | output crlf   |
  |                       |                            |                            |                            |                            |                            |                               |                       |                                               |                             | ----                                             | ----                        | ----          |
  | $ NUMBER CR           |                            |                            |                            |                            |                            |                               |                       |                                               |                             | INIT                                             | $ NUMBER CR STRING          | INIT          |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------+-----------------------------------------------+-----------------------------+--------------------------------------------------+-----------------------------+---------------+
  |                       |                            |                            |                            |                            |                            |                               |                       | output string                                 |                             |                                                  |                             |               |
  |                       | add to string              | add to string              | add to string              | add to string              | add to string              | add to string                 | add to string         | clear string length                           | add to string               |                                                  | add to string               |               |
  |                       | ----                       | ----                       | ----                       | ----                       | ----                       | ----                          | ----                  | ----                                          | ----                        |                                                  | ----                        |               |
  | $ NUMBER CR STRING    |                            |                            |                            |                            |                            |                               |                       | $ NUMBER CR STRING CR                         |                             |                                                  |                             |               |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------+-----------------------------------------------+-----------------------------+--------------------------------------------------+-----------------------------+---------------+
  |                       |                            |                            |                            |                            |                            |                               |                       |                                               |                             | output crlf                                      | output crlf                 | output crlf   |
  |                       |                            |                            |                            |                            |                            |                               |                       |                                               |                             | ----                                             | ----                        | ----          |
  | $ NUMBER CR STRING CR |                            |                            |                            |                            |                            |                               |                       |                                               |                             | INIT                                             | INIT                        | INIT          |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------+-----------------------------------------------+-----------------------------+--------------------------------------------------+-----------------------------+---------------+
#+end_src
*** 数据定义
#+begin_src nim :noweb-ref lexer-context
  LexerContext = ref object
    input: char
    num: string
    str: string
    strlen: int
    sfsm: SyntaxStateMachine[SyntaxContext]
    sctx: SyntaxContext
#+end_src
*** 执行动作
#+begin_src nim :noweb-ref lexer-action
  proc feed_event[T](ctx: var T, sttype: SyntaxTerminalType, val: SyntaxValue) =
    ctx.sctx.input = val
    ctx.sctx.input_type = sttype
    case sttype:
      of stRedisValue: (ctx.sfsm, ctx.sctx) = redisvalue(ctx.sfsm, ctx.sctx)
      of stRedisString: (ctx.sfsm, ctx.sctx) = redisstring(ctx.sfsm, ctx.sctx)
      of stRedisError: (ctx.sfsm, ctx.sctx) = rediserror(ctx.sfsm, ctx.sctx)
      of stRedisInt: (ctx.sfsm, ctx.sctx) = redisint(ctx.sfsm, ctx.sctx)
      of stRedisNullBulkString: (ctx.sfsm, ctx.sctx) = redisnullbulkstring(ctx.sfsm, ctx.sctx)
      of stRedisEmptyBulkString: (ctx.sfsm, ctx.sctx) = redisemptybulkstring(ctx.sfsm, ctx.sctx)
      of stRedisBulkString: (ctx.sfsm, ctx.sctx) = redisbulkstring(ctx.sfsm, ctx.sctx)
      of stRedisNullArray: (ctx.sfsm, ctx.sctx) = redisnullarray(ctx.sfsm, ctx.sctx)
      of stRedisArray: (ctx.sfsm, ctx.sctx) = redisarray(ctx.sfsm, ctx.sctx)
      of stPlus: (ctx.sfsm, ctx.sctx) = literal_token(ctx.sfsm, ctx.sctx, "+")
      of stString: (ctx.sfsm, ctx.sctx) = my_string(ctx.sfsm, ctx.sctx)
      of stCrLf: (ctx.sfsm, ctx.sctx) = literal_token(ctx.sfsm, ctx.sctx, "\r\n")
      of stMinus: (ctx.sfsm, ctx.sctx) = literal_token(ctx.sfsm, ctx.sctx, "-")
      of stColon: (ctx.sfsm, ctx.sctx) = literal_token(ctx.sfsm, ctx.sctx, ":")
      of stNumber: (ctx.sfsm, ctx.sctx) = number(ctx.sfsm, ctx.sctx)
      of stDollar: (ctx.sfsm, ctx.sctx) = literal_token(ctx.sfsm, ctx.sctx, "$")
      of stZero: (ctx.sfsm, ctx.sctx) = literal_token(ctx.sfsm, ctx.sctx, "0")
      of stNegative1: (ctx.sfsm, ctx.sctx) = literal_token(ctx.sfsm, ctx.sctx, "-1")
      of stAsterisk: (ctx.sfsm, ctx.sctx) = literal_token(ctx.sfsm, ctx.sctx, "*")
      of stRedisArrayItems: (ctx.sfsm, ctx.sctx) = redisarrayitems(ctx.sfsm, ctx.sctx)
    ctx.sctx.fsm = ctx.sfsm

  proc consume_queue[T](ctx: var T) =
    while len(ctx.sctx.queue) > 0:
      var (sttype, item) = ctx.sctx.queue.popFirst
      feed_event(ctx, sttype, item)

  proc output_plus[T](ctx: T): T =
    var ctx0 = ctx
    consume_queue(ctx0)
    ctx0.sctx.input_type = stPlus
    ctx0.sctx.input = SyntaxValue(kind: skString, str: "+")
    (ctx0.sfsm, ctx0.sctx) = literal_token(ctx0.sfsm, ctx0.sctx, "+")
    ctx0.sctx.fsm = ctx0.sfsm
    consume_queue(ctx0)
    result = ctx0

  proc output_colon[T](ctx: T): T =
    var ctx0 = ctx
    consume_queue(ctx0)
    ctx0.sctx.input_type = stColon
    ctx0.sctx.input = SyntaxValue(kind: skString, str: ":")
    (ctx0.sfsm, ctx0.sctx) = literal_token(ctx0.sfsm, ctx0.sctx, ":")
    ctx0.sctx.fsm = ctx0.sfsm
    consume_queue(ctx0)
    result = ctx0

  proc output_dollar[T](ctx: T): T =
    var ctx0 = ctx
    consume_queue(ctx0)
    ctx0.sctx.input_type = stDollar
    ctx0.sctx.input = SyntaxValue(kind: skString, str: "$")
    (ctx0.sfsm, ctx0.sctx) = literal_token(ctx0.sfsm, ctx0.sctx, "$")
    ctx0.sctx.fsm = ctx0.sfsm
    consume_queue(ctx0)
    result = ctx0

  proc output_asterisk[T](ctx: T): T =
    var ctx0 = ctx
    consume_queue(ctx0)
    ctx0.sctx.input_type = stAsterisk
    ctx0.sctx.input = SyntaxValue(kind: skString, str: "*")
    (ctx0.sfsm, ctx0.sctx) = literal_token(ctx0.sfsm, ctx0.sctx, "*")
    ctx0.sctx.fsm = ctx0.sfsm
    consume_queue(ctx0)
    result = ctx0

  proc add_to_number[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.num.add(ctx.input)
    result = ctx0

  proc add_to_string[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.str.add(ctx.input)
    result = ctx0

  proc output_minus[T](ctx: T): T =
    var ctx0 = ctx
    consume_queue(ctx0)
    ctx0.sctx.input_type = stMinus
    ctx0.sctx.input = SyntaxValue(kind: skString, str: "-")
    (ctx0.sfsm, ctx0.sctx) = literal_token(ctx0.sfsm, ctx0.sctx, "-")
    ctx0.sctx.fsm = ctx0.sfsm
    consume_queue(ctx0)
    result = ctx0

  proc add_minus_to_number[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.num.add('-')
    result = ctx0

  proc move_number_to_string[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.str = ctx0.num
    ctx0.num = ""
    result = ctx0

  proc output_number[T](ctx: T): T =
    let num = parseInt($ctx.num)
    var ctx0 = ctx
    if num == 0:
      consume_queue(ctx0)
      ctx0.sctx.input_type = stZero
      ctx0.sctx.input = SyntaxValue(kind: skNumber, num: num)
      (ctx0.sfsm, ctx0.sctx) = literal_token(ctx0.sfsm, ctx0.sctx, "0")
      ctx0.sctx.fsm = ctx0.sfsm
      ctx0.num = ""
      consume_queue(ctx0)
      result = ctx0
    elif num == -1:
      consume_queue(ctx0)
      ctx0.sctx.input_type = stNegative1
      ctx0.sctx.input = SyntaxValue(kind: skNumber, num: num)
      (ctx0.sfsm, ctx0.sctx) = literal_token(ctx0.sfsm, ctx0.sctx, "-1")
      ctx0.sctx.fsm = ctx0.sfsm
      ctx0.num = ""
      consume_queue(ctx0)
      result = ctx0
    else:
      consume_queue(ctx0)
      ctx0.sctx.input_type = stNumber
      ctx0.sctx.input = SyntaxValue(kind: skNumber, num: num)
      (ctx0.sfsm, ctx0.sctx) = number(ctx0.sfsm, ctx0.sctx)
      ctx0.sctx.fsm = ctx0.sfsm
      ctx0.num = ""
      consume_queue(ctx0)
      result = ctx0

  proc output_string[T](ctx: T): T =
    var ctx0 = ctx
    consume_queue(ctx0)
    ctx0.sctx.input_type = stString
    ctx0.sctx.input = SyntaxValue(kind: skString, str: $ctx.str)
    (ctx0.sfsm, ctx0.sctx) = my_string(ctx0.sfsm, ctx0.sctx)
    ctx0.sctx.fsm = ctx0.sfsm
    ctx0.str = ""
    consume_queue(ctx0)
    result = ctx0

  proc output_crlf[T](ctx: T): T =
    var ctx0 = ctx
    consume_queue(ctx0)
    ctx0.sctx.input_type = stCrLf
    ctx0.sctx.input = SyntaxValue(kind: skString, str: "\r\n")
    (ctx0.sfsm, ctx0.sctx) = literal_token(ctx0.sfsm, ctx0.sctx, "\r\n")
    ctx0.sctx.fsm = ctx0.sfsm
    consume_queue(ctx0)
    result = ctx0

  proc set_string_length[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.strlen = parseInt(ctx0.num)
    result = ctx0

  proc clear_string_length[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.strlen = 0
    result = ctx0
#+end_src
*** 条件判断
#+begin_src nim :noweb-ref lexer-guard
  proc isnumber[T](ctx: T, a0: char): bool =
    return ord(a0) >= ord('0') and ord(a0) <= ord('9')

  proc cr_and_len_equals_strlen[T](ctx: T, a0: char): bool =
    return a0 == '\r' and len(ctx.str) == ctx.strlen

  proc lf_and_strlen_is_negative_1[T](ctx: T, a0: char): bool =
    return a0 == '\n' and ctx.strlen == -1
#+end_src
** 语法解析状态机
*** 定义
#+begin_src text :tangle ${BUILDDIR}/syntax.txt
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+----------------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------------+----------------------------------------+-----------------------------------------------------+------------------------------------------------+-----------------------------------------------------+-----------------------------------------+--------------------------------------------------+---------------------------------------+----------------------------------------------------------+
  | state\event                                              | RedisValue         | RedisString                 | RedisError                  | RedisInt                    | RedisBulkString             | RedisEmptyBulkString        | RedisNullBulkString         | RedisArray                  | RedisNullArray              | literal-token(val: string)[val == "+"] | string                                              | literal-token(val: string)[val == "\r\n"]                | literal-token(val: string)[val == "-"] | literal-token(val: string)[val == ":"] | number                                              | literal-token(val: string)[val == "0"]         | literal-token(val: string)[val == "$"]              | literal-token(val: string)[val == "-1"] | literal-token(val: string)[val == "*"]           | RedisArrayItems[len_equals_to_number] | RedisArrayItems                                          |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+----------------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------------+----------------------------------------+-----------------------------------------------------+------------------------------------------------+-----------------------------------------------------+-----------------------------------------+--------------------------------------------------+---------------------------------------+----------------------------------------------------------+
  | target = · RedisValue                                    |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisValue = · RedisString                               |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisString = · "+" string "\r\n"                        |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisValue = · RedisError                                |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisError = · "-" string "\r\n"                         |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisValue = · RedisInt                                  |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisInt = · ":" number "\r\n"                           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisInt = · ":" "0" "\r\n"                              |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisValue = · RedisBulkString                           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisBulkString = · "$" number "\r\n" string "\r\n"      |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisValue = · RedisEmptyBulkString                      |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisEmptyBulkString = · "$" "0" "\r\n" "\r\n"           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisValue = · RedisNullBulkString                       |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisNullBulkString = · "$" "-1" "\r\n"                  |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                | clear done                                          |                                         | clear done                                       |                                       |                                                          |
  | RedisValue = · RedisArray                                | shift              |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        | clear done                             |                                                     |                                                | shift                                               |                                         | shift                                            |                                       |                                                          |
  | RedisArray = · "*" number "\r\n" RedisArrayItems         | reduce 1 to target | shift                       | shift                       | shift                       | shift                       | shift                       | shift                       | shift                       | shift                       | clear done                             |                                                     |                                                          | clear done                             | shift                                  |                                                     |                                                | ----                                                |                                         | ----                                             |                                       |                                                          |
  | RedisArray = · "*" "0" "\r\n"                            | set done           | reduce 1 to RedisValue      | reduce 1 to RedisValue      | reduce 1 to RedisValue      | reduce 1 to RedisValue      | reduce 1 to RedisValue      | reduce 1 to RedisValue      | reduce 1 to RedisValue      | reduce 1 to RedisValue      | shift                                  | syntax error                                        | syntax error                                             | shift                                  | ----                                   | syntax error                                        | syntax error                                   | RedisBulkString = "$" · number "\r\n" string "\r\n" | syntax error                            | RedisArray = "*" · number "\r\n" RedisArrayItems | syntax error                          | syntax error                                             |
  | RedisValue = · RedisNullArray                            | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                                   | ----                                                | ----                                                     | ----                                   | RedisInt = ":" · number "\r\n"         | ----                                                | ----                                           | RedisEmptyBulkString = "$" · "0" "\r\n" "\r\n"      | ----                                    | RedisArray = "*" · "0" "\r\n"                    | ----                                  | ----                                                     |
  | RedisNullArray = · "*" "-1" "\r\n"                       |                    |                             |                             |                             |                             |                             |                             |                             |                             | RedisString = "+" · string "\r\n"      |                                                     |                                                          | RedisError = "-" · string "\r\n"       | RedisInt = ":" · "0" "\r\n"            |                                                     |                                                | RedisNullBulkString = "$" · "-1" "\r\n"             |                                         | RedisNullArray = "*" · "-1" "\r\n"               |                                       |                                                          |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+----------------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------------+----------------------------------------+-----------------------------------------------------+------------------------------------------------+-----------------------------------------------------+-----------------------------------------+--------------------------------------------------+---------------------------------------+----------------------------------------------------------+
  |                                                          | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                           | shift                                               | syntax error                                             | syntax error                           | syntax error                           | syntax error                                        | syntax error                                   | syntax error                                        | syntax error                            | syntax error                                     | syntax error                          | syntax error                                             |
  |                                                          | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                                   | ----                                                | ----                                                     | ----                                   | ----                                   | ----                                                | ----                                           | ----                                                | ----                                    | ----                                             | ----                                  | ----                                                     |
  | RedisString = "+" · string "\r\n"                        |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        | RedisString = "+" string · "\r\n"                   |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+----------------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------------+----------------------------------------+-----------------------------------------------------+------------------------------------------------+-----------------------------------------------------+-----------------------------------------+--------------------------------------------------+---------------------------------------+----------------------------------------------------------+
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | shift                                                    |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                           | syntax error                                        | reduce 3 to RedisString                                  | syntax error                           | syntax error                           | syntax error                                        | syntax error                                   | syntax error                                        | syntax error                            | syntax error                                     | syntax error                          | syntax error                                             |
  |                                                          | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                                   | ----                                                | ----                                                     | ----                                   | ----                                   | ----                                                | ----                                           | ----                                                | ----                                    | ----                                             | ----                                  | ----                                                     |
  | RedisString = "+" string · "\r\n"                        |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+----------------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------------+----------------------------------------+-----------------------------------------------------+------------------------------------------------+-----------------------------------------------------+-----------------------------------------+--------------------------------------------------+---------------------------------------+----------------------------------------------------------+
  |                                                          | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                           | shift                                               | syntax error                                             | syntax error                           | syntax error                           | syntax error                                        | syntax error                                   | syntax error                                        | syntax error                            | syntax error                                     | syntax error                          | syntax error                                             |
  |                                                          | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                                   | ----                                                | ----                                                     | ----                                   | ----                                   | ----                                                | ----                                           | ----                                                | ----                                    | ----                                             | ----                                  | ----                                                     |
  | RedisError = "-" · string "\r\n"                         |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        | RedisError = "-" string · "\r\n"                    |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+----------------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------------+----------------------------------------+-----------------------------------------------------+------------------------------------------------+-----------------------------------------------------+-----------------------------------------+--------------------------------------------------+---------------------------------------+----------------------------------------------------------+
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | shift                                                    |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                           | syntax error                                        | reduce 3 to RedisError                                   | syntax error                           | syntax error                           | syntax error                                        | syntax error                                   | syntax error                                        | syntax error                            | syntax error                                     | syntax error                          | syntax error                                             |
  |                                                          | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                                   | ----                                                | ----                                                     | ----                                   | ----                                   | ----                                                | ----                                           | ----                                                | ----                                    | ----                                             | ----                                  | ----                                                     |
  | RedisError = "-" string · "\r\n"                         |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+----------------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------------+----------------------------------------+-----------------------------------------------------+------------------------------------------------+-----------------------------------------------------+-----------------------------------------+--------------------------------------------------+---------------------------------------+----------------------------------------------------------+
  |                                                          | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                           | syntax error                                        | syntax error                                             | syntax error                           | syntax error                           | shift                                               | shift                                          | syntax error                                        | syntax error                            | syntax error                                     | syntax error                          | syntax error                                             |
  | RedisInt = ":" · number "\r\n"                           | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                                   | ----                                                | ----                                                     | ----                                   | ----                                   | ----                                                | ----                                           | ----                                                | ----                                    | ----                                             | ----                                  | ----                                                     |
  | RedisInt = ":" · "0" "\r\n"                              |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        | RedisInt = ":" number · "\r\n"                      | RedisInt = ":" "0" · "\r\n"                    |                                                     |                                         |                                                  |                                       |                                                          |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+----------------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------------+----------------------------------------+-----------------------------------------------------+------------------------------------------------+-----------------------------------------------------+-----------------------------------------+--------------------------------------------------+---------------------------------------+----------------------------------------------------------+
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | shift                                                    |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                           | syntax error                                        | reduce 3 to RedisInt                                     | syntax error                           | syntax error                           | syntax error                                        | syntax error                                   | syntax error                                        | syntax error                            | syntax error                                     | syntax error                          | syntax error                                             |
  |                                                          | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                                   | ----                                                | ----                                                     | ----                                   | ----                                   | ----                                                | ----                                           | ----                                                | ----                                    | ----                                             | ----                                  | ----                                                     |
  | RedisInt = ":" number · "\r\n"                           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+----------------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------------+----------------------------------------+-----------------------------------------------------+------------------------------------------------+-----------------------------------------------------+-----------------------------------------+--------------------------------------------------+---------------------------------------+----------------------------------------------------------+
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | shift                                                    |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                           | syntax error                                        | reduce 3 to RedisInt                                     | syntax error                           | syntax error                           | syntax error                                        | syntax error                                   | syntax error                                        | syntax error                            | syntax error                                     | syntax error                          | syntax error                                             |
  |                                                          | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                                   | ----                                                | ----                                                     | ----                                   | ----                                   | ----                                                | ----                                           | ----                                                | ----                                    | ----                                             | ----                                  | ----                                                     |
  | RedisInt = ":" "0" · "\r\n"                              |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+----------------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------------+----------------------------------------+-----------------------------------------------------+------------------------------------------------+-----------------------------------------------------+-----------------------------------------+--------------------------------------------------+---------------------------------------+----------------------------------------------------------+
  | RedisBulkString = "$" · number "\r\n" string "\r\n"      | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                           | syntax error                                        | syntax error                                             | syntax error                           | syntax error                           | shift                                               | shift                                          | syntax error                                        | shift                                   | syntax error                                     | syntax error                          | syntax error                                             |
  | RedisEmptyBulkString = "$" · "0" "\r\n" "\r\n"           | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                                   | ----                                                | ----                                                     | ----                                   | ----                                   | ----                                                | ----                                           | ----                                                | ----                                    | ----                                             | ----                                  | ----                                                     |
  | RedisNullBulkString = "$" · "-1" "\r\n"                  |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        | RedisBulkString = "$" number · "\r\n" string "\r\n" | RedisEmptyBulkString = "$" "0" · "\r\n" "\r\n" |                                                     | RedisNullBulkString = "$" "-1" · "\r\n" |                                                  |                                       |                                                          |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+----------------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------------+----------------------------------------+-----------------------------------------------------+------------------------------------------------+-----------------------------------------------------+-----------------------------------------+--------------------------------------------------+---------------------------------------+----------------------------------------------------------+
  |                                                          | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                           | syntax error                                        | shift                                                    | syntax error                           | syntax error                           | syntax error                                        | syntax error                                   | syntax error                                        | syntax error                            | syntax error                                     | syntax error                          | syntax error                                             |
  |                                                          | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                                   | ----                                                | ----                                                     | ----                                   | ----                                   | ----                                                | ----                                           | ----                                                | ----                                    | ----                                             | ----                                  | ----                                                     |
  | RedisBulkString = "$" number · "\r\n" string "\r\n"      |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | RedisBulkString = "$" number "\r\n" · string "\r\n"      |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+----------------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------------+----------------------------------------+-----------------------------------------------------+------------------------------------------------+-----------------------------------------------------+-----------------------------------------+--------------------------------------------------+---------------------------------------+----------------------------------------------------------+
  |                                                          | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                           | shift                                               | syntax error                                             | syntax error                           | syntax error                           | syntax error                                        | syntax error                                   | syntax error                                        | syntax error                            | syntax error                                     | syntax error                          | syntax error                                             |
  |                                                          | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                                   | ----                                                | ----                                                     | ----                                   | ----                                   | ----                                                | ----                                           | ----                                                | ----                                    | ----                                             | ----                                  | ----                                                     |
  | RedisBulkString = "$" number "\r\n" · string "\r\n"      |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        | RedisBulkString = "$" number "\r\n" string · "\r\n" |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+----------------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------------+----------------------------------------+-----------------------------------------------------+------------------------------------------------+-----------------------------------------------------+-----------------------------------------+--------------------------------------------------+---------------------------------------+----------------------------------------------------------+
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | shift                                                    |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                           | syntax error                                        | reduce 5 to RedisBulkString                              | syntax error                           | syntax error                           | syntax error                                        | syntax error                                   | syntax error                                        | syntax error                            | syntax error                                     | syntax error                          | syntax error                                             |
  |                                                          | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                                   | ----                                                | ----                                                     | ----                                   | ----                                   | ----                                                | ----                                           | ----                                                | ----                                    | ----                                             | ----                                  | ----                                                     |
  | RedisBulkString = "$" number "\r\n" string · "\r\n"      |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+----------------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------------+----------------------------------------+-----------------------------------------------------+------------------------------------------------+-----------------------------------------------------+-----------------------------------------+--------------------------------------------------+---------------------------------------+----------------------------------------------------------+
  |                                                          | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                           | syntax error                                        | shift                                                    | syntax error                           | syntax error                           | syntax error                                        | syntax error                                   | syntax error                                        | syntax error                            | syntax error                                     | syntax error                          | syntax error                                             |
  |                                                          | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                                   | ----                                                | ----                                                     | ----                                   | ----                                   | ----                                                | ----                                           | ----                                                | ----                                    | ----                                             | ----                                  | ----                                                     |
  | RedisEmptyBulkString = "$" "0" · "\r\n" "\r\n"           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | RedisEmptyBulkString = "$" "0" "\r\n" · "\r\n"           |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+----------------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------------+----------------------------------------+-----------------------------------------------------+------------------------------------------------+-----------------------------------------------------+-----------------------------------------+--------------------------------------------------+---------------------------------------+----------------------------------------------------------+
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | shift                                                    |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                           | syntax error                                        | reduce 4 to RedisEmptyBulkString                         | syntax error                           | syntax error                           | syntax error                                        | syntax error                                   | syntax error                                        | syntax error                            | syntax error                                     | syntax error                          | syntax error                                             |
  |                                                          | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                                   | ----                                                | ----                                                     | ----                                   | ----                                   | ----                                                | ----                                           | ----                                                | ----                                    | ----                                             | ----                                  | ----                                                     |
  | RedisEmptyBulkString = "$" "0" "\r\n" · "\r\n"           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+----------------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------------+----------------------------------------+-----------------------------------------------------+------------------------------------------------+-----------------------------------------------------+-----------------------------------------+--------------------------------------------------+---------------------------------------+----------------------------------------------------------+
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | shift                                                    |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                           | syntax error                                        | reduce 3 to RedisNullBulkString                          | syntax error                           | syntax error                           | syntax error                                        | syntax error                                   | syntax error                                        | syntax error                            | syntax error                                     | syntax error                          | syntax error                                             |
  |                                                          | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                                   | ----                                                | ----                                                     | ----                                   | ----                                   | ----                                                | ----                                           | ----                                                | ----                                    | ----                                             | ----                                  | ----                                                     |
  | RedisNullBulkString = "$" "-1" · "\r\n"                  |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+----------------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------------+----------------------------------------+-----------------------------------------------------+------------------------------------------------+-----------------------------------------------------+-----------------------------------------+--------------------------------------------------+---------------------------------------+----------------------------------------------------------+
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        | shift                                               |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisArray = "*" · number "\r\n" RedisArrayItems         | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                           | syntax error                                        | syntax error                                             | syntax error                           | syntax error                           | push array length                                   | shift                                          | syntax error                                        | shift                                   | syntax error                                     | syntax error                          | syntax error                                             |
  | RedisArray = "*" · "0" "\r\n"                            | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                                   | ----                                                | ----                                                     | ----                                   | ----                                   | ----                                                | ----                                           | ----                                                | ----                                    | ----                                             | ----                                  | ----                                                     |
  | RedisNullArray = "*" · "-1" "\r\n"                       |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        | RedisArray = "*" number · "\r\n" RedisArrayItems    | RedisArray = "*" "0" · "\r\n"                  |                                                     | RedisNullArray = "*" "-1" · "\r\n"      |                                                  |                                       |                                                          |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+----------------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------------+----------------------------------------+-----------------------------------------------------+------------------------------------------------+-----------------------------------------------------+-----------------------------------------+--------------------------------------------------+---------------------------------------+----------------------------------------------------------+
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | shift                                                    |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | ----                                                     |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | RedisArray = "*" number "\r\n" · RedisArrayItems         |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | RedisArrayItems = · RedisArrayItems RedisString          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | RedisArrayItems = · RedisArrayItems RedisError           |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | RedisArrayItems = · RedisArrayItems RedisInt             |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | RedisArrayItems = · RedisArrayItems RedisBulkString      |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | RedisArrayItems = · RedisArrayItems RedisEmptyBulkString |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | RedisArrayItems = · RedisArrayItems RedisNullBulkString  |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | RedisArrayItems = · RedisArrayItems RedisArray           |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | RedisArrayItems = · RedisArrayItems RedisNullArray       |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | RedisArrayItems = · RedisString                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | RedisString = · "+" string "\r\n"                        |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | RedisArrayItems = · RedisError                           |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | RedisError = · "-" string "\r\n"                         |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | RedisArrayItems = · RedisInt                             |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | RedisInt = · ":" number "\r\n"                           |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | RedisInt = · ":" "0" "\r\n"                              |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | RedisArrayItems = · RedisBulkString                      |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | RedisBulkString = · "$" number "\r\n" string "\r\n"      |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | RedisArrayItems = · RedisEmptyBulkString                 |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | RedisEmptyBulkString = · "$" "0" "\r\n" "\r\n"           |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | RedisArrayItems = · RedisNullBulkString                  |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | RedisNullBulkString = · "$" "-1" "\r\n"                  |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | RedisArrayItems = · RedisArray                           |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | RedisArray = · "*" number "\r\n" RedisArrayItems         |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                           | syntax error                                        | RedisArray = · "*" "0" "\r\n"                            | syntax error                           | syntax error                           | syntax error                                        | syntax error                                   | syntax error                                        | syntax error                            | syntax error                                     | syntax error                          | syntax error                                             |
  |                                                          | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                                   | ----                                                | RedisArrayItems = · RedisNullArray                       | ----                                   | ----                                   | ----                                                | ----                                           | ----                                                | ----                                    | ----                                             | ----                                  | ----                                                     |
  | RedisArray = "*" number · "\r\n" RedisArrayItems         |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | RedisNullArray = · "*" "-1" "\r\n"                       |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+----------------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------------+----------------------------------------+-----------------------------------------------------+------------------------------------------------+-----------------------------------------------------+-----------------------------------------+--------------------------------------------------+---------------------------------------+----------------------------------------------------------+
  | RedisArray = "*" number "\r\n" · RedisArrayItems         |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisArrayItems = · RedisArrayItems RedisString          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisArrayItems = · RedisArrayItems RedisError           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisArrayItems = · RedisArrayItems RedisInt             |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisArrayItems = · RedisArrayItems RedisBulkString      |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisArrayItems = · RedisArrayItems RedisEmptyBulkString |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisArrayItems = · RedisArrayItems RedisNullBulkString  |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       | shift                                                    |
  | RedisArrayItems = · RedisArrayItems RedisArray           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       | ----                                                     |
  | RedisArrayItems = · RedisArrayItems RedisNullArray       |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       | RedisArray = "*" number "\r\n" RedisArrayItems ·         |
  | RedisArrayItems = · RedisString                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       | RedisArrayItems = RedisArrayItems · RedisString          |
  | RedisString = · "+" string "\r\n"                        |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       | RedisArrayItems = RedisArrayItems · RedisError           |
  | RedisArrayItems = · RedisError                           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       | RedisArrayItems = RedisArrayItems · RedisInt             |
  | RedisError = · "-" string "\r\n"                         |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       | RedisArrayItems = RedisArrayItems · RedisBulkString      |
  | RedisArrayItems = · RedisInt                             |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       | RedisArrayItems = RedisArrayItems · RedisEmptyBulkString |
  | RedisInt = · ":" number "\r\n"                           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       | RedisArrayItems = RedisArrayItems · RedisNullBulkString  |
  | RedisInt = · ":" "0" "\r\n"                              |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       | RedisArrayItems = RedisArrayItems · RedisArray           |
  | RedisArrayItems = · RedisBulkString                      |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       | RedisArrayItems = RedisArrayItems · RedisNullArray       |
  | RedisBulkString = · "$" number "\r\n" string "\r\n"      |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       | RedisString = · "+" string "\r\n"                        |
  | RedisArrayItems = · RedisEmptyBulkString                 |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       | RedisError = · "-" string "\r\n"                         |
  | RedisEmptyBulkString = · "$" "0" "\r\n" "\r\n"           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       | RedisInt = · ":" number "\r\n"                           |
  | RedisArrayItems = · RedisNullBulkString                  |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       | RedisInt = · ":" "0" "\r\n"                              |
  | RedisNullBulkString = · "$" "-1" "\r\n"                  |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       | RedisBulkString = · "$" number "\r\n" string "\r\n"      |
  | RedisArrayItems = · RedisArray                           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                | shift                                               |                                         | shift                                            | shift                                 | RedisEmptyBulkString = · "$" "0" "\r\n" "\r\n"           |
  | RedisArray = · "*" number "\r\n" RedisArrayItems         |                    | shift                       | shift                       | shift                       | shift                       | shift                       | shift                       | shift                       | shift                       |                                        |                                                     |                                                          |                                        | shift                                  |                                                     |                                                | ----                                                |                                         | ----                                             | reduce 4 to RedisArray                | RedisNullBulkString = · "$" "-1" "\r\n"                  |
  | RedisArray = · "*" "0" "\r\n"                            | syntax error       | reduce 1 to RedisArrayItems | reduce 1 to RedisArrayItems | reduce 1 to RedisArrayItems | reduce 1 to RedisArrayItems | reduce 1 to RedisArrayItems | reduce 1 to RedisArrayItems | reduce 1 to RedisArrayItems | reduce 1 to RedisArrayItems | shift                                  | syntax error                                        | syntax error                                             | shift                                  | ----                                   | syntax error                                        | syntax error                                   | RedisBulkString = "$" · number "\r\n" string "\r\n" | syntax error                            | RedisArray = "*" · number "\r\n" RedisArrayItems | pop array length                      | RedisArray = · "*" number "\r\n" RedisArrayItems         |
  | RedisArrayItems = · RedisNullArray                       | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                                   | ----                                                | ----                                                     | ----                                   | RedisInt = ":" · number "\r\n"         | ----                                                | ----                                           | RedisEmptyBulkString = "$" · "0" "\r\n" "\r\n"      | ----                                    | RedisArray = "*" · "0" "\r\n"                    | ----                                  | RedisArray = · "*" "0" "\r\n"                            |
  | RedisNullArray = · "*" "-1" "\r\n"                       |                    |                             |                             |                             |                             |                             |                             |                             |                             | RedisString = "+" · string "\r\n"      |                                                     |                                                          | RedisError = "-" · string "\r\n"       | RedisInt = ":" · "0" "\r\n"            |                                                     |                                                | RedisNullBulkString = "$" · "-1" "\r\n"             |                                         | RedisNullArray = "*" · "-1" "\r\n"               |                                       | RedisNullArray = · "*" "-1" "\r\n"                       |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+----------------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------------+----------------------------------------+-----------------------------------------------------+------------------------------------------------+-----------------------------------------------------+-----------------------------------------+--------------------------------------------------+---------------------------------------+----------------------------------------------------------+
  | RedisArray = "*" number "\r\n" RedisArrayItems ·         |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisArrayItems = RedisArrayItems · RedisString          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisArrayItems = RedisArrayItems · RedisError           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisArrayItems = RedisArrayItems · RedisInt             |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisArrayItems = RedisArrayItems · RedisBulkString      |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisArrayItems = RedisArrayItems · RedisEmptyBulkString |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisArrayItems = RedisArrayItems · RedisNullBulkString  |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisArrayItems = RedisArrayItems · RedisArray           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisArrayItems = RedisArrayItems · RedisNullArray       |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisString = · "+" string "\r\n"                        |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisError = · "-" string "\r\n"                         |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisInt = · ":" number "\r\n"                           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisInt = · ":" "0" "\r\n"                              |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisBulkString = · "$" number "\r\n" string "\r\n"      |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  | RedisEmptyBulkString = · "$" "0" "\r\n" "\r\n"           |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                | shift                                               |                                         | shift                                            |                                       |                                                          |
  | RedisNullBulkString = · "$" "-1" "\r\n"                  |                    | shift                       | shift                       | shift                       | shift                       | shift                       | shift                       | shift                       | shift                       |                                        |                                                     |                                                          |                                        | shift                                  |                                                     |                                                | ----                                                |                                         | ----                                             |                                       |                                                          |
  | RedisArray = · "*" number "\r\n" RedisArrayItems         | syntax error       | reduce 2 to RedisArrayItems | reduce 2 to RedisArrayItems | reduce 2 to RedisArrayItems | reduce 2 to RedisArrayItems | reduce 2 to RedisArrayItems | reduce 2 to RedisArrayItems | reduce 2 to RedisArrayItems | reduce 2 to RedisArrayItems | shift                                  | syntax error                                        | syntax error                                             | shift                                  | ----                                   | syntax error                                        | syntax error                                   | RedisBulkString = "$" · number "\r\n" string "\r\n" | syntax error                            | RedisArray = "*" · number "\r\n" RedisArrayItems | syntax error                          | syntax error                                             |
  | RedisArray = · "*" "0" "\r\n"                            | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                                   | ----                                                | ----                                                     | ----                                   | RedisInt = ":" · number "\r\n"         | ----                                                | ----                                           | RedisEmptyBulkString = "$" · "0" "\r\n" "\r\n"      | ----                                    | RedisArray = "*" · "0" "\r\n"                    | ----                                  | ----                                                     |
  | RedisNullArray = · "*" "-1" "\r\n"                       |                    |                             |                             |                             |                             |                             |                             |                             |                             | RedisString = "+" · string "\r\n"      |                                                     |                                                          | RedisError = "-" · string "\r\n"       | RedisInt = ":" · "0" "\r\n"            |                                                     |                                                | RedisNullBulkString = "$" · "-1" "\r\n"             |                                         | RedisNullArray = "*" · "-1" "\r\n"               |                                       |                                                          |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+----------------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------------+----------------------------------------+-----------------------------------------------------+------------------------------------------------+-----------------------------------------------------+-----------------------------------------+--------------------------------------------------+---------------------------------------+----------------------------------------------------------+
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | shift                                                    |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                           | syntax error                                        | reduce 3 to RedisArray                                   | syntax error                           | syntax error                           | syntax error                                        | syntax error                                   | syntax error                                        | syntax error                            | syntax error                                     | syntax error                          | syntax error                                             |
  |                                                          | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                                   | ----                                                | ----                                                     | ----                                   | ----                                   | ----                                                | ----                                           | ----                                                | ----                                    | ----                                             | ----                                  | ----                                                     |
  | RedisArray = "*" "0" · "\r\n"                            |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+----------------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------------+----------------------------------------+-----------------------------------------------------+------------------------------------------------+-----------------------------------------------------+-----------------------------------------+--------------------------------------------------+---------------------------------------+----------------------------------------------------------+
  |                                                          |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     | shift                                                    |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  |                                                          | syntax error       | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                | syntax error                           | syntax error                                        | reduce 3 to RedisNullArray                               | syntax error                           | syntax error                           | syntax error                                        | syntax error                                   | syntax error                                        | syntax error                            | syntax error                                     | syntax error                          | syntax error                                             |
  |                                                          | ----               | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                        | ----                                   | ----                                                | ----                                                     | ----                                   | ----                                   | ----                                                | ----                                           | ----                                                | ----                                    | ----                                             | ----                                  | ----                                                     |
  | RedisNullArray = "*" "-1" · "\r\n"                       |                    |                             |                             |                             |                             |                             |                             |                             |                             |                                        |                                                     |                                                          |                                        |                                        |                                                     |                                                |                                                     |                                         |                                                  |                                       |                                                          |
  +----------------------------------------------------------+--------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+-----------------------------+----------------------------------------+-----------------------------------------------------+----------------------------------------------------------+----------------------------------------+----------------------------------------+-----------------------------------------------------+------------------------------------------------+-----------------------------------------------------+-----------------------------------------+--------------------------------------------------+---------------------------------------+----------------------------------------------------------+
#+end_src
*** 数据定义
#+begin_src nim :noweb-ref syntax-context
  SyntaxTerminalType = enum
    stRedisValue, stRedisString, stRedisError, stRedisInt, stRedisNullBulkString, stRedisEmptyBulkString, stRedisBulkString, stRedisNullArray, stRedisArray, stPlus, stString, stCrLf, stMinus, stColon, stNumber, stDollar, stZero, stNegative1, stAsterisk, stRedisArrayItems

  SyntaxKind = enum
    skString, skNumber, skRedisValue, skRedisArrayItems, skEof

  SyntaxValue = ref object
    case kind: SyntaxKind
    of skString: str: string
    of skNumber: num: int
    of skRedisValue: val: RedisValue
    of skRedisArrayItems: items: seq[RedisValue]
    of skEof: eof: int

  SyntaxContext = ref object
    fsm: SyntaxStateMachine[SyntaxContext]
    target: SyntaxValue
    input: SyntaxValue
    input_type: SyntaxTerminalType
    state_stack: seq[int]
    value_stack: seq[(SyntaxTerminalType, SyntaxValue)]
    queue: Deque[(SyntaxTerminalType, SyntaxValue)]
    error: bool
    errmsg: string
    arrlen: seq[int]
    done: bool
#+end_src
*** 执行动作
#+begin_src nim :noweb-ref syntax-action
  proc shift[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.state_stack.add(ctx0.fsm.state)
    ctx0.value_stack.add((ctx0.input_type, ctx0.input))
    return ctx0

  proc reduce_1_to_target[T](ctx: T): T =
    var ctx0 = ctx
    var (_, value) = ctx0.value_stack.pop
    ctx0.fsm.state = ctx0.state_stack.pop
    ctx0.target = value
    return ctx0

  proc set_done[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.done = true
    return ctx0

  proc reduce_1_to_redisvalue[T](ctx: T): T =
    var ctx0 = ctx
    var (_, value) = ctx0.value_stack.pop
    ctx0.fsm.state = ctx0.state_stack.pop
    ctx0.queue.addLast((stRedisValue, value))
    return ctx0

  proc clear_done[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.done = false
    return ctx0

  proc syntax_error[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.error = true
    ctx0.errmsg = "Syntax Error"
    return ctx0

  proc reduce_3_to_redisstring[T](ctx: T): T =
    var ctx0 = ctx
    discard ctx0.value_stack.pop
    var (_, sv) = ctx0.value_stack.pop
    discard ctx0.value_stack.pop
    discard ctx0.state_stack.pop
    discard ctx0.state_stack.pop
    ctx0.fsm.state = ctx0.state_stack.pop
    ctx0.queue.addLast((stRedisString, SyntaxValue(kind: skRedisValue, val: RedisValue(kind: rkString, str: sv.str))))
    return ctx0

  proc reduce_3_to_rediserror[T](ctx: T): T =
    var ctx0 = ctx
    discard ctx0.value_stack.pop
    var (_, sv) = ctx0.value_stack.pop
    discard ctx0.value_stack.pop
    discard ctx0.state_stack.pop
    discard ctx0.state_stack.pop
    ctx0.fsm.state = ctx0.state_stack.pop
    ctx0.queue.addLast((stRedisError, SyntaxValue(kind: skRedisValue, val: RedisValue(kind: rkError, err: sv.str))))
    return ctx0

  proc reduce_3_to_redisint[T](ctx: T): T =
    var ctx0 = ctx
    discard ctx0.value_stack.pop
    var (_, sv) = ctx0.value_stack.pop
    discard ctx0.value_stack.pop
    discard ctx0.state_stack.pop
    discard ctx0.state_stack.pop
    ctx0.fsm.state = ctx0.state_stack.pop
    ctx0.queue.addLast((stRedisInt, SyntaxValue(kind: skRedisValue, val: RedisValue(kind: rkInteger, val: sv.num))))
    return ctx0

  proc reduce_5_to_redisbulkstring[T](ctx: T): T =
    var ctx0 = ctx
    discard ctx0.value_stack.pop
    var (_, sv1) = ctx0.value_stack.pop
    discard ctx0.value_stack.pop
    discard ctx0.value_stack.pop
    discard ctx0.value_stack.pop
    discard ctx0.state_stack.pop
    discard ctx0.state_stack.pop
    discard ctx0.state_stack.pop
    discard ctx0.state_stack.pop
    ctx0.fsm.state = ctx0.state_stack.pop
    ctx0.queue.addLast((stRedisBulkString, SyntaxValue(kind: skRedisValue, val: RedisValue(kind: rkBulkString, bulkstr: some(sv1.str)))))
    return ctx0

  proc reduce_4_to_redisemptybulkstring[T](ctx: T): T =
    var ctx0 = ctx
    discard ctx0.value_stack.pop
    discard ctx0.value_stack.pop
    discard ctx0.value_stack.pop
    discard ctx0.value_stack.pop
    discard ctx0.state_stack.pop
    discard ctx0.state_stack.pop
    discard ctx0.state_stack.pop
    ctx0.fsm.state = ctx0.state_stack.pop
    ctx0.queue.addLast((stRedisEmptyBulkString, SyntaxValue(kind: skRedisValue, val: RedisValue(kind: rkBulkString, bulkstr: some("")))))
    return ctx0

  proc reduce_3_to_redisnullbulkstring[T](ctx: T): T =
    var ctx0 = ctx
    discard ctx0.value_stack.pop
    discard ctx0.value_stack.pop
    discard ctx0.value_stack.pop
    discard ctx0.state_stack.pop
    discard ctx0.state_stack.pop
    var n = none(system.string)
    ctx0.fsm.state = ctx0.state_stack.pop
    ctx0.queue.addLast((stRedisNullBulkString, SyntaxValue(kind: skRedisValue, val: RedisValue(kind: rkBulkString, bulkstr: n))))
    return ctx0

  proc push_array_length[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.arrlen.add(ctx0.input.num)
    return ctx0

  proc reduce_1_to_redisarrayitems[T](ctx: T): T =
    var ctx0 = ctx
    var (_, item) = ctx0.value_stack.pop
    ctx0.fsm.state = ctx0.state_stack.pop
    var array = @[item.val]
    ctx0.queue.addLast((stRedisArrayItems, SyntaxValue(kind: skRedisArrayItems, items: array)))
    return ctx0

  proc reduce_4_to_redisarray[T](ctx: T): T =
    var ctx0 = ctx
    var (_, arrayitems) = ctx0.value_stack.pop
    discard ctx0.value_stack.pop
    discard ctx0.value_stack.pop
    discard ctx0.value_stack.pop
    discard ctx0.state_stack.pop
    discard ctx0.state_stack.pop
    discard ctx0.state_stack.pop
    ctx0.fsm.state = ctx0.state_stack.pop
    ctx0.queue.addLast((stRedisArray, SyntaxValue(kind: skRedisValue, val: RedisVAlue(kind: rkArray, array: some(arrayitems.items)))))
    return ctx0

  proc pop_array_length[T](ctx: T): T =
    var ctx0 = ctx
    discard ctx0.arrlen.pop
    return ctx0

  proc reduce_2_to_redisarrayitems[T](ctx: T): T =
    var ctx0 = ctx
    var (_, item) = ctx0.value_stack.pop
    var (sttype, array) = ctx0.value_stack.pop
    discard ctx0.state_stack.pop
    ctx0.fsm.state = ctx0.state_stack.pop
    array.items.add(item.val)
    ctx0.queue.addLast((sttype, array))
    return ctx0

  proc reduce_3_to_redisarray[T](ctx: T): T =
    var ctx0 = ctx
    discard ctx0.value_stack.pop
    discard ctx0.value_stack.pop
    discard ctx0.value_stack.pop
    discard ctx0.state_stack.pop
    discard ctx0.state_stack.pop
    ctx0.fsm.state = ctx0.state_stack.pop
    ctx0.queue.addLast((stRedisArray, SyntaxValue(kind: skRedisValue, val: RedisVAlue(kind: rkArray, array: some[seq[RedisValue]](@[])))))
    return ctx0

  proc reduce_3_to_redisnullarray[T](ctx: T): T =
    var ctx0 = ctx
    discard ctx0.value_stack.pop
    discard ctx0.value_stack.pop
    discard ctx0.value_stack.pop
    discard ctx0.state_stack.pop
    discard ctx0.state_stack.pop
    ctx0.fsm.state = ctx0.state_stack.pop
    ctx0.queue.addLast((stRedisNullArray, SyntaxValue(kind: skRedisValue, val: RedisValue(kind: rkArray, array: none(seq[RedisValue])))))
    return ctx0
#+end_src
*** 条件判断
#+begin_src nim :noweb-ref syntax-guard
  proc len_equals_to_number[T](ctx: T): bool =
    return len(ctx.input.items) == ctx.arrlen[len(ctx.arrlen) - 1]
#+end_src
* 接口定义
** 框架
#+begin_src nim :noweb-ref interface
  <<open>>

  <<open_async>>

  <<send>>

  <<recv>>

  <<key-value>>

  <<transaction>>

  <<hash>>

  <<list>>

  <<sets>>

  <<stream>>

  <<sorted-set>>
#+end_src
** open
#+begin_src nim :noweb-ref open
  proc open*(host = "localhost", port = 6379.Port, timeout=0): Redis =
    ## Open a connection to a redis server.
    result = Redis(socket: newSocket(buffered = false))
    result.timeout = timeout
    result.socket.connect(host, port)
    result.connected = true
    result.pipeline = Pipeline(
      buffer: "",
      enabled: false,
    )

    result.syntax_action_delegate = SyntaxActionDelegate[SyntaxContext](
      shift: shift[SyntaxContext],
      reduce_1_to_target: reduce_1_to_target[SyntaxContext],
      set_done: set_done[SyntaxContext],
      reduce_1_to_redisvalue: reduce_1_to_redisvalue[SyntaxContext],
      clear_done: clear_done[SyntaxContext],
      syntax_error: syntax_error[SyntaxContext],
      reduce_3_to_redisstring: reduce_3_to_redisstring[SyntaxContext],
      reduce_3_to_rediserror: reduce_3_to_rediserror[SyntaxContext],
      reduce_3_to_redisint: reduce_3_to_redisint[SyntaxContext],
      reduce_5_to_redisbulkstring: reduce_5_to_redisbulkstring[SyntaxContext],
      reduce_4_to_redisemptybulkstring: reduce_4_to_redisemptybulkstring[SyntaxContext],
      reduce_3_to_redisnullbulkstring: reduce_3_to_redisnullbulkstring[SyntaxContext],
      push_array_length: push_array_length[SyntaxContext],
      reduce_1_to_redisarrayitems: reduce_1_to_redisarrayitems[SyntaxContext],
      reduce_4_to_redisarray: reduce_4_to_redisarray[SyntaxContext],
      pop_array_length: pop_array_length[SyntaxContext],
      reduce_2_to_redisarrayitems: reduce_2_to_redisarrayitems[SyntaxContext],
      reduce_3_to_redisarray: reduce_3_to_redisarray[SyntaxContext],
      reduce_3_to_redisnullarray: reduce_3_to_redisnullarray[SyntaxContext],
    )
    result.syntax_guard_delegate = SyntaxGuardDelegate[SyntaxContext](
      len_equals_to_number: len_equals_to_number[SyntaxContext],
    )

    result.lexer_action_delegate = LexerActionDelegate[LexerContext](
      output_plus: output_plus[LexerContext],
      output_colon: output_colon[LexerContext],
      output_dollar: output_dollar[LexerContext],
      output_asterisk: output_asterisk[LexerContext],
      add_to_number: add_to_number[LexerContext],
      add_to_string: add_to_string[LexerContext],
      output_minus: output_minus[LexerContext],
      add_minus_to_number: add_minus_to_number[LexerContext],
      move_number_to_string: move_number_to_string[LexerContext],
      output_number: output_number[LexerContext],
      output_string: output_string[LexerContext],
      output_crlf: output_crlf[LexerContext],
      set_string_length: set_string_length[LexerContext],
      clear_string_length: clear_string_length[LexerContext],
    )
    result.lexer_guard_delegate = LexerGuardDelegate[LexerContext](
      isnumber: isnumber[LexerContext],
      cr_and_len_equals_strlen: cr_and_len_equals_strlen[LexerContext],
      lf_and_strlen_is_negative_1: lf_and_strlen_is_negative_1[LexerContext],
    )
#+end_src
** open_async
#+begin_src nim :noweb-ref open_async
  proc open_async*(host = "localhost", port = 6379.Port): Future[AsyncRedis] {.async.} =
    ## Open an asynchronous connection to a redis server.
    result = AsyncRedis(socket: newAsyncSocket(buffered = false), send_queue: initDeque[Future[void]]())
    await result.socket.connect(host, port)
    result.connected = true
    result.pipeline = Pipeline(
      buffer: "",
      enabled: false,
    )

    result.syntax_action_delegate = SyntaxActionDelegate[SyntaxContext](
      shift: shift[SyntaxContext],
      reduce_1_to_target: reduce_1_to_target[SyntaxContext],
      set_done: set_done[SyntaxContext],
      reduce_1_to_redisvalue: reduce_1_to_redisvalue[SyntaxContext],
      clear_done: clear_done[SyntaxContext],
      syntax_error: syntax_error[SyntaxContext],
      reduce_3_to_redisstring: reduce_3_to_redisstring[SyntaxContext],
      reduce_3_to_rediserror: reduce_3_to_rediserror[SyntaxContext],
      reduce_3_to_redisint: reduce_3_to_redisint[SyntaxContext],
      reduce_5_to_redisbulkstring: reduce_5_to_redisbulkstring[SyntaxContext],
      reduce_4_to_redisemptybulkstring: reduce_4_to_redisemptybulkstring[SyntaxContext],
      reduce_3_to_redisnullbulkstring: reduce_3_to_redisnullbulkstring[SyntaxContext],
      push_array_length: push_array_length[SyntaxContext],
      reduce_1_to_redisarrayitems: reduce_1_to_redisarrayitems[SyntaxContext],
      reduce_4_to_redisarray: reduce_4_to_redisarray[SyntaxContext],
      pop_array_length: pop_array_length[SyntaxContext],
      reduce_2_to_redisarrayitems: reduce_2_to_redisarrayitems[SyntaxContext],
      reduce_3_to_redisarray: reduce_3_to_redisarray[SyntaxContext],
      reduce_3_to_redisnullarray: reduce_3_to_redisnullarray[SyntaxContext],
    )
    result.syntax_guard_delegate = SyntaxGuardDelegate[SyntaxContext](
      len_equals_to_number: len_equals_to_number[SyntaxContext],
    )

    result.lexer_action_delegate = LexerActionDelegate[LexerContext](
      output_plus: output_plus[LexerContext],
      output_colon: output_colon[LexerContext],
      output_dollar: output_dollar[LexerContext],
      output_asterisk: output_asterisk[LexerContext],
      add_to_number: add_to_number[LexerContext],
      add_to_string: add_to_string[LexerContext],
      output_minus: output_minus[LexerContext],
      add_minus_to_number: add_minus_to_number[LexerContext],
      move_number_to_string: move_number_to_string[LexerContext],
      output_number: output_number[LexerContext],
      output_string: output_string[LexerContext],
      output_crlf: output_crlf[LexerContext],
      set_string_length: set_string_length[LexerContext],
      clear_string_length: clear_string_length[LexerContext],
    )
    result.lexer_guard_delegate = LexerGuardDelegate[LexerContext](
      isnumber: isnumber[LexerContext],
      cr_and_len_equals_strlen: cr_and_len_equals_strlen[LexerContext],
      lf_and_strlen_is_negative_1: lf_and_strlen_is_negative_1[LexerContext],
    )
#+end_src
** send
#+begin_src nim :noweb-ref send
  proc send(this: Redis | AsyncRedis, cmd: RedisValue): Future[void] {.multisync.} =
    ## execute command `command` with arguments seq `args`

    let data = encode(cmd)
    if this.pipeline.enabled:
      this.pipeline.buffer.add(data)
    else:
      when this is Redis:
        this.socket.send(data)
      else:
        if this.current_command.isSome:
          let sendfut = newFuture[void]("redis.send")
          this.send_queue.addLast(sendfut)
          await sendfut
        this.current_command = some(data)
        await this.socket.send(data)

  proc send(this: Redis | AsyncRedis, command: string): Future[void] {.multisync.} =
    var parameters = newSeq[RedisValue](1)
    parameters[0] = RedisValue(kind: rkBulkString, bulkstr: some(command))
    let cmd = RedisValue(kind: rkArray, array: some(parameters))

    await send(this, cmd)

  proc send(this: Redis | AsyncRedis, command: string, arg0: string): Future[void] {.multisync.} =
    ## execute command `command` with arguments seq `args`

    var parameters = newSeq[RedisValue](2)
    parameters[0] = RedisValue(kind: rkBulkString, bulkstr: some(command))
    parameters[1] = RedisValue(kind: rkBulkString, bulkstr: some(arg0))
    let cmd = RedisValue(kind: rkArray, array: some(parameters))

    await send(this, cmd)

  proc send(this: Redis | AsyncRedis, command: string, arg0: string, arg1: string): Future[void] {.multisync.} =
    ## execute command `command` with arguments seq `args`

    var parameters = newSeq[RedisValue](3)
    parameters[0] = RedisValue(kind: rkBulkString, bulkstr: some(command))
    parameters[1] = RedisValue(kind: rkBulkString, bulkstr: some(arg0))
    parameters[2] = RedisValue(kind: rkBulkString, bulkstr: some(arg1))
    let cmd = RedisValue(kind: rkArray, array: some(parameters))

    await send(this, cmd)

  proc send(this: Redis | AsyncRedis, command: string, arg0: string, arg1: string, arg2: string): Future[void] {.multisync.} =
    ## execute command `command` with arguments seq `args`

    var parameters = newSeq[RedisValue](4)
    parameters[0] = RedisValue(kind: rkBulkString, bulkstr: some(command))
    parameters[1] = RedisValue(kind: rkBulkString, bulkstr: some(arg0))
    parameters[2] = RedisValue(kind: rkBulkString, bulkstr: some(arg1))
    parameters[3] = RedisValue(kind: rkBulkString, bulkstr: some(arg2))
    let cmd = RedisValue(kind: rkArray, array: some(parameters))

    await send(this, cmd)

  proc send(this: Redis | AsyncRedis, command: string, arg0: string, arg1: string, arg2: string, arg3: string): Future[void] {.multisync.} =
    ## execute command `command` with arguments seq `args`

    var parameters = newSeq[RedisValue](5)
    parameters[0] = RedisValue(kind: rkBulkString, bulkstr: some(command))
    parameters[1] = RedisValue(kind: rkBulkString, bulkstr: some(arg0))
    parameters[2] = RedisValue(kind: rkBulkString, bulkstr: some(arg1))
    parameters[3] = RedisValue(kind: rkBulkString, bulkstr: some(arg2))
    parameters[4] = RedisValue(kind: rkBulkString, bulkstr: some(arg3))
    let cmd = RedisValue(kind: rkArray, array: some(parameters))

    await send(this, cmd)

  proc send(this: Redis | AsyncRedis, command: string, args: seq[string]): Future[void] {.multisync.} =
    ## execute command `command` with arguments seq `args`

    var parameters = newSeq[RedisValue](len(args) + 1)
    parameters[0] = RedisValue(kind: rkBulkString, bulkstr: some(command))
    for idx in 1..len(args):
      parameters[idx] = RedisValue(kind: rkBulkString, bulkstr: some(args[idx - 1]))
    let cmd = RedisValue(kind: rkArray, array: some(parameters))

    await send(this, cmd)
#+end_src
** recv
#+begin_src nim :noweb-ref recv
  proc recv(this: Redis | AsyncRedis): Future[RedisValue] {.multisync.} =
    if not this.pipeline.enabled:
      <<init-fsm>>

      when this is Redis:
        var timeout = -1
        if this.timeout != 0:
          timeout = this.timeout
        while lctx.sctx.done == false:
          let response = this.socket.recv(1024, timeout = timeout)
          if response == "":
            raise newException(RedisError, "Server closed connection prematurely")
          <<execute-fsm>>
        (lfsm, lctx) = eof[LexerContext](lfsm, lctx)
        return lctx.sctx.target.val
      else:
        while lctx.sctx.done == false:
          let response = await this.socket.recv(1024)
          if response == "":
            raise newException(RedisError, "Server closed connection prematurely")
          <<execute-fsm>>
        (lfsm, lctx) = eof[LexerContext](lfsm, lctx)
        result = lctx.sctx.target.val
        this.current_command = none(string)
        if len(this.send_queue) > 0:
          let fut = this.send_queue.popFirst
          fut.complete
    else:
      return RedisValue(kind: rkBulkString, bulkstr: none(string))
#+end_src
*** 初始化状态机
#+begin_src nim :noweb-ref init-fsm
  var sfsm = newSyntaxStateMachine[SyntaxContext](this.syntax_action_delegate, this.syntax_guard_delegate)
  var sctx: SyntaxContext = new(SyntaxContext)
  sctx.fsm = sfsm
  sctx.state_stack = @[]
  sctx.value_stack = @[]
  sctx.queue = initDeque[(SyntaxTerminalType, SyntaxValue)]()
  sctx.error = false
  sctx.arrlen = @[]
  sctx.done = false

  var lctx: LexerContext = new(LexerContext)
  lctx.num = ""
  lctx.str = ""
  lctx.strlen = 0
  lctx.sfsm = sfsm
  lctx.sctx = sctx
  var lfsm = newLexerStateMachine[LexerContext](this.lexer_action_delegate, this.lexer_guard_delegate)
#+end_src
*** 执行状态机
#+begin_src nim :noweb-ref execute-fsm
  for ch in response:
    lctx.input = ch
    (lfsm, lctx) = input[LexerContext](lfsm, lctx, ch)
#+end_src
** key/value
*** 框架
#+begin_src nim :noweb-ref key-value
  <<decr>>

  <<decrby>>

  <<del>>

  <<exists>>

  <<expire>>

  <<get>>

  <<incr>>

  <<incrby>>

  <<rename>>

  <<set>>

  <<setex>>
#+end_src
*** decr
#+begin_src nim :noweb-ref decr
  proc decr*(redis: Redis | AsyncRedis, key: string): Future[int] {.multisync.} =
    ## Decrements the number stored at key by one.
    await redis.send("DECR", key)
    let resp = await redis.recv
    result = resp.toInt
#+end_src
*** decrby
#+begin_src nim :noweb-ref decrby
  proc decrby*(redis: Redis | AsyncRedis, key: string, decrement: int): Future[int] {.multisync.} =
    ## Decrements the number stored at key by decrement.
    await redis.send("DECRBY", @[key, $decrement])
    let resp = await redis.recv
    result = resp.toInt
#+end_src
*** del
#+begin_src nim :noweb-ref del
  proc del*(redis: Redis | AsyncRedis, key: string): Future[bool] {.multisync.} =
    ## Removes the specified keys. A key is ignored if it does not exist.
    await redis.send("DEL", key)
    let resp = await redis.recv
    if resp.toInt == 1:
      result = true
    else:
      result = false

  proc del*(redis: Redis | AsyncRedis, keys: seq[string]): Future[uint32] {.multisync.} =
    ## Removes the specified keys. A key is ignored if it does not exist.
    await redis.send("DEL", keys)
    let resp = await redis.recv
    result = cast[uint32](resp.toInt)
#+end_src
*** exists
#+begin_src nim :noweb-ref exists
  proc exists*(redis: Redis | AsyncRedis, key: string): Future[bool] {.multisync.} =
    ## Returns if key exists.
    await redis.send("EXISTS", key)
    let resp = await redis.recv
    if resp.toInt == 1:
      result = true
    else:
      result = false

  proc exists*(redis: Redis | AsyncRedis, keys: seq[string]): Future[uint32] {.multisync.} =
    ## Returns if key exists.
    await redis.send("EXISTS", keys)
    let resp = await redis.recv
    result = cast[uint32](resp.toInt)
#+end_src
*** expire
#+begin_src nim :noweb-ref expire
  proc expire*(redis: Redis | AsyncRedis, key: string, timeout: uint32): Future[bool] {.multisync.} =
    ## Get the value of key
    await redis.send("EXPIRE", key, $timeout)
    let resp = await redis.recv
    if resp.toInt == 1:
      result = true
    else:
      result = false
#+end_src
*** get
#+begin_src nim :noweb-ref get
  proc get*(redis: Redis | AsyncRedis, key: string): Future[Option[string]] {.multisync.} =
    ## Get the value of key
    await redis.send("GET", key)
    let resp = await redis.recv
    result = resp.toString
#+end_src
*** incr
#+begin_src nim :noweb-ref incr
  proc incr*(redis: Redis | AsyncRedis, key: string): Future[int] {.multisync.} =
    ## Increments the number stored at key by one.
    await redis.send("INCR", key)
    let resp = await redis.recv
    result = resp.toInt
#+end_src
*** incrby
#+begin_src nim :noweb-ref incrby
  proc incrby*(redis: Redis | AsyncRedis, key: string, increment: int): Future[int] {.multisync.} =
    ## Increments the number stored at key by increment.
    await redis.send("INCRBY", @[key, $increment])
    let resp = await redis.recv
    result = resp.toInt
#+end_src
*** rename
#+begin_src nim :noweb-ref rename
  proc rename*(redis: Redis | AsyncRedis, key: string, newkey: string): Future[bool] {.multisync.} =
    ## Renames key to newkey. It returns an error when key does not exist.
    await redis.send("RENAME", @[key, newkey])
    let
      resp = await redis.recv
      str = resp.toString
    if str.isSome and str.get == "OK":
      result = true
    else:
      result = false
#+end_src
*** set
#+begin_src nim :noweb-ref set
  proc set*(redis: Redis | AsyncRedis, key: string, value: string): Future[bool] {.multisync.} =
    ## Set key to hold the string value.
    await redis.send("SET", key, value)
    let resp = await redis.recv
    let str = resp.toString
    if str.isSome and str.get == "OK":
      result = true
    else:
      result = false
#+end_src
*** setex
#+begin_src nim :noweb-ref setex
  proc setex*(redis: Redis | AsyncRedis, key: string, value: string, timeout: uint32): Future[bool] {.multisync.} =
    ## Set key to hold the string value and set key to timeout after a given number of seconds.
    await redis.send("SET", key, value, "EX", $timeout)
    let resp = await redis.recv
    let str = resp.toString
    if str.isSome and str.get == "OK":
      result = true
    else:
      result = false
#+end_src
** transaction
*** 框架
#+begin_src nim :noweb-ref transaction
  <<multi>>

  <<exec>>

  <<discard-multi>>
#+end_src
*** multi
#+begin_src nim :noweb-ref multi
  proc multi*(redis: Redis | AsyncRedis): Future[bool] {.multisync.} =
    ## Marks the start of a transaction block.
    redis.pipeline.enabled = true
    await redis.send("MULTI")
    result = true
#+end_src
*** exec
#+begin_src nim :noweb-ref exec
  proc exec*(redis: Redis | AsyncRedis): Future[seq[RedisValue]] {.multisync.} =
    ## Executes all previously queued commands in a transaction and
    ## restores the connection state to normal.
    await redis.send("EXEC")
    if redis.pipeline.buffer.len > 0:
      let data = redis.pipeline.buffer
      when redis is Redis:
        redis.socket.send(data)
      else:
        if redis.current_command.isSome:
          let sendfut = newFuture[void]("redis.send")
          redis.send_queue.addLast(sendfut)
          await sendfut
        redis.current_command = some(data)
        await redis.socket.send(data)
    redis.pipeline.buffer = ""
    redis.pipeline.enabled = false
    let resp = await redis.recv
    result = resp.toArray
#+end_src
*** discard_multi
#+begin_src nim :noweb-ref discard-multi
  proc discard_multi*(redis: Redis | AsyncRedis): Future[bool] {.multisync.} =
    ## Discard all commands issued after MULTI
    redis.pipeline.enabled = false
    redis.pipeline.buffer = ""
    result = true
#+end_src
** hash
*** 框架
#+begin_src nim :noweb-ref hash
  <<hdel>>

  <<hget>>

  <<hincrby>>

  <<hkeys>>

  <<hlen>>

  <<hmget>>

  <<hmset>>

  <<hset>>

  <<hvals>>
#+end_src
*** hdel
#+begin_src nim :noweb-ref hdel
  proc hdel*(redis: Redis | AsyncRedis, key: string, fields: seq[string]): Future[int] {.multisync.} =
    ## Removes the specified fields from the hash stored at key.
    await redis.send("HDEL", concat(@[key], fields))
    let resp = await redis.recv
    result = resp.toInt
#+end_src
*** hget
#+begin_src nim :noweb-ref hget
  proc hget*(redis: Redis | AsyncRedis, key: string, field: string): Future[Option[string]] {.multisync.} =
    ## Returns the value associated with field in the hash stored at key.
    await redis.send("HGET", key, field)
    let resp = await redis.recv
    result = resp.toString
#+end_src
*** hincrby
#+begin_src nim :noweb-ref hincrby
  proc hincrby*(redis: Redis | AsyncRedis, key: string, field: string, increment: int): Future[int] {.multisync.} =
    ## Increments the number stored at field in the hash stored at key by increment.
    await redis.send("HINCRBY", key, field, $increment)
    let resp = await redis.recv
    result = resp.toInt
#+end_src
*** hkeys
#+begin_src nim :noweb-ref hkeys
  proc hkeys*(redis: Redis | AsyncRedis, key: string): Future[seq[string]] {.multisync.} =
    ## Returns all field names in the hash stored at key.
    await redis.send("HKEYS", key)
    let resp = await redis.recv
    result = resp.toStringArray
#+end_src
*** hlen
#+begin_src nim :noweb-ref hlen
  proc hlen*(redis: Redis | AsyncRedis, key: string): Future[uint32] {.multisync.} =
    ## Returns the number of fields contained in the hash stored at key.
    await redis.send("HLEN", key)
    let resp = await redis.recv
    result = cast[uint32](resp.toInt)
#+end_src
*** hmget
#+begin_src nim :noweb-ref hmget
  proc hmget*(redis: Redis | AsyncRedis, key: string, fields: seq[string]): Future[seq[Option[string]]] {.multisync.} =
    ## Returns the values associated with the specified fields in the hash stored at key.
    await redis.send("HMGET", concat(@[key], fields))
    let resp = await redis.recv
    result = resp.toOptionalStringArray
#+end_src
*** hmset
#+begin_src nim :noweb-ref hmset
  proc hmset*(redis: Redis | AsyncRedis, key: string, pairs: seq[(string, string)]): Future[bool] {.multisync.} =
    ## Sets the specified fields to their respective values in the hash stored at key.
    var args = @[key]
    for pair in pairs:
      args.add(pair[0])
      args.add(pair[1])
    await redis.send("HMSET", args)
    let resp = await redis.recv
    let str = resp.toString
    if str.isSome and str.get == "OK":
      result = true
    else:
      result = false
#+end_src
*** hset
#+begin_src nim :noweb-ref hset
  proc hset*(redis: Redis | AsyncRedis, key: string, field: string, value: string): Future[uint32] {.multisync.} =
    ## Sets field in the hash stored at key to value.
    await redis.send("HSET", key, field, value)
    let resp = await redis.recv
    result = cast[uint32](resp.toInt)
#+end_src
*** hvals
#+begin_src nim :noweb-ref hvals
  proc hvals*(redis: Redis | AsyncRedis, key: string): Future[seq[string]] {.multisync.} =
    ## Returns all values in the hash stored at key.
    await redis.send("HVALS", key)
    let resp = await redis.recv
    result = resp.toStringArray
#+end_src
** list
*** 框架
#+begin_src nim :noweb-ref list
  <<llen>>

  <<lpop>>

  <<lpush>>

  <<lrange>>

  <<lrem>>

  <<rpop>>

  <<rpush>>
#+end_src
*** llen
#+begin_src nim :noweb-ref llen
  proc llen*(redis: Redis | AsyncRedis, key: string): Future[uint32] {.multisync.} =
    ## Returns the length of the list stored at key.
    await redis.send("LLEN", key)
    let resp = await redis.recv
    result = cast[uint32](resp.toInt)
#+end_src
*** lpop
#+begin_src nim :noweb-ref lpop
  proc lpop*(redis: Redis | AsyncRedis, key: string): Future[Option[string]] {.multisync.} =
    ## Removes and returns the first element of the list stored at key.
    await redis.send("LPOP", key)
    let resp = await redis.recv
    result = resp.toString
#+end_src
*** lpush
#+begin_src nim :noweb-ref lpush
  proc lpush*(redis: Redis | AsyncRedis, key: string, fields: seq[string]): Future[uint32] {.multisync.} =
    ## Insert all the specified values at the head of the list stored at key.
    await redis.send("LPUSH", concat(@[key], fields))
    let resp = await redis.recv
    result = cast[uint32](resp.toInt)
#+end_src
*** lrange
#+begin_src nim :noweb-ref lrange
  proc lrange*(redis: Redis | AsyncRedis, key: string, start: int, stop: int): Future[seq[string]] {.multisync.} =
    ## Returns the specified elements of the list stored at key.
    await redis.send("LRANGE", key, $start, $stop)
    let resp = await redis.recv
    result = resp.toStringArray
#+end_src
*** lrem
#+begin_src nim :noweb-ref lrem
  proc lrem*(redis: Redis | AsyncRedis, key: string, value: string, count: int = 0): Future[uint32] {.multisync.} =
    ## Removes the first count occurrences of elements equal to value
    ## from the list stored at key. The count argument influences the
    ## operation in the following ways:
    ##
    ## count > 0: Remove elements equal to value moving from head to tail.
    ##
    ## count < 0: Remove elements equal to value moving from tail to head.
    ##
    ## count = 0: Remove all elements equal to value.
    ##
    ## Return the number of removed elements.
    await redis.send("LREM", key, $count, value)
    let resp = await redis.recv
    result = cast[uint32](resp.toInt)
#+end_src
*** rpop
#+begin_src nim :noweb-ref rpop
  proc rpop*(redis: Redis | AsyncRedis, key: string): Future[Option[string]] {.multisync.} =
    ## Removes and returns the last element of the list stored at key.
    await redis.send("RPOP", key)
    let resp = await redis.recv
    result = resp.toString
#+end_src
*** rpush
#+begin_src nim :noweb-ref rpush
  proc rpush*(redis: Redis | AsyncRedis, key: string, fields: seq[string]): Future[uint32] {.multisync.} =
    ## Insert all the specified values at the tail of the list stored at key.
    await redis.send("RPUSH", concat(@[key], fields))
    let resp = await redis.recv
    result = cast[uint32](resp.toInt)
#+end_src
** set
*** 框架
#+begin_src nim :noweb-ref sets
  <<sadd>>

  <<scard>>

  <<sismember>>

  <<smembers>>

  <<srem>>
#+end_src
*** sadd
#+begin_src nim :noweb-ref sadd
  proc sadd*(redis: Redis | AsyncRedis, key: string, members: seq[string]): Future[uint32] {.multisync.} =
    ## Add the specified members to the set stored at key. Specified
    ## members that are already a member of this set are ignored. If key
    ## does not exist, a new set is created before adding the specified
    ## members.
    ##
    ## The command returns the number of elements that were added to the
    ## set, not including all the elements already present into the set.
    await redis.send("SADD", concat(@[key], members))
    let resp = await redis.recv
    result = cast[uint32](resp.toInt)
#+end_src
*** scard
#+begin_src nim :noweb-ref scard
  proc scard*(redis: Redis | AsyncRedis, key: string): Future[uint32] {.multisync.} =
    ## Returns the set cardinality (number of elements) of the set
    ## stored at key.
    ##
    ## The command returns the cardinality (number of elements) of the
    ## set, or 0 if key does not exist.
    await redis.send("SCARD", key)
    let resp = await redis.recv
    result = cast[uint32](resp.toInt)
#+end_src
*** sismember
#+begin_src nim :noweb-ref sismember
  proc sismember*(redis: Redis | AsyncRedis, key: string, member: string): Future[bool] {.multisync.} =
    ## Returns if member is a member of the set stored at key.
    await redis.send("SISMEMBER", key, member)
    let resp = await redis.recv
    if resp.toInt == 1:
      result = true
    else:
      result = false
#+end_src
*** smembers
#+begin_src nim :noweb-ref smembers
  proc smembers*(redis: Redis | AsyncRedis, key: string): Future[seq[string]] {.multisync.} =
    ## Returns all the members of the set value stored at key.
    ##
    ## The command returns all elements of the set.
    await redis.send("SMEMBERS", key)
    let resp = await redis.recv
    result = resp.toStringArray
#+end_src
*** srem
#+begin_src nim :noweb-ref srem
  proc srem*(redis: Redis | AsyncRedis, key: string, members: seq[string]): Future[uint32] {.multisync.} =
    ## Remove the specified members from the set stored at
    ## key. Specified members that are not a member of this set are
    ## ignored.
    ##
    ## The command returns the number of members that were removed from
    ## the set, not including non existing members.
    await redis.send("SREM", concat(@[key], members))
    let resp = await redis.recv
    result = cast[uint32](resp.toInt)
#+end_src
** stream
*** 框架
#+begin_src nim :noweb-ref stream
  <<xack>>

  <<xadd>>

  <<xclaim>>

  <<xdel>>

  <<xgroup-create>>

  <<xgroup-setid>>

  <<xgroup-destroy>>

  <<xgroup-delconsumer>>

  <<xlen>>

  <<xpending>>

  <<xrange>>

  <<xread>>

  <<xreadgroup>>

  <<xrevrange>>

  <<xtrim>>
#+end_src
*** xack
#+begin_src nim :noweb-ref xack
  proc xack*(redis: Redis | AsyncRedis, key: string, group: string, ids: seq[string]): Future[uint32] {.multisync.} =
    ## The XACK command removes one or multiple messages from the
    ## pending entries list (PEL) of a stream consumer group. The
    ## command returns the number of messages successfully acknowledged.
    await redis.send("XACK", concat(@[key, group], ids))
    let resp = await redis.recv
    result = cast[uint32](resp.toInt)
#+end_src
*** xadd
#+begin_src nim :noweb-ref xadd
  proc xadd*(redis: Redis | AsyncRedis, key: string, pairs: seq[(string, string)], id: string = "*", maxlen: uint32 = 0): Future[Option[string]] {.multisync.} =
    ## Appends the specified stream entry to the stream at the specified
    ## key. If the key does not exist, as a side effect of running this
    ## command the key is created with a stream value. The command
    ## returns the ID of the added entry.
    var args = @[key]
    if maxlen != 0:
      args.add("MAXLEN")
      args.add("~")
      args.add($maxlen)
    args.add(id)
    for pair in pairs:
      args.add(pair[0])
      args.add(pair[1])
    await redis.send("XADD", args)
    let resp = await redis.recv
    result = resp.toString
#+end_src
*** xclaim
#+begin_src nim :noweb-ref xclaim
  proc xclaim*(redis: Redis | AsyncRedis, key: string, group: string, consumer: string, minidletime: uint32, ids: seq[string], idle: uint32 = 0, time: uint32 = 0, retrycount: uint32 = 0, force: bool = false): Future[seq[(string, TableRef[string, string])]] {.multisync.} =
    ## In the context of a stream consumer group, this command changes
    ## the ownership of a pending message, so that the new owner is the
    ## consumer specified as the command argument. The command returns
    ## all the messages successfully claimed, in the same format as
    ## XRANGE.
    var args = concat(@[key, group, consumer, $minidletime], ids)
    if idle != 0:
      args.add("IDLE")
      args.add($idle)
    if time != 0:
      args.add("TIME")
      args.add($time)
    if retrycount != 0:
      args.add("RETRYCOUNT")
      args.add($retrycount)
    if force:
      args.add("FORCE")
    await redis.send("XCLAIM", args)
    let resp = await redis.recv
    result = resp.toSequenceTupleTable
#+end_src
*** xdel
#+begin_src nim :noweb-ref xdel
  proc xdel*(redis: Redis | AsyncRedis, key: string, ids: seq[string]): Future[uint32] {.multisync.} =
    ## Removes the specified entries from a stream, and returns the
    ## number of entries deleted, that may be different from the number
    ## of IDs passed to the command in case certain IDs do not
    ## exist. The command return the number of entries actually deleted.
    await redis.send("XDEL", concat(@[key], ids))
    let resp = await redis.recv
    result = cast[uint32](resp.toInt)
#+end_src
*** xgroup_create
#+begin_src nim :noweb-ref xgroup-create
  proc xgroup_create*(redis: Redis | AsyncRedis, key: string, groupname: string, id: string = "$"): Future[bool] {.multisync.} =
    ## Create a new consumer group associated with a stream.
    await redis.send("XGROUP", "CREATE", key, groupname, id)
    let resp = await redis.recv
    let str = resp.toString
    if str.isSome and str.get == "OK":
      result = true
    else:
      result = false
#+end_src
*** xgroup_setid
#+begin_src nim :noweb-ref xgroup-setid
  proc xgroup_setid*(redis: Redis | AsyncRedis, key: string, groupname: string, id: string = "$"): Future[bool] {.multisync.} =
    ## Set the consumer group last delivered ID to something else.
    await redis.send("XGROUP", "SETID", key, groupname, id)
    let resp = await redis.recv
    let str = resp.toString
    if str.isSome and str.get == "OK":
      result = true
    else:
      result = false
#+end_src
*** xgroup_destroy
#+begin_src nim :noweb-ref xgroup-destroy
  proc xgroup_destroy*(redis: Redis | AsyncRedis, key: string, groupname: string): Future[uint32] {.multisync.} =
    ## Destroy a consumer group.
    await redis.send("XGROUP", "DESTROY", key, groupname)
    let resp = await redis.recv
    result = cast[uint32](resp.toInt)
#+end_src
*** xgroup_delconsumer
#+begin_src nim :noweb-ref xgroup-delconsumer
  proc xgroup_delconsumer*(redis: Redis | AsyncRedis, key: string, groupname: string, consumername: string): Future[uint32] {.multisync.} =
    ## Remove a specific consumer from a consumer group.
    await redis.send("XGROUP", "DELCONSUMER", key, groupname, consumername)
    let resp = await redis.recv
    result = cast[uint32](resp.toInt)
#+end_src
*** xlen
#+begin_src nim :noweb-ref xlen
  proc xlen*(redis: Redis | AsyncRedis, key: string): Future[uint32] {.multisync.} =
    ## Returns the number of entries inside a stream. If the specified
    ## key does not exist the command returns zero, as if the stream was
    ## empty.
    await redis.send("XLEN", key)
    let resp = await redis.recv
    result = cast[uint32](resp.toInt)
#+end_src
*** xpending
#+begin_src nim :noweb-ref xpending
  proc xpending*(redis: Redis | AsyncRedis, key: string, group: string): Future[(uint32, string, string, seq[(string, uint32)])] {.multisync.} =
    ## Fetching data from a stream via a consumer group, and not
    ## acknowledging such data, has the effect of creating pending
    ## entries.
    ##
    ## or each message four attributes are returned:
    ## 1. The ID of the message.
    ##
    ## 2. The name of the consumer that fetched the message and has
    ## still to acknowledge it. We call it the current owner of the
    ## message.
    ##
    ## 3.The number of milliseconds that elapsed since the last time
    ## this message was delivered to this consumer.
    ##
    ## 4.The number of times this message was delivered.
    await redis.send("XPENDING", key, group)
    let resp = await redis.recv
    var pairs: seq[(string, uint32)] = @[]
    if resp.kind == rkArray and resp.array.isSome and len(resp.array.get) == 4:
      let
        array = resp.array.get
        total = if array[0].kind == rkInteger: array[0].val else: 0
        start = if array[1].kind == rkBulkString and array[1].bulkstr.isSome: array[1].bulkstr.get else: ""
        stop = if array[2].kind == rkBulkString and array[2].bulkstr.isSome: array[2].bulkstr.get else: ""
        consumers = if array[3].kind == rkArray and array[3].array.isSome: array[3].array.get else: @[]
      for c in consumers:
        if c.kind == rkArray and c.array.isSome and len(c.array.get) == 2:
          let
            pair = c.array.get
            consumer = if pair[0].kind == rkBulkString and pair[0].bulkstr.isSome: pair[0].bulkstr.get else: ""
            num = if pair[1].kind == rkBulkString and pair[1].bulkstr.isSome: pair[1].bulkstr.get.parseInt else: 0
          pairs.add((consumer, cast[uint32](num)))
      result = (cast[uint32](total), start, stop, pairs)
    else:
      result = (0'u32, "", "", pairs)

  proc xpending*(redis: Redis | AsyncRedis, key: string, group: string, start: string, stop: string, count: uint32, consumer: string = ""): Future[seq[(string, string, uint32, uint32)]] {.multisync.} =
    ## Fetching data from a stream via a consumer group, and not
    ## acknowledging such data, has the effect of creating pending
    ## entries.
    ##
    ## or each message four attributes are returned:
    ## 1. The ID of the message.
    ##
    ## 2. The name of the consumer that fetched the message and has
    ## still to acknowledge it. We call it the current owner of the
    ## message.
    ##
    ## 3.The number of milliseconds that elapsed since the last time
    ## this message was delivered to this consumer.
    ##
    ## 4.The number of times this message was delivered.
    var args = @[key, group, $start, $stop, $count]
    if consumer != "":
      args.add(consumer)
    await redis.send("XPENDING", args)
    let resp = await redis.recv
    result = @[]
    if resp.kind == rkArray and resp.array.isSome:
      for item in resp.array.get:
        if item.kind == rkArray and item.array.isSome and len(item.array.get) == 4:
          let
            array = item.array.get
            id = if array[0].kind == rkBulkString and array[0].bulkstr.isSome: array[0].bulkstr.get else: ""
            consumername = if array[1].kind == rkBulkString and array[1].bulkstr.isSome: array[1].bulkstr.get else: ""
            elapsed = if array[2].kind == rkInteger: cast[uint32](array[2].val) else: 0
            delivered = if array[3].kind == rkInteger: cast[uint32](array[3].val) else: 0
          result.add((id, consumername, elapsed, delivered))
#+end_src
*** xrange
#+begin_src nim :noweb-ref xrange
  proc xrange*(redis: Redis | AsyncRedis, key: string, start: string = "-", stop: string = "+", count: uint32 = 0): Future[seq[(string, TableRef[string, string])]] {.multisync.} =
    ## The command returns the stream entries matching a given range of
    ## IDs. The command returns the entries with IDs matching the
    ## specified range.
    var args = @[key, start, stop]
    if count != 0:
      args.add("COUNT")
      args.add($count)
    await redis.send("XRANGE", args)
    let resp = await redis.recv
    result = resp.toSequenceTupleTable
#+end_src
*** xread
#+begin_src nim :noweb-ref xread
  proc xread*(redis: Redis | AsyncRedis, keyids: seq[(string, string)], count: uint32 = 0, timeout: uint32 = 0): Future[seq[(string, seq[(string, TableRef[string, string])])]] {.multisync.} =
    ## Read data from one or multiple streams, only returning entries
    ## with an ID greater than the last received ID reported by the
    ## caller. This command has an option to block if items are not
    ## available.
    ##
    ## The command returns an array of results: each element of the
    ## returned array is an array composed of a two element containing
    ## the key name and the entries reported for that key. The entries
    ## reported are full stream entries, having IDs and the list of all
    ## the fields and values.
    var args: seq[string] = @[]
    if count != 0:
      args.add("COUNT")
      args.add($count)
    if timeout != 0:
      args.add("BLOCK")
      args.add($timeout)
    args.add("STREAMS")
    var
      keys: seq[string] = @[]
      ids: seq[string] = @[]
    for keyids in keyids:
      keys.add(keyids[0])
      ids.add(keyids[1])
    await redis.send("XREAD", concat(args, keys, ids))
    let resp = await redis.recv
    <<get-xread-result>>
#+end_src
*** xreadgroup
#+begin_src nim :noweb-ref xreadgroup
  proc xreadgroup*(redis: Redis | AsyncRedis, group: string, consumer: string, keyids: seq[(string, string)], count: uint32 = 0, timeout: uint32 = 0, noack: bool = false): Future[seq[(string, seq[(string, TableRef[string, string])])]] {.multisync.} =
    ## The XREADGROUP command is a special version of the XREAD command
    ## with support for consumer groups.
    ##
    ## The command returns an array of results: each element of the
    ## returned array is an array composed of a two element containing
    ## the key name and the entries reported for that key. The entries
    ## reported are full stream entries, having IDs and the list of all
    ## the fields and values.
    var args = @["GROUP", group, consumer]
    if count != 0:
      args.add("COUNT")
      args.add($count)
    if timeout != 0:
      args.add("BLOCK")
      args.add($timeout)
    if noack:
      args.add("NOACK")
    args.add("STREAMS")
    var
      keys: seq[string] = @[]
      ids: seq[string] = @[]
    for keyid in keyids:
      keys.add(keyid[0])
      ids.add(keyid[1])
    await redis.send("XREADGROUP", concat(args, keys, ids))
    let resp = await redis.recv
    <<get-xread-result>>
#+end_src
*** xrevrange
#+begin_src nim :noweb-ref xrevrange
  proc xrevrange*(redis: Redis | AsyncRedis, key: string, stop: string = "+", start: string = "-", count: uint32 = 0): Future[seq[(string, TableRef[string, string])]] {.multisync.} =
    ## This command is exactly like XRANGE, but with the notable
    ## difference of returning the entries in reverse order, and also
    ## taking the start-end range in reverse order
    var args = @[key, stop, start]
    if count != 0:
      args.add("COUNT")
      args.add($count)
    await redis.send("XREVRANGE", args)
    let resp = await redis.recv
    result = resp.toSequenceTupleTable
#+end_src
*** xtrim
#+begin_src nim :noweb-ref xtrim
  proc xtrim*(redis: Redis | AsyncRedis, key: string, count: uint32): Future[uint32] {.multisync.} =
    ## XTRIM trims the stream to a given number of items, evicting older
    ## items (items with lower IDs) if needed.
    await redis.send("XTRIM", key, "MAXLEN", "~", $count)
    let resp = await redis.recv
    result = cast[uint32](resp.toInt)
#+end_src
** sorted set
*** 框架
#+begin_src nim :noweb-ref sorted-set
  <<zadd>>

  <<zcard>>

  <<zinterstore>>

  <<zrange>>

  <<zrange-withscores>>

  <<zrangebyscore>>

  <<zrangebyscore-withscores>>

  <<zrem>>

  <<zrevrange>>

  <<zrevrange-withscores>>

  <<zrevrangebyscore>>

  <<zrevrangebyscore-withscores>>

  <<zscore>>

  <<zunionstore>>
#+end_src
*** zadd
#+begin_src nim :noweb-ref zadd
  proc zadd*(redis: Redis | AsyncRedis, key: string, pairs: seq[(int, string)]): Future[uint32] {.multisync.} =
    ## Adds all the specified members with the specified scores to the
    ## sorted set stored at key.
    ##
    ## The command returns the number of elements added to the sorted
    ## sets, not including elements already existing for which the score
    ## was updated.
    var args = @[key]
    for pair in pairs:
      args.add($pair[0])
      args.add(pair[1])
    await redis.send("ZADD", args)
    let resp = await redis.recv
    result = cast[uint32](resp.toInt)
#+end_src
*** zcard
#+begin_src nim :noweb-ref zcard
  proc zcard*(redis: Redis | AsyncRedis, key: string): Future[uint32] {.multisync.} =
    ## Returns the sorted set cardinality (number of elements) of the
    ## sorted set stored at key.
    ##
    ## The command returns the cardinality (number of elements) of the
    ## sorted set, or 0 if key does not exist.
    await redis.send("ZCARD", key)
    let resp = await redis.recv
    result = cast[uint32](resp.toInt)
#+end_src
*** zinterstore
#+begin_src nim :noweb-ref zinterstore
  proc zinterstore*(redis: Redis | AsyncRedis, dest: string, keys: seq[string]): Future[uint32] {.multisync.} =
    ## Computes the intersection of keys sorted sets given by the
    ## specified keys, and stores the result in destination.
    ##
    ## The command returns the number of elements in the resulting
    ## sorted set at destination.
    await redis.send("ZINTERSTORE", concat(@[dest, $len(keys)], keys))
    let resp = await redis.recv
    result = cast[uint32](resp.toInt)

  proc zinterstore*(redis: Redis | AsyncRedis, dest: string, keys_with_weight: seq[(int, string)], aggregate: string = "SUM"): Future[uint32] {.multisync.} =
    ## Computes the intersection of keys sorted sets given by the
    ## specified keys, and stores the result in destination.
    ##
    ## The command returns the number of elements in the resulting
    ## sorted set at destination.
    var
      keys: seq[string] = @[]
      weights: seq[string] = @[]
    for (weight, key) in keys_with_weight:
      keys.add(key)
      weights.add($weight)
    await redis.send("ZINTERSTORE", concat(@[dest, $len(keys)], keys, @["WEIGHTS"], weights, @["AGGREGATE", aggregate]))
    let resp = await redis.recv
    result = cast[uint32](resp.toInt)
#+end_src
*** zrange
#+begin_src nim :noweb-ref zrange
  proc zrange*(redis: Redis | AsyncRedis, key: string, start: int, stop: int): Future[seq[string]] {.multisync.} =
    ## Returns the specified range of elements in the sorted set stored
    ## at key. The elements are considered to be ordered from the lowest
    ## to the highest score.
    ##
    ## The command returns list of elements in the specified range.
    await redis.send("ZRANGE", key, $start, $stop)
    let resp = await redis.recv
    result = resp.toStringArray
#+end_src
*** zrange_withscores
#+begin_src nim :noweb-ref zrange-withscores
  proc zrange_withscores*(redis: Redis | AsyncRedis, key: string, start: int, stop: int): Future[seq[(string, int)]] {.multisync.} =
    ## Returns the specified range of elements in the sorted set stored
    ## at key. The elements are considered to be ordered from the lowest
    ## to the highest score.
    ##
    ## The command returns list of elements with their scores in the
    ## specified range.
    await redis.send("ZRANGE", key, $start, $stop, "WITHSCORES")
    let resp = await redis.recv
    <<get-sorted-set-result>>
#+end_src
*** zrangebyscore
#+begin_src nim :noweb-ref zrangebyscore
  proc zrangebyscore*(redis: Redis | AsyncRedis, key: string, start: int, stop: int, start_exclusive: bool = false, stop_exclusive: bool = false, offset: int = 0, count: int = 0): Future[seq[string]] {.multisync.} =
    ## Returns all the elements in the sorted set at key with a score
    ## between min and max (including elements with score equal to min
    ## or max). The elements are considered to be ordered from low to
    ## high scores.
    ##
    ## The command returns list of elements in the specified range.
    var args = @[key]
    if start_exclusive:
      args.add("(" & $start)
    else:
      args.add($start)
    if stop_exclusive:
      args.add("(" & $stop)
    else:
      args.add($stop)
    if count != 0:
      args.add("LIMIT")
      args.add($offset)
      args.add($count)
    await redis.send("ZRANGEBYSCORE", args)
    let resp = await redis.recv
    result = resp.toStringArray
#+end_src
*** zrangebyscore_withscores
#+begin_src nim :noweb-ref zrangebyscore-withscores
  proc zrangebyscore_withscores*(redis: Redis | AsyncRedis, key: string, start: int, stop: int, start_exclusive: bool = false, stop_exclusive: bool = false, offset: int = 0, count: int = 0): Future[seq[(string, int)]] {.multisync.} =
    ## Returns all the elements in the sorted set at key with a score
    ## between min and max (including elements with score equal to min
    ## or max). The elements are considered to be ordered from low to
    ## high scores.
    ##
    ## The command returns list of elements with their scores in the
    ## specified range.
    var args = @[key]
    if start_exclusive:
      args.add("(" & $start)
    else:
      args.add($start)
    if stop_exclusive:
      args.add("(" & $stop)
    else:
      args.add($stop)
    args.add("WITHSCORES")
    if count != 0:
      args.add("LIMIT")
      args.add($offset)
      args.add($count)
    await redis.send("ZRANGEBYSCORE", args)
    let resp = await redis.recv
    <<get-sorted-set-result>>
#+end_src
*** zrem
#+begin_src nim :noweb-ref zrem
  proc zrem*(redis: Redis | AsyncRedis, key: string, members: seq[string]): Future[uint32] {.multisync.} =
    ## Removes the specified members from the sorted set stored at
    ## key. Non existing members are ignored.
    ##
    ## The command returns the number of members removed from the sorted
    ## set, not including non existing members.
    await redis.send("ZREM", concat(@[key], members))
    let resp = await redis.recv
    result = cast[uint32](resp.toInt)
#+end_src
*** zrevrange
#+begin_src nim :noweb-ref zrevrange
  proc zrevrange*(redis: Redis | AsyncRedis, key: string, start: int, stop: int): Future[seq[string]] {.multisync.} =
    ## Returns the specified range of elements in the sorted set stored
    ## at key. The elements are considered to be ordered from the
    ## highest to the lowest score.
    ##
    ## The command returns list of elements in the specified range.
    await redis.send("ZREVRANGE", key, $start, $stop)
    let resp = await redis.recv
    result = resp.toStringArray
#+end_src
*** zrevrange_withscores
#+begin_src nim :noweb-ref zrevrange-withscores
  proc zrevrange_withscores*(redis: Redis | AsyncRedis, key: string, start: int, stop: int): Future[seq[(string, int)]] {.multisync.} =
    ## Returns the specified range of elements in the sorted set stored
    ## at key. The elements are considered to be ordered from the
    ## highest to the lowest score.
    ##
    ## The command returns list of elements with their scores in the
    ## specified range.
    await redis.send("ZREVRANGE", key, $start, $stop, "WITHSCORES")
    let resp = await redis.recv
    <<get-sorted-set-result>>
#+end_src
*** zrevrangebyscore
#+begin_src nim :noweb-ref zrevrangebyscore
  proc zrevrangebyscore*(redis: Redis | AsyncRedis, key: string, start: int, stop: int, start_exclusive: bool = false, stop_exclusive: bool = false, offset: int = 0, count: int = 0): Future[seq[string]] {.multisync.} =
    ## Returns all the elements in the sorted set at key with a score
    ## between max and min (including elements with score equal to max
    ## or min). In contrary to the default ordering of sorted sets, for
    ## this command the elements are considered to be ordered from high
    ## to low scores.
    ##
    ## The elements having the same score are returned in reverse
    ## lexicographical order.
    ##
    ## The command returns list of elements in the specified range.
    var args = @[key]
    if start_exclusive:
      args.add("(" & $start)
    else:
      args.add($start)
    if stop_exclusive:
      args.add("(" & $stop)
    else:
      args.add($stop)
    if count != 0:
      args.add("LIMIT")
      args.add($offset)
      args.add($count)
    await redis.send("ZREVRANGEBYSCORE", args)
    let resp = await redis.recv
    result = resp.toStringArray
#+end_src
*** zrevrangebyscore_withscores
#+begin_src nim :noweb-ref zrevrangebyscore-withscores
  proc zrevrangebyscore_withscores*(redis: Redis | AsyncRedis, key: string, start: int, stop: int, start_exclusive: bool = false, stop_exclusive: bool = false, offset: int = 0, count: int = 0): Future[seq[(string, int)]] {.multisync.} =
    ## Returns all the elements in the sorted set at key with a score
    ## between max and min (including elements with score equal to max
    ## or min). In contrary to the default ordering of sorted sets, for
    ## this command the elements are considered to be ordered from high
    ## to low scores.
    ##
    ## The elements having the same score are returned in reverse
    ## lexicographical order.
    ##
    ## The command returns list of elements with their scores in the
    ## specified range.
    var args = @[key]
    if start_exclusive:
      args.add("(" & $start)
    else:
      args.add($start)
    if stop_exclusive:
      args.add("(" & $stop)
    else:
      args.add($stop)
    args.add("WITHSCORES")
    if count != 0:
      args.add("LIMIT")
      args.add($offset)
      args.add($count)
    await redis.send("ZREVRANGEBYSCORE", args)
    let resp = await redis.recv
    <<get-sorted-set-result>>
#+end_src
*** zscore
#+begin_src nim :noweb-ref zscore
  proc zscore*(redis: Redis | AsyncRedis, key: string, member: string): Future[Option[float]] {.multisync.} =
    ## Returns the score of member in the sorted set at key.
    await redis.send("ZSCORE", key, member)
    let resp = await redis.recv
    let value = resp.toString
    if value.isSome:
      result = some(parseFloat(value.get))
    else:
      result = none(float)
#+end_src
*** zunionstore
#+begin_src nim :noweb-ref zunionstore
  proc zunionstore*(redis: Redis | AsyncRedis, dest: string, keys: seq[string]): Future[uint32] {.multisync.} =
    ## Computes the union of keys sorted sets given by the specified
    ## keys, and stores the result in destination.
    ##
    ## The command returns the number of elements in the resulting
    ## sorted set at destination.
    await redis.send("ZUNIONSTORE", concat(@[dest, $len(keys)], keys))
    let resp = await redis.recv
    result = cast[uint32](resp.toInt)

  proc zunionstore*(redis: Redis | AsyncRedis, dest: string, keys_with_weight: seq[(int, string)], aggregate: string = "SUM"): Future[uint32] {.multisync.} =
    ## Computes the union of keys sorted sets given by the specified
    ## keys, and stores the result in destination.
    ##
    ## The command returns the number of elements in the resulting
    ## sorted set at destination.
    var
      keys: seq[string] = @[]
      weights: seq[string] = @[]
    for (weight, key) in keys_with_weight:
      keys.add(key)
      weights.add($weight)
    await redis.send("ZUNIONSTORE", concat(@[dest, $len(keys)], keys, @["WEIGHTS"], weights, @["AGGREGATE", aggregate]))
    let resp = await redis.recv
    result = cast[uint32](resp.toInt)
#+end_src
* 辅助方法
** 框架
#+begin_src nim :noweb-ref utilities
  <<serializer>>

  <<repr>>

  <<to-string>>

  <<generic-constructor>>

  <<converter>>
#+end_src
** serializer
#+begin_src nim :noweb-ref serializer
  proc encode_string(str: string): string =
    return "+" & str & "\r\n"

  proc encode_error(err: string): string =
    return "-" & err & "\r\n"

  proc encode_integer(val: int): string =
    return ":" & $val & "\r\n"

  proc encode_bulk_string(str: Option[string]): string =
    if str.isSome:
      let
        val = str.get
        len = len(val)
      return "$" & $len & "\r\n" & val & "\r\n"
    else:
      return "$-1\r\n"

  proc encode*(val: RedisValue): string
  proc encode_array(arr: Option[seq[RedisValue]]): string =
    if arr.isSome:
      let
        val = arr.get
        len = len(val)
      result = "*" & $len & "\r\n"
      for e in val:
        result &= encode(e)
    else:
      return "*-1\r\n"

  proc encode*(val: RedisValue): string =
    case val.kind:
      of rkString:
        return encode_string(val.str)
      of rkError:
        return encode_error(val.err)
      of rkInteger:
        return encode_integer(val.val)
      of rkBulkString:
        return encode_bulk_string(val.bulkstr)
      of rkArray:
        return encode_array(val.array)
#+end_src
** repr
#+begin_src nim :noweb-ref repr
  proc repr*(val: RedisValue): string =
    case val.kind:
      of rkString:
        return "\"$1\"" % val.str
      of rkError:
        return "\"$1\"" % val.err
      of rkInteger:
        return $ val.val
      of rkBulkString:
        if val.bulkstr.isNone:
          return "nil"
        else:
          return "\"$1\"" % val.bulkstr.get
      of rkArray:
        if val.array.isNone:
          return "nil"
        else:
          let
            items = val.array.get
            strs = items.mapIt(repr(it))
          return "[$1]" % strs.join(", ")
#+end_src
** to string
#+begin_src nim :noweb-ref to-string
  proc `$`*(val: RedisValue): string =
    case val.kind:
      of rkString:
        return $ val.str
      of rkError:
        return $ val.err
      of rkInteger:
        return $ val.val
      of rkBulkString:
        if val.bulkstr.isNone:
          return "nil"
        else:
          return $val.bulkstr.get
      of rkArray:
        if val.array.isNone:
          return "nil"
        else:
          let
            items = val.array.get
            strs = items.mapIt($it)
          return "[$1]" % strs.join(", ")
#+end_src
** generic constructor
#+begin_src nim :noweb-ref generic-constructor
  proc `%`*(str: string): RedisValue =
    if str.find("\r\n") == -1:
      result = RedisValue(kind: rkString, str: str)
    else:
      result = RedisValue(kind: rkBulkString, bulkstr: some(str))

  proc `%`*(num: int): RedisValue =
    result = RedisValue(kind: rkInteger, val: num)

  proc `%`*(arr: seq[int]): RedisValue =
    result = RedisValue(kind: rkArray, array: some(arr.mapIt(%it)))

  proc `%`*(arr: seq[string]): RedisValue =
    result = RedisValue(kind: rkArray, array: some(arr.mapIt(%it)))
#+end_src
** converter
#+begin_src nim :noweb-ref converter
  proc toInt(v: RedisValue): int =
    if v.kind == rkInteger:
      result = v.val
    else:
      result = 0

  proc toString(v: RedisValue): Option[string] =
    if v.kind == rkString:
      result = some(v.str)
    elif v.kind == rkError:
      result = some(v.err)
    elif v.kind == rkBulkString:
      result = v.bulkstr
    else:
      result = none(string)

  proc toStringArray(v: RedisValue): seq[string] =
    if v.kind == rkArray:
      if v.array.isNone:
        return @[]
      for item in v.array.get:
        if item.kind == rkString:
          result.add(item.str)
        elif item.kind == rkError:
          result.add(item.err)
        elif item.kind == rkBulkString:
          if item.bulkstr.isSome:
            result.add(item.bulkstr.get)
          else:
            result.add("")
        elif item.kind == rkInteger:
          result.add($item.val)
    else:
      result = @[]

  proc toOptionalStringArray(v: RedisValue): seq[Option[string]] =
    if v.kind == rkArray:
      if v.array.isNone:
        return @[]
      for item in v.array.get:
        if item.kind == rkString:
          result.add(some(item.str))
        elif item.kind == rkError:
          result.add(some(item.err))
        elif item.kind == rkBulkString:
          result.add(item.bulkstr)
        elif item.kind == rkInteger:
          result.add(some($item.val))
    else:
      result = @[]

  proc toTable(v: RedisValue): TableRef[string, string] =
    result = newTable[string, string]()
    if v.kind == rkArray:
      if v.array.isSome:
        let array = v.array.get
        for i in 0..int(len(array)/2 - 1):
          let field = if array[i shl 1].kind == rkBulkString and array[i shl 1].bulkstr.isSome: array[i shl 1].bulkstr.get else: ""
          let value = if array[(i shl 1) + 1].kind == rkBulkString and array[(i shl 1) + 1].bulkstr.isSome: array[(i shl 1) + 1].bulkstr.get else: ""
          result[field] = value

  proc toSequenceTupleTable(v: RedisValue): seq[(string, TableRef[string, string])] =
    result = @[]
    if v.kind == rkArray and v.array.isSome:
      for elements in v.array.get:
        if elements.kind == rkArray and elements.array.isSome and len(elements.array.get) == 2:
          let array = elements.array.get
          let id = if array[0].kind == rkBulkString and array[0].bulkstr.isSome: array[0].bulkstr.get else: ""
          result.add((id, toTable(array[1])))

  proc toArray(v: RedisValue): seq[RedisValue] =
    if v.kind == rkArray:
      if v.array.isNone:
        return @[]
      else:
        result = v.array.get
    else:
      result = @[]
#+end_src
** 获取 xread 结果
#+begin_src nim :noweb-ref get-xread-result
  result = @[]
  if resp.kind == rkArray:
    if resp.array.isSome:
      let array = resp.array.get
      for item in array:
        if item.kind == rkArray and item.array.isSome:
          let elements = item.array.get
          let stream = if elements[0].kind == rkBulkString and elements[0].bulkstr.isSome: elements[0].bulkstr.get else: ""
          if elements[1].kind == rkArray:
            result.add((stream, elements[1].toSequenceTupleTable))
#+end_src
** 获取 sorted-set 结果
#+begin_src nim :noweb-ref get-sorted-set-result
  result = @[]
  if resp.kind == rkArray:
    if resp.array.isSome:
      let array = resp.array.get
      for i in 0..int(len(array) / 2 - 1):
        let
          element = if array[i shl 1].kind == rkBulkString and array[i shl 1].bulkstr.isSome: array[i shl 1].bulkstr.get else: ""
          score = if array[(i shl 1) + 1].kind == rkBulkString and array[(i shl 1) + 1].bulkstr.isSome: parseInt(array[(i shl 1) + 1].bulkstr.get) else: 0
        result.add((element, score))
#+end_src
