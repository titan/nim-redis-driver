#+TITLE: The Driver For Redis Written by Nim Language
#+AUTHOR: Titan
#+EMAIL: howay.tan@gmail.com
#+DATE: <2019-02-13 Wed>
#+KEYWORDS: nim redis driver
#+OPTIONS: H:4 toc:t
#+STARTUP: indent
#+SUBTITLE:
#+titlepage: true
#+titlepage-color: 06386e
#+titlepage-text-color: FFFFFF
#+titlepage-rule-color: FFFFFF
#+titlepage-rule-height: 1

* 基本框架
#+begin_src nim :tangle ${BUILDDIR}/redis.nim
  import asyncdispatch, asyncnet, deques, net, options, sequtils, strutils
  from redis/lexer_fsm import nil
  from redis/syntax_fsm import nil

  <<type>>

  <<utilities>>

  <<lexer-action>>

  <<syntax-action>>

  <<interface>>

  <<test>>
#+end_src
* 类型定义
#+begin_src nim :noweb-ref type
  type
    <<interface-type>>

    <<data-type>>

    <<lexer-context>>

    <<syntax-context>>
#+end_src
** 接口类型
#+begin_src nim :noweb-ref interface-type
  RedisBase[TSocket] = ref object of RootObj
    socket: TSocket
    connected: bool
    timeout*: int

  Redis* = ref object of RedisBase[net.Socket]
    pipeline*: seq[RedisValue]

  AsyncRedis* = ref object of RedisBase[asyncnet.AsyncSocket]
    pipeline*: seq[RedisValue]
#+end_src
** 数据类型
#+begin_src nim :noweb-ref data-type
  RedisKind* = enum
    rkString, rkError, rkInteger, rkBulkString, rkArray

  RedisValue* = ref object
    case kind*: RedisKind
    of rkString: str*: string
    of rkError: err*: string
    of rkInteger: val*: int
    of rkBulkString: bulkstr*: Option[string]
    of rkArray: array*: Option[seq[RedisValue]]
#+end_src

* 协议解析
** BNF 定义
#+begin_src text
  RedisValue = RedisString
             | RedisError
             | RedisInt
             | RedisBulkString
             | RedisEmptyBulkString
             | RedisNullBulkString
             | RedisArray
             | RedisNullArray

  RedisString = '+' string '\r\n'

  RedisError = '-' string '\r\n'

  RedisInt = ':' number '\r\n'

  RedisBulkString = '$' number '\r\n' string '\r\n'

  RedisEmptyBulkString = '$' '0' '\r\n' '\r\n'

  RedisNullBulkString = '$' '-1' '\r\n'

  RedisArray = '*' number '\r\n' RedisArrayItems

  RedisNullArray = '*' '-1' '\r\n'

  RedisArrayItems = RedisArrayItems RedisString
                  | RedisArrayItems RedisError
                  | RedisArrayItems RedisInt
                  | RedisArrayItems RedisBulkString
                  | RedisArrayItems RedisEmptyBulkString
                  | RedisArrayItems RedisNullBulkString
                  | RedisArrayItems RedisArray
                  | RedisArrayItems RedisNullArray
                  | RedisString
                  | RedisError
                  | RedisInt
                  | RedisBulkString
                  | RedisEmptyBulkString
                  | RedisNullBulkString
                  | RedisArray
                  | RedisNullArray
#+end_src
** 词法解析状态机
*** 定义
#+begin_src text :tangle ${BUILDDIR}/lexer_fsm.txt
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-----------------------+--------------------+--------+
  | state\event           | +                     | -                     | :                     | $                     | *                     | number              | other                 | cr                    | lf                 | eof    |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-----------------------+--------------------+--------+
  |                       | plus                  |                       | colon                 | dollar                | asterisk              | add to number       | add to string         |                       |                    |        |
  |                       | ----                  | ----                  | ----                  | ----                  | ----                  | ----                | ----                  |                       |                    |        |
  | INIT                  | +                     | -                     |                       | $                     |                       | NUMBER              | STRING                |                       |                    |        |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-----------------------+--------------------+--------+
  |                       | minus                 |                       | minus                 | minus                 | minus                 | add minus to number |                       |                       |                    |        |
  |                       | plus                  | minus                 | colon                 | dollar                | asterisk              | add to number       | add to string         | minus                 |                    |        |
  |                       | ----                  | ----                  | ----                  | ----                  | ----                  | ----                | ----                  | ----                  |                    |        |
  | -                     | INIT                  |                       | INIT                  | INIT                  | INIT                  | NUMBER              | - STRING              | CR                    |                    |        |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-----------------------+--------------------+--------+
  |                       | move number to string | move number to string | move number to string | move number to string | move number to string |                     | move number to string |                       |                    |        |
  |                       | add to string         | add to string         | add to string         | add to string         | add to string         | add to number       | add to string         | number                |                    | number |
  |                       | ----                  | ----                  | ----                  | ----                  | ----                  | ----                | ----                  | ----                  |                    | ----   |
  | NUMBER                | STRING                | STRING                | STRING                | STRING                | STRING                |                     | STRING                | CR                    |                    | INIT   |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-----------------------+--------------------+--------+
  |                       | add to string         | add to string         | add to string         | add to string         | add to string         | add to string       | add to string         | string                |                    | string |
  |                       | ----                  | ----                  | ----                  | ----                  | ----                  | ----                | ----                  | ----                  |                    | ----   |
  | STRING                |                       |                       |                       |                       |                       |                     |                       | CR                    |                    | INIT   |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-----------------------+--------------------+--------+
  |                       |                       |                       |                       |                       |                       |                     |                       |                       | crlf               | crlf   |
  |                       |                       |                       |                       |                       |                       |                     |                       |                       | ----               | ----   |
  | CR                    |                       |                       |                       |                       |                       |                     |                       |                       | INIT               | INIT   |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-----------------------+--------------------+--------+
  |                       |                       |                       |                       |                       |                       | add to string       | add to string         |                       |                    |        |
  |                       |                       |                       |                       |                       |                       | ----                | ----                  |                       |                    |        |
  | +                     |                       |                       |                       |                       |                       | + STRING            | + STRING              |                       |                    |        |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-----------------------+--------------------+--------+
  |                       | add to string         | add to string         | add to string         | add to string         | add to string         | add to string       | add to string         | string                |                    |        |
  |                       | ----                  | ----                  | ----                  | ----                  | ----                  | ----                | ----                  | ----                  |                    |        |
  | + STRING              |                       |                       |                       |                       |                       |                     |                       | + STRING CR           |                    |        |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-----------------------+--------------------+--------+
  |                       |                       |                       |                       |                       |                       |                     |                       |                       | crlf               | crlf   |
  |                       |                       |                       |                       |                       |                       |                     |                       |                       | ----               | ----   |
  | + STRING CR           |                       |                       |                       |                       |                       |                     |                       |                       | INIT               | INIT   |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-----------------------+--------------------+--------+
  |                       | add to string         | add to string         | add to string         | add to string         | add to string         | add to string       | add to string         | string                |                    |        |
  |                       | ----                  | ----                  | ----                  | ----                  | ----                  | ----                | ----                  | ----                  |                    |        |
  | - STRING              |                       |                       |                       |                       |                       |                     |                       | - STRING CR           |                    |        |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-----------------------+--------------------+--------+
  |                       |                       |                       |                       |                       |                       |                     |                       |                       | crlf               | crlf   |
  |                       |                       |                       |                       |                       |                       |                     |                       |                       | ----               | ----   |
  | - STRING CR           |                       |                       |                       |                       |                       |                     |                       |                       | INIT               | INIT   |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-----------------------+--------------------+--------+
  |                       |                       |                       |                       |                       |                       | add to number       |                       |                       |                    |        |
  |                       |                       |                       |                       |                       |                       | ----                |                       |                       |                    |        |
  | $                     |                       |                       |                       |                       |                       | $ NUMBER            |                       |                       |                    |        |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-----------------------+--------------------+--------+
  |                       |                       |                       |                       |                       |                       | add to number       |                       | number                |                    |        |
  |                       |                       |                       |                       |                       |                       | ----                |                       | ----                  |                    |        |
  | $ NUMBER              |                       |                       |                       |                       |                       |                     |                       | $ NUMBER CR           |                    |        |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-----------------------+--------------------+--------+
  |                       |                       |                       |                       |                       |                       |                     |                       |                       | crlf               |        |
  |                       |                       |                       |                       |                       |                       |                     |                       |                       | ----               |        |
  | $ NUMBER CR           |                       |                       |                       |                       |                       |                     |                       |                       | $ NUMBER CR STRING |        |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-----------------------+--------------------+--------+
  |                       | add to string         | add to string         | add to string         | add to string         | add to string         | add to string       | add to string         | string                |                    |        |
  |                       | ----                  | ----                  | ----                  | ----                  | ----                  | ----                | ----                  | ----                  |                    |        |
  | $ NUMBER CR STRING    |                       |                       |                       |                       |                       |                     |                       | $ NUMBER CR STRING CR |                    |        |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-----------------------+--------------------+--------+
  |                       |                       |                       |                       |                       |                       |                     |                       |                       | crlf               | crlf   |
  |                       |                       |                       |                       |                       |                       |                     |                       |                       | ----               | ----   |
  | $ NUMBER CR STRING CR |                       |                       |                       |                       |                       |                     |                       |                       | INIT               | INIT   |
  +-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+-----------------------+---------------------+-----------------------+-----------------------+--------------------+--------+
#+end_src
*** 数据定义
#+begin_src nim :noweb-ref lexer-context
  LexerContext = ref object
    input: char
    num: string
    str: string
    sfsm: syntax_fsm.StateMachine[SyntaxContext]
    sctx: SyntaxContext
#+end_src
*** 执行动作
#+begin_src nim :noweb-ref lexer-action
  proc feed_event[T](ctx: var T, val: SyntaxValue) =
    case val.kind:
      of skRedisValue:
        case val.val.kind:
          of rkString:
            ctx.sctx.input = val
            ctx.sctx = syntax_fsm.redisstring(ctx.sfsm, ctx.sctx)
          of rkError:
            ctx.sctx.input = val
            ctx.sctx = syntax_fsm.rediserror(ctx.sfsm, ctx.sctx)
          of rkInteger:
            ctx.sctx.input = val
            ctx.sctx = syntax_fsm.redisint(ctx.sfsm, ctx.sctx)
          of rkBulkString:
            ctx.sctx.input = val
            if val.val.bulkstr.isNone():
              ctx.sctx = syntax_fsm.redisnullbulkstring(ctx.sfsm, ctx.sctx)
            else:
              let str = val.val.bulkstr.get()
              if len(str) == 0:
                ctx.sctx = syntax_fsm.redisemptybulkstring(ctx.sfsm, ctx.sctx)
              else:
                ctx.sctx = syntax_fsm.redisbulkstring(ctx.sfsm, ctx.sctx)
          of rkArray:
            ctx.sctx.input = val
            if val.val.array.isNone():
              ctx.sctx = syntax_fsm.redisnullarray(ctx.sfsm, ctx.sctx)
            else:
              ctx.sctx = syntax_fsm.redisarray(ctx.sfsm, ctx.sctx)
      of skRedisArrayItems:
        if len(ctx.sctx.arrlen) > 0:
          if len(val.items) == ctx.sctx.arrlen[len(ctx.sctx.arrlen) - 1]:
            ctx.sctx.input = val
            ctx.sctx = syntax_fsm.redisarrayitems_where_len_equals_number(ctx.sfsm, ctx.sctx)
          else:
            ctx.sctx.input = val
            ctx.sctx = syntax_fsm.redisarrayitems_but_len_less_than_number(ctx.sfsm, ctx.sctx)
      else:
        discard

  proc consume_queue[T](ctx: var T) =
    while len(ctx.sctx.queue) > 0:
      var item = ctx.sctx.queue.popFirst()
      feed_event(ctx, item)

  proc plus[T](ctx: T): T =
    var ctx0 = ctx
    consume_queue(ctx0)
    ctx0.sctx.input = SyntaxValue(kind: skString, str: "+")
    ctx0.sctx = syntax_fsm.plus(ctx0.sfsm, ctx0.sctx)
    consume_queue(ctx0)
    result = ctx0

  proc colon[T](ctx: T): T =
    var ctx0 = ctx
    consume_queue(ctx0)
    ctx0.sctx.input = SyntaxValue(kind: skString, str: ":")
    ctx0.sctx = syntax_fsm.colon(ctx0.sfsm, ctx0.sctx)
    consume_queue(ctx0)
    result = ctx0

  proc dollar[T](ctx: T): T =
    var ctx0 = ctx
    consume_queue(ctx0)
    ctx0.sctx.input = SyntaxValue(kind: skString, str: "$")
    ctx0.sctx = syntax_fsm.dollar(ctx0.sfsm, ctx0.sctx)
    consume_queue(ctx0)
    result = ctx0

  proc asterisk[T](ctx: T): T =
    var ctx0 = ctx
    consume_queue(ctx0)
    ctx0.sctx.input = SyntaxValue(kind: skString, str: "*")
    ctx0.sctx = syntax_fsm.asterisk(ctx0.sfsm, ctx0.sctx)
    consume_queue(ctx0)
    result = ctx0

  proc add_to_number[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.num.add(ctx.input)
    result = ctx0

  proc add_to_string[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.str.add(ctx.input)
    result = ctx0

  proc minus[T](ctx: T): T =
    var ctx0 = ctx
    consume_queue(ctx0)
    ctx0.sctx.input = SyntaxValue(kind: skString, str: "-")
    ctx0.sctx = syntax_fsm.minus(ctx0.sfsm, ctx0.sctx)
    consume_queue(ctx0)
    result = ctx0

  proc add_minus_to_number[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.num.add('-')
    result = ctx0

  proc move_number_to_string[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.str = ctx0.num
    ctx0.num = ""
    result = ctx0

  proc number[T](ctx: T): T =
    let num = parseInt($ctx.num)
    var ctx0 = ctx
    if num == 0:
      consume_queue(ctx0)
      ctx0.sctx.input = SyntaxValue(kind: skNumber, num: num)
      ctx0.sctx = syntax_fsm.number_0(ctx0.sfsm, ctx0.sctx)
      ctx0.num = ""
      consume_queue(ctx0)
      result = ctx0
    elif num == -1:
      consume_queue(ctx0)
      ctx0.sctx.input = SyntaxValue(kind: skNumber, num: num)
      ctx0.sctx = syntax_fsm.minus_1(ctx0.sfsm, ctx0.sctx)
      ctx0.num = ""
      consume_queue(ctx0)
      result = ctx0
    else:
      consume_queue(ctx0)
      ctx0.sctx.input = SyntaxValue(kind: skNumber, num: num)
      ctx0.sctx = syntax_fsm.number(ctx0.sfsm, ctx0.sctx)
      ctx0.num = ""
      consume_queue(ctx0)
      result = ctx0

  proc string[T](ctx: T): T =
    var ctx0 = ctx
    consume_queue(ctx0)
    ctx0.sctx.input = SyntaxValue(kind: skString, str: $ctx.str)
    ctx0.sctx = syntax_fsm.string(ctx0.sfsm, ctx0.sctx)
    ctx0.str = ""
    consume_queue(ctx0)
    result = ctx0

  proc crlf[T](ctx: T): T =
    var ctx0 = ctx
    consume_queue(ctx0)
    ctx0.sctx.input = SyntaxValue(kind: skString, str: "\r\n")
    ctx0.sctx = syntax_fsm.crlf(ctx0.sfsm, ctx0.sctx)
    consume_queue(ctx0)
    result = ctx0
#+end_src
** 语法解析状态机
*** 定义
#+begin_src text :tangle ${BUILDDIR}/syntax_fsm.txt
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  | state\event                                               | RedisString                   | RedisError                    | RedisInt                      | RedisBulkString               | RedisEmptyBulkString          | RedisNullBulkString           | RedisArray                    | RedisNullArray                | RedisArrayItems but len < number                          | RedisArrayItems where len = number | string                                         | +                              | -                             | :                           | $                                              | *                                             | number                                         | 0                                              | -1                                             | crlf                                                      |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  | RedisValue -> . RedisString                               |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisValue -> . RedisError                                |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisValue -> . RedisInt                                  |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisValue -> . RedisBulkString                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisValue -> . RedisEmptyString                          |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisValue -> . RedisNullString                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisValue -> . RedisArray                                |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisValue -> . RedisNullArray                            |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisString -> . + string crlf                            |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisError -> . - string crlf                             |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisInt -> . : number crlf                               |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             | clear done                                     |                                               |                                                |                                                |                                                |                                                           |
  | RedisBulkString -> . $ number crlf string crlf            | shift                         | shift                         | shift                         | shift                         | shift                         | shift                         | shift                         | shift                         |                                                           |                                    |                                                |                                |                               |                             | shift                                          | clear done                                    |                                                |                                                |                                                |                                                           |
  | RedisEmptyBulkString -> . $ 0 crlf crlf                   | reduce to redis value         | reduce to redis value         | reduce to redis value         | reduce to redis value         | reduce to redis value         | reduce to redis value         | reduce to redis value         | reduce to redis value         | error                                                     | error                              | error                                          | clear done                     | clear done                    | clear done                  | ----                                           | shift                                         | error                                          | error                                          | error                                          | error                                                     |
  | RedisNullBulkString -> . $ -1 crlf                        | set done                      | set done                      | set done                      | set done                      | set done                      | set done                      | set done                      | set done                      | quit                                                      | quit                               | quit                                           | shift                          | shift                         | shift                       | RedisBulkString -> $ . number crlf string crlf | ----                                          | quit                                           | quit                                           | quit                                           | quit                                                      |
  | RedisArray -> . * number crlf RedisArrayItems             | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | RedisEmptyBulkString -> $ . 0 crlf crlf        | RedisArray -> * . number crlf RedisArrayItems | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisNullArray -> . * -1 crlf                             |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                | RedisString -> + . string crlf | RedisError -> - . string crlf | RedisInt -> : . number crlf | RedisNullBulkString -> $ . -1 crlf             | RedisNullArray -> * . -1 crlf                 |                                                |                                                |                                                |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              |                                                | error                          | error                         | error                       | error                                          | error                                         | convert to string                              | convert to string                              | convert to string                              | error                                                     |
  |                                                           | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | shift                                          | quit                           | quit                          | quit                        | quit                                           | quit                                          | shift                                          | shift                                          | shift                                          | quit                                                      |
  |                                                           | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisString -> + . string crlf                            |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    | RedisString -> + string . crlf                 |                                |                               |                             |                                                |                                               | RedisString -> + string . crlf                 | RedisString -> + string . crlf                 | RedisString -> + string . crlf                 |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              | error                                          | error                          | error                         | error                       | error                                          | error                                         | error                                          | error                                          | error                                          | shift                                                     |
  |                                                           | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | quit                                           | quit                           | quit                          | quit                        | quit                                           | quit                                          | quit                                           | quit                                           | quit                                           | reduce 3 to redis string                                  |
  |                                                           | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisString -> + string . crlf                            |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              |                                                | error                          | error                         | error                       | error                                          | error                                         | convert to string                              | convert to string                              | convert to string                              | error                                                     |
  |                                                           | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | shift                                          | quit                           | quit                          | quit                        | quit                                           | quit                                          | shift                                          | shift                                          | shift                                          | quit                                                      |
  |                                                           | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisError -> - . string crlf                             |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    | RedisError -> - string . crlf                  |                                |                               |                             |                                                |                                               | RedisError -> - string . crlf                  | RedisError -> - string . crlf                  | RedisError -> - string . crlf                  |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              | error                                          | error                          | error                         | error                       | error                                          | error                                         | error                                          | error                                          | error                                          | shift                                                     |
  |                                                           | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | quit                                           | quit                           | quit                          | quit                        | quit                                           | quit                                          | quit                                           | quit                                           | quit                                           | reduce 3 to redis error                                   |
  |                                                           | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisError -> - string . crlf                             |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              | error                                          | error                          | error                         | error                       | error                                          | error                                         |                                                |                                                |                                                | error                                                     |
  |                                                           | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | quit                                           | quit                           | quit                          | quit                        | quit                                           | quit                                          | shift                                          | shift                                          | shift                                          | quit                                                      |
  |                                                           | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisInt -> : . number crlf                               |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               | RedisInt -> : number . crlf                    | RedisInt -> : number . crlf                    | RedisInt -> : number . crlf                    |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              | error                                          | error                          | error                         | error                       | error                                          | error                                         | error                                          | error                                          | error                                          | shift                                                     |
  |                                                           | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | quit                                           | quit                           | quit                          | quit                        | quit                                           | quit                                          | quit                                           | quit                                           | quit                                           | reduce 3 to redis int                                     |
  |                                                           | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisInt -> : number . crlf                               |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              | error                                          | error                          | error                         | error                       | error                                          | error                                         |                                                |                                                |                                                | error                                                     |
  | RedisBulkString -> $ . number crlf string crlf            | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | quit                                           | quit                           | quit                          | quit                        | quit                                           | quit                                          | shift                                          | shift                                          | shift                                          | quit                                                      |
  | RedisEmptyBulkString -> $ . 0 crlf crlf                   | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisNullBulkString -> $ . -1 crlf                        |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               | RedisBulkString -> $ number . crlf string crlf | RedisEmptyBulkString -> $ 0 . crlf crlf        | RedisNullBulkString -> $ -1 . crlf             |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              | error                                          | error                          | error                         | error                       | error                                          | error                                         | error                                          | error                                          | error                                          |                                                           |
  |                                                           | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | quit                                           | quit                           | quit                          | quit                        | quit                                           | quit                                          | quit                                           | quit                                           | quit                                           | shift                                                     |
  |                                                           | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisBulkString -> $ number . crlf string crlf            |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisBulkString -> $ number crlf . string crlf            |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              |                                                | error                          | error                         | error                       | error                                          | error                                         | convert to string                              | convert to string                              | convert to string                              | error                                                     |
  |                                                           | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | shift                                          | quit                           | quit                          | quit                        | quit                                           | quit                                          | shift                                          | shift                                          | shift                                          | quit                                                      |
  |                                                           | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisBulkString -> $ number crlf . string crlf            |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    | RedisBulkString -> $ number crlf string . crlf |                                |                               |                             |                                                |                                               | RedisBulkString -> $ number crlf string . crlf | RedisBulkString -> $ number crlf string . crlf | RedisBulkString -> $ number crlf string . crlf |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              | error                                          | error                          | error                         | error                       | error                                          | error                                         | error                                          | error                                          | error                                          | shift                                                     |
  |                                                           | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | quit                                           | quit                           | quit                          | quit                        | quit                                           | quit                                          | quit                                           | quit                                           | quit                                           | reduce 5 to redis bulk string                             |
  |                                                           | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisBulkString -> $ number crlf string . crlf            |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              | error                                          | error                          | error                         | error                       | error                                          | error                                         | error                                          | error                                          | error                                          |                                                           |
  |                                                           | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | quit                                           | quit                           | quit                          | quit                        | quit                                           | quit                                          | quit                                           | quit                                           | quit                                           | shift                                                     |
  |                                                           | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisEmptyBulkString -> $ 0 . crlf crlf                   |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisEmptyBulkString -> $ 0 crlf . crlf                   |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              | error                                          | error                          | error                         | error                       | error                                          | error                                         | error                                          | error                                          | error                                          | shift                                                     |
  |                                                           | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | quit                                           | quit                           | quit                          | quit                        | quit                                           | quit                                          | quit                                           | quit                                           | quit                                           | reduce 4 to redis empty bulk string                       |
  |                                                           | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisEmptyBulkString -> $ 0 crlf . crlf                   |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              | error                                          | error                          | error                         | error                       | error                                          | error                                         | error                                          | error                                          | error                                          | shift                                                     |
  |                                                           | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | quit                                           | quit                           | quit                          | quit                        | quit                                           | quit                                          | quit                                           | quit                                           | quit                                           | reduce 3 to redis null bulk string                        |
  |                                                           | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisNullBulkString -> $ -1 . crlf                        |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              | error                                          | error                          | error                         | error                       | error                                          | error                                         | push array length                              | push array length                              |                                                | error                                                     |
  |                                                           | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | quit                                           | quit                           | quit                          | quit                        | quit                                           | quit                                          | shift                                          | shift                                          | shift                                          | quit                                                      |
  | RedisArray -> * . number crlf RedisArrayItems             | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisNullArray -> * . -1 crlf                             |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               | RedisArray -> * number . crlf RedisArrayItems  | RedisArray -> * number . crlf RedisArrayItems  | RedisNullArray -> * -1 . crlf                  |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | shift                                                     |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | ----                                                      |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArray -> * number crlf . RedisArrayItems             |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> . RedisArrayItems RedisString          |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> . RedisArrayItems RedisError           |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> . RedisArrayItems RedisInt             |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> . RedisArrayItems RedisBulkString      |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> . RedisArrayItems RedisEmptyBulkString |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> . RedisArrayItems RedisNullBulkString  |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> . RedisArrayItems RedisArray           |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> . RedisArrayItems RedisNullArray       |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> . RedisString                          |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> . RedisError                           |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> . RedisInt                             |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> . RedisBulkString                      |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> . RedisEmptyBulkString                 |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> . RedisNullBulkString                  |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> . RedisArray                           |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> . RedisNullArray                       |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisString -> . + string crlf                            |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisError -> . - string crlf                             |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisInt -> . : number crlf                               |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisBulkString -> . $ number crlf string crlf            |
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              | error                                          | error                          | error                         | error                       | error                                          | error                                         | error                                          | error                                          | error                                          | RedisEmptyBulkString -> . $ 0 crlf crlf                   |
  |                                                           | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | quit                                           | quit                           | quit                          | quit                        | quit                                           | quit                                          | quit                                           | quit                                           | quit                                           | RedisNullBulkString -> . $ -1 crlf                        |
  |                                                           | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | RedisArray -> . * number crlf RedisArrayItems             |
  | RedisArray -> * number . crlf RedisArrayItems             |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisNullArray -> . * -1 crlf                             |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  | RedisArray -> * number crlf . RedisArrayItems             |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> . RedisArrayItems RedisString          |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> . RedisArrayItems RedisError           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> . RedisArrayItems RedisInt             |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> . RedisArrayItems RedisBulkString      |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> . RedisArrayItems RedisEmptyBulkString |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> . RedisArrayItems RedisNullBulkString  |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> . RedisArrayItems RedisArray           |                               |                               |                               |                               |                               |                               |                               |                               | shift                                                     |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> . RedisArrayItems RedisNullArray       |                               |                               |                               |                               |                               |                               |                               |                               | ----                                                      |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> . RedisString                          |                               |                               |                               |                               |                               |                               |                               |                               | RedisArrayItems -> RedisArrayItems . RedisString          |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> . RedisError                           |                               |                               |                               |                               |                               |                               |                               |                               | RedisArrayItems -> RedisArrayItems . RedisError           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> . RedisInt                             |                               |                               |                               |                               |                               |                               |                               |                               | RedisArrayItems -> RedisArrayItems . RedisInt             |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> . RedisBulkString                      |                               |                               |                               |                               |                               |                               |                               |                               | RedisArrayItems -> RedisArrayItems . RedisBulkString      |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> . RedisEmptyBulkString                 |                               |                               |                               |                               |                               |                               |                               |                               | RedisArrayItems -> RedisArrayItems . RedisEmptyBulkString |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> . RedisNullBulkString                  |                               |                               |                               |                               |                               |                               |                               |                               | RedisArrayItems -> RedisArrayItems . RedisNullBulkString  |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> . RedisArray                           |                               |                               |                               |                               |                               |                               |                               |                               | RedisArrayItems -> RedisArrayItems . RedisArray           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> . RedisNullArray                       |                               |                               |                               |                               |                               |                               |                               |                               | RedisArrayItems -> RedisArrayItems . RedisNullArray       |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisString -> . + string crlf                            |                               |                               |                               |                               |                               |                               |                               |                               | RedisString -> . + string crlf                            |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisError -> . - string crlf                             |                               |                               |                               |                               |                               |                               |                               |                               | RedisError -> . - string crlf                             |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisInt -> . : number crlf                               |                               |                               |                               |                               |                               |                               |                               |                               | RedisInt -> . : number crlf                               |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisBulkString -> . $ number crlf string crlf            |                               |                               |                               |                               |                               |                               |                               |                               | RedisBulkString -> . $ number crlf string crlf            | shift                              |                                                |                                |                               |                             | shift                                          |                                               |                                                |                                                |                                                |                                                           |
  | RedisEmptyBulkString -> . $ 0 crlf crlf                   | shift                         | shift                         | shift                         | shift                         | shift                         | shift                         | shift                         | shift                         | RedisEmptyBulkString -> . $ 0 crlf crlf                   | reduce 4 to RedisArray             | error                                          |                                |                               |                             | ----                                           | shift                                         | error                                          | error                                          | error                                          | error                                                     |
  | RedisNullBulkString -> . $ -1 crlf                        | reduce 1 to redis array items | reduce 1 to redis array items | reduce 1 to redis array items | reduce 1 to redis array items | reduce 1 to redis array items | reduce 1 to redis array items | reduce 1 to redis array items | reduce 1 to redis array items | RedisNullBulkString -> . $ -1 crlf                        | pop array length                   | quit                                           | shift                          | shift                         | shift                       | RedisBulkString -> $ . number crlf string crlf | ----                                          | quit                                           | quit                                           | quit                                           | quit                                                      |
  | RedisArray -> . * number crlf RedisArrayItems             | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | RedisArray -> . * number crlf RedisArrayItems             | ----                               | ----                                           | ----                           | ----                          | ----                        | RedisEmptyBulkString -> $ . 0 crlf crlf        | RedisArray -> * . number crlf RedisArrayItems | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisNullArray -> . * -1 crlf                             |                               |                               |                               |                               |                               |                               |                               |                               | RedisNullArray -> . * -1 crlf                             |                                    |                                                | RedisString -> + . string crlf | RedisError -> - . string crlf | RedisInt -> : . number crlf | RedisNullBulkString -> $ . -1 crlf             | RedisNullArray -> * . -1 crlf                 |                                                |                                                |                                                |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  | RedisArrayItems -> RedisArrayItems . RedisString          |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> RedisArrayItems . RedisError           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> RedisArrayItems . RedisInt             |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> RedisArrayItems . RedisBulkString      |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> RedisArrayItems . RedisEmptyBulkString |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> RedisArrayItems . RedisNullBulkString  |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> RedisArrayItems . RedisArray           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> RedisArrayItems . RedisNullArray       |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisString -> . + string crlf                            |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisError -> . - string crlf                             |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisInt -> . : number crlf                               |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisBulkString -> . $ number crlf string crlf            |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             | shift                                          |                                               |                                                |                                                |                                                |                                                           |
  | RedisEmptyBulkString -> . $ 0 crlf crlf                   | shift                         | shift                         | shift                         | shift                         | shift                         | shift                         | shift                         | shift                         | error                                                     | error                              | error                                          |                                |                               |                             | ----                                           | shift                                         | error                                          | error                                          | error                                          | error                                                     |
  | RedisNullBulkString -> . $ -1 crlf                        | reduce 2 to redis array items | reduce 2 to redis array items | reduce 2 to redis array items | reduce 2 to redis array items | reduce 2 to redis array items | reduce 2 to redis array items | reduce 2 to redis array items | reduce 2 to redis array items | quit                                                      | quit                               | quit                                           | shift                          | shift                         | shift                       | RedisBulkString -> $ . number crlf string crlf | ----                                          | quit                                           | quit                                           | quit                                           | quit                                                      |
  | RedisArray -> . * number crlf RedisArrayItems             | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | RedisEmptyBulkString -> $ . 0 crlf crlf        | RedisArray -> * . number crlf RedisArrayItems | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisNullArray -> . * -1 crlf                             |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                | RedisString -> + . string crlf | RedisError -> - . string crlf | RedisInt -> : . number crlf | RedisNullBulkString -> $ . -1 crlf             | RedisNullArray -> * . -1 crlf                 |                                                |                                                |                                                |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              | error                                          | error                          | error                         | error                       | error                                          | error                                         | error                                          | error                                          | error                                          | shift                                                     |
  |                                                           | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | quit                                           | quit                           | quit                          | quit                        | quit                                           | quit                                          | quit                                           | quit                                           | quit                                           | reduce 3 to redis null array                              |
  |                                                           | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisNullArray -> * -1 . crlf                             |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
#+end_src
*** 数据定义
#+begin_src nim :noweb-ref syntax-context
  SyntaxKind = enum
    skString, skNumber, skRedisValue, skRedisArrayItems, skEof

  SyntaxValue = ref object
    case kind: SyntaxKind
    of skString: str: string
    of skNumber: num: int
    of skRedisValue: val: RedisValue
    of skRedisArrayItems: items: seq[RedisValue]
    of skEof: eof: int

  SyntaxContext = ref object
    fsm: syntax_fsm.StateMachine[SyntaxContext]
    value: SyntaxValue
    input: SyntaxValue
    state_stack: seq[int]
    stack: seq[SyntaxValue]
    queue: Deque[SyntaxValue]
    error: bool
    errmsg: string
    arrlen: seq[int]
    done: bool
#+end_src
*** 执行动作
#+begin_src nim :noweb-ref syntax-action
  proc shift[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.state_stack.add(ctx0.fsm.state)
    ctx0.stack.add(ctx0.input)
    return ctx0

  proc set_done[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.done = true
    return ctx0

  proc error[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.error = true
    ctx0.errmsg = "Syntax Error"
    return ctx0

  proc quit[T](ctx: T): T =
    return ctx

  proc clear_done[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.done = false
    return ctx0

  proc convert_to_string[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.input = SyntaxValue(kind: skString, str: $ctx0.input.num)
    return ctx0

  proc reduce_to_redis_value[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.value = ctx0.stack.pop()
    ctx0.fsm.state = ctx0.state_stack.pop()
    return ctx0

  proc reduce_3_to_redis_string[T](ctx: T): T =
    var ctx0 = ctx
    discard ctx0.stack.pop()
    var sv = ctx0.stack.pop()
    discard ctx0.stack.pop()
    discard ctx0.state_stack.pop()
    discard ctx0.state_stack.pop()
    ctx0.fsm.state = ctx0.state_stack.pop()
    ctx0.queue.addLast(SyntaxValue(kind: skRedisValue, val: RedisValue(kind: rkString, str: sv.str)))
    return ctx0

  proc reduce_3_to_redis_error[T](ctx: T): T =
    var ctx0 = ctx
    discard ctx0.stack.pop()
    var sv = ctx0.stack.pop()
    discard ctx0.stack.pop()
    discard ctx0.state_stack.pop()
    discard ctx0.state_stack.pop()
    ctx0.fsm.state = ctx0.state_stack.pop()
    ctx0.queue.addLast(SyntaxValue(kind: skRedisValue, val: RedisValue(kind: rkError, err: sv.str)))
    return ctx0

  proc reduce_3_to_redis_int[T](ctx: T): T =
    var ctx0 = ctx
    discard ctx0.stack.pop()
    var sv = ctx0.stack.pop()
    discard ctx0.stack.pop()
    discard ctx0.state_stack.pop()
    discard ctx0.state_stack.pop()
    ctx0.fsm.state = ctx0.state_stack.pop()
    ctx0.queue.addLast(SyntaxValue(kind: skRedisValue, val: RedisValue(kind: rkInteger, val: sv.num)))
    return ctx0

  proc reduce_5_to_redis_bulk_string[T](ctx: T): T =
    var ctx0 = ctx
    discard ctx0.stack.pop()
    var sv1 = ctx0.stack.pop()
    discard ctx0.stack.pop()
    var sv2 = ctx0.stack.pop()
    discard ctx0.stack.pop()
    discard ctx0.state_stack.pop()
    discard ctx0.state_stack.pop()
    discard ctx0.state_stack.pop()
    discard ctx0.state_stack.pop()
    ctx0.fsm.state = ctx0.state_stack.pop()
    ctx0.queue.addLast(SyntaxValue(kind: skRedisValue, val: RedisValue(kind: rkBulkString, bulkstr: some(sv1.str))))
    return ctx0

  proc reduce_4_to_redis_empty_bulk_string[T](ctx: T): T =
    var ctx0 = ctx
    discard ctx0.stack.pop()
    discard ctx0.stack.pop()
    discard ctx0.stack.pop()
    discard ctx0.stack.pop()
    discard ctx0.state_stack.pop()
    discard ctx0.state_stack.pop()
    discard ctx0.state_stack.pop()
    ctx0.fsm.state = ctx0.state_stack.pop()
    ctx0.queue.addLast(SyntaxValue(kind: skRedisValue, val: RedisValue(kind: rkBulkString, bulkstr: some(""))))
    return ctx0

  proc reduce_3_to_redis_null_bulk_string[T](ctx: T): T =
    var ctx0 = ctx
    discard ctx0.stack.pop()
    discard ctx0.stack.pop()
    discard ctx0.stack.pop()
    discard ctx0.state_stack.pop()
    discard ctx0.state_stack.pop()
    var n = none(system.string)
    ctx0.fsm.state = ctx0.state_stack.pop()
    ctx0.queue.addLast(SyntaxValue(kind: skRedisValue, val: RedisValue(kind: rkBulkString, bulkstr: n)))
    return ctx0

  proc push_array_length[T](ctx: T): T =
    var ctx0 = ctx
    ctx0.arrlen.add(ctx0.input.num)
    return ctx0

  proc reduce_1_to_redis_array_items[T](ctx: T): T =
    var ctx0 = ctx
    var item = ctx0.stack.pop()
    ctx0.fsm.state = ctx0.state_stack.pop()
    var array = @[item.val]
    ctx0.queue.addLast(SyntaxValue(kind: skRedisArrayItems, items: array))
    return ctx0

  proc reduce_4_to_redisarray[T](ctx: T): T =
    var ctx0 = ctx
    var arrayitems = ctx0.stack.pop()
    discard ctx0.stack.pop()
    discard ctx0.stack.pop()
    discard ctx0.stack.pop()
    discard ctx0.state_stack.pop()
    discard ctx0.state_stack.pop()
    discard ctx0.state_stack.pop()
    ctx0.fsm.state = ctx0.state_stack.pop()
    ctx0.queue.addLast(SyntaxValue(kind: skRedisValue, val: RedisVAlue(kind: rkArray, array: some(arrayitems.items))))
    return ctx0

  proc pop_array_length[T](ctx: T): T =
    var ctx0 = ctx
    discard ctx0.arrlen.pop()
    return ctx0

  proc reduce_2_to_redis_array_items[T](ctx: T): T =
    var ctx0 = ctx
    var item = ctx0.stack.pop()
    var array = ctx0.stack.pop()
    discard ctx0.state_stack.pop()
    ctx0.fsm.state = ctx0.state_stack.pop()
    array.items.add(item.val)
    ctx0.queue.addLast(array)
    return ctx0

  proc reduce_3_to_redis_null_array[T](ctx: T): T =
    var ctx0 = ctx
    discard ctx0.stack.pop()
    discard ctx0.stack.pop()
    discard ctx0.stack.pop()
    discard ctx0.state_stack.pop()
    discard ctx0.state_stack.pop()
    ctx0.fsm.state = ctx0.state_stack.pop()
    ctx0.queue.addLast(SyntaxValue(kind: skRedisValue, val: RedisValue(kind: rkArray, array: none(seq[RedisValue]))))
    return ctx0
#+end_src
* 接口定义
** 框架
#+begin_src nim :noweb-ref interface
  <<open>>
  <<open_async>>
  <<exec>>
#+end_src
** open
#+begin_src nim :noweb-ref open
  proc open*(host = "localhost", port = 6379.Port, timeout=0): Redis =
    ## Open a connection to a redis server.
    result = Redis(socket: newSocket(buffered = false))
    result.pipeline = @[]
    result.timeout = timeout
    result.socket.connect(host, port)
    result.connected = true
#+end_src
** open_async
#+begin_src nim :noweb-ref open_async
  proc open_async*(host = "localhost", port = 6379.Port): Future[AsyncRedis] {.async.} =
    ## Open an asynchronous connection to a redis server.
    result = AsyncRedis(socket: newAsyncSocket(buffered = false))
    result.pipeline = @[]
    await result.socket.connect(host, port)
    result.connected = true
#+end_src
** exec
#+begin_src nim :noweb-ref exec
  proc exec*(this: Redis|AsyncRedis, command: string, args: seq[string]): Future[RedisValue] {.multisync.} =
    ## execute command `command` with arguments seq `args`

    <<convert-args>>

    await this.socket.send(encode(cmd))

    <<init-fsm>>

    when this is Redis:
      var timeout = -1
      if this.timeout != 0:
        timeout = this.timeout
      while lctx.sctx.done == false:
        var response = this.socket.recv(1024, timeout = timeout)
        <<execute-fsm>>
      lctx = lexer_fsm.eof[LexerContext](lfsm, lctx)
      return lctx.sctx.value.val
    else:
      while lctx.sctx.done == false:
        var response = await this.socket.recv(1024)
        <<execute-fsm>>
      lctx = lexer_fsm.eof[LexerContext](lfsm, lctx)
      return lctx.sctx.value.val
#+end_src
*** 转化参数为 Redis 格式
#+begin_src nim :noweb-ref convert-args
  var parameters = newSeq[RedisValue](len(args) + 1)
  parameters[0] = RedisValue(kind: rkBulkString, bulkstr: some(command))
  for idx in 1..len(args):
    parameters[idx] = RedisValue(kind: rkBulkString, bulkstr: some(args[idx - 1]))
  let cmd = RedisValue(kind: rkArray, array: some(parameters))
#+end_src
*** 初始化状态机
#+begin_src nim :noweb-ref init-fsm
  let sdgt = syntax_fsm.StateMachineDelegate[SyntaxContext](
    shift: shift[SyntaxContext],
    set_done: set_done[SyntaxContext],
    error: error[SyntaxContext],
    quit: quit[SyntaxContext],
    clear_done: clear_done[SyntaxContext],
    convert_to_string: convert_to_string[SyntaxContext],
    reduce_to_redis_value: reduce_to_redis_value[SyntaxContext],
    reduce_3_to_redis_string: reduce_3_to_redis_string[SyntaxContext],
    reduce_3_to_redis_error: reduce_3_to_redis_error[SyntaxContext],
    reduce_3_to_redis_int: reduce_3_to_redis_int[SyntaxContext],
    reduce_5_to_redis_bulk_string: reduce_5_to_redis_bulk_string[SyntaxContext],
    reduce_4_to_redis_empty_bulk_string: reduce_4_to_redis_empty_bulk_string[SyntaxContext],
    reduce_3_to_redis_null_bulk_string: reduce_3_to_redis_null_bulk_string[SyntaxContext],
    push_array_length: push_array_length[SyntaxContext],
    reduce_1_to_redis_array_items: reduce_1_to_redis_array_items[SyntaxContext],
    reduce_4_to_redisarray: reduce_4_to_redisarray[SyntaxContext],
    pop_array_length: pop_array_length[SyntaxContext],
    reduce_2_to_redis_array_items: reduce_2_to_redis_array_items[SyntaxContext],
    reduce_3_to_redis_null_array: reduce_3_to_redis_null_array[SyntaxContext],
  )
  var sfsm = syntax_fsm.newStateMachine[SyntaxContext](sdgt)
  var sctx: SyntaxContext = new(SyntaxContext)
  sctx.fsm = sfsm
  sctx.state_stack = @[]
  sctx.stack = @[]
  sctx.queue = initDeque[SyntaxValue]()
  sctx.error = false
  sctx.arrlen = @[]
  sctx.done = false

  var lctx: LexerContext = new(LexerContext)
  lctx.num = ""
  lctx.str = ""
  lctx.sfsm = sfsm
  lctx.sctx = sctx
  let ldgt = lexer_fsm.StateMachineDelegate[LexerContext](
    plus: plus[LexerContext],
    colon: colon[LexerContext],
    dollar: dollar[LexerContext],
    asterisk: asterisk[LexerContext],
    add_to_number: add_to_number[LexerContext],
    add_to_string: add_to_string[LexerContext],
    minus: minus[LexerContext],
    add_minus_to_number: add_minus_to_number[LexerContext],
    move_number_to_string: move_number_to_string[LexerContext],
    number: number[LexerContext],
    string: string[LexerContext],
    crlf: crlf[LexerContext],
  )
  var lfsm = lexer_fsm.newStateMachine[LexerContext](ldgt)
#+end_src
*** 执行状态机
#+begin_src nim :noweb-ref execute-fsm
  for ch in response:
    lctx.input = ch
    if ch == '+':
      lctx = lexer_fsm.plus[LexerContext](lfsm, lctx)
    elif ch == '-':
      lctx = lexer_fsm.minus[LexerContext](lfsm, lctx)
    elif ch == ':':
      lctx = lexer_fsm.colon[LexerContext](lfsm, lctx)
    elif ch == '$':
      lctx = lexer_fsm.dollar[LexerContext](lfsm, lctx)
    elif ch == '*':
      lctx = lexer_fsm.asterisk[LexerContext](lfsm, lctx)
    elif ch == '\r':
      lctx = lexer_fsm.cr[LexerContext](lfsm, lctx)
    elif ch == '\n':
      lctx = lexer_fsm.lf[LexerContext](lfsm, lctx)
    elif ch >= '0' and ch <= '9':
      lctx = lexer_fsm.number[LexerContext](lfsm, lctx)
    else:
      lctx = lexer_fsm.other[LexerContext](lfsm, lctx)
#+end_src
* 辅助方法
** 框架
#+begin_src nim :noweb-ref utilities
  <<serializer>>

  <<repr>>

  <<to-string>>

  <<generic-constructor>>
#+end_src
** serializer
#+begin_src nim :noweb-ref serializer
  proc encode_string(str: string): string =
    return "+" & str & "\r\n"

  proc encode_error(err: string): string =
    return "-" & err & "\r\n"

  proc encode_integer(val: int): string =
    return ":" & $val & "\r\n"

  proc encode_bulk_string(str: Option[string]): string =
    if str.isSome:
      let
        val = str.get
        len = len(val)
      return "$" & $len & "\r\n" & val & "\r\n"
    else:
      return "$-1\r\n"

  proc encode*(val: RedisValue): string
  proc encode_array(arr: Option[seq[RedisValue]]): string =
    if arr.isSome:
      let
        val = arr.get
        len = len(val)
      result = "*" & $len & "\r\n"
      for e in val:
        result &= encode(e)
    else:
      return "*-1\r\n"

  proc encode*(val: RedisValue): string =
    case val.kind:
      of rkString:
        return encode_string(val.str)
      of rkError:
        return encode_error(val.err)
      of rkInteger:
        return encode_integer(val.val)
      of rkBulkString:
        return encode_bulk_string(val.bulkstr)
      of rkArray:
        return encode_array(val.array)
#+end_src
** repr
#+begin_src nim :noweb-ref repr
  proc repr*(val: RedisValue): string =
    case val.kind:
      of rkString:
        return "\"$1\"" % val.str
      of rkError:
        return "\"$1\"" % val.err
      of rkInteger:
        return $ val.val
      of rkBulkString:
        if val.bulkstr.isNone():
          return "nil"
        else:
          return "\"$1\"" % val.bulkstr.get()
      of rkArray:
        if val.array.isNone():
          return "nil"
        else:
          let
            items = val.array.get()
            strs = items.mapIt(repr(it))
          return "[$1]" % strs.join(", ")
#+end_src
** to string
#+begin_src nim :noweb-ref to-string
  proc `$`*(val: RedisValue): string =
    case val.kind:
      of rkString:
        return $ val.str
      of rkError:
        return $ val.err
      of rkInteger:
        return $ val.val
      of rkBulkString:
        if val.bulkstr.isNone():
          return "nil"
        else:
          return $val.bulkstr.get()
      of rkArray:
        if val.array.isNone():
          return "nil"
        else:
          let
            items = val.array.get()
            strs = items.mapIt($it)
          return "[$1]" % strs.join(", ")
#+end_src
** generic constructor
#+begin_src nim :noweb-ref generic-constructor
  proc `%`*(str: string): RedisValue =
    if str.find("\r\n") == -1:
      result = RedisValue(kind: rkString, str: str)
    else:
      result = RedisValue(kind: rkBulkString, bulkstr: some(str))

  proc `%`*(num: int): RedisValue =
    result = RedisValue(kind: rkInteger, val: num)

  proc `%`*(arr: seq[int]): RedisValue =
    result = RedisValue(kind: rkArray, array: some(arr.mapIt(%it)))

  proc `%`*(arr: seq[string]): RedisValue =
    result = RedisValue(kind: rkArray, array: some(arr.mapIt(%it)))
#+end_src
* 测试用例
#+begin_src nim :noweb-ref test
  when isMainModule:
    <<init-fsm>>
    var samples = [
      "*3\r\n:1\r\n:2\r\n*2\r\n$5\r\nhello\r\n$5\r\nworld\r\n",
      "*2\r\n*3\r\n:1\r\n:2\r\n:3\r\n\r\n*5\r\n:5\r\n:7\r\n+Hello Word\r\n-Err\r\n$6\r\nfoobar\r\n",
      "*4\r\n:51231\r\n$3\r\nfoo\r\n$-1\r\n$3\r\nbar\r\n",
    ]
    for response in samples:
      <<execute-fsm>>
      lctx = lexer_fsm.eof[LexerContext](lfsm, lctx)
      lctx.sctx = syntax_fsm.dollardollar[SyntaxContext](lctx.sfsm, lctx.sctx)
      if not lctx.sctx.error:
        echo repr(lctx.sctx.value.val)
      else:
        echo lctx.sctx.errmsg
#+end_src
